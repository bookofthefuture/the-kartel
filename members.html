<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Kartel - Members Area</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    <!-- PWA Manifest and Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="background-color" content="#1a252f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="The Kartel">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.svg">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.svg">
    
    <!-- Unified Modules -->
    <link rel="stylesheet" href="unified-styles.css">
    <!-- Bundled JavaScript for members page -->
    <script nomodule src="/dist/polyfills-legacy.min.js"></script>
    <script nomodule src="/dist/js/members-bundle-legacy.min.js"></script>
    <script type="module" src="/dist/js/members-bundle.min.js"></script>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        /* Keep all your existing styles - just adding a few new ones */
        .check-email-message { 
            text-align: center; 
            margin-top: 30px; 
            padding: 25px; 
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); 
            border: 2px solid #4caf50; 
            border-radius: 10px; 
            color: #2e7d32; 
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        }
        .check-email-message h3 { 
            margin: 0 0 15px 0; 
            color: #2e7d32; 
            font-size: 1.4rem;
        }
        .check-email-message p { 
            margin: 0 0 10px 0; 
            font-size: 1rem; 
            line-height: 1.5;
        }
        .check-email-message .sub-text { 
            font-size: 0.9rem; 
            opacity: 0.8; 
            margin-top: 15px;
        }
        .magic-link-form { 
            transition: all 0.3s ease;
        }
        .magic-link-form.hidden { 
            opacity: 0; 
            transform: translateY(-10px);
        }
        
        /* Keep all your existing CSS styles here */
        @font-face { font-family: 'League Spartan'; src: url('assets/League_Spartan/LeagueSpartan-VariableFont_wght.ttf') format('truetype'); font-weight: 100 900; font-style: normal; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'League Spartan', 'Arial', sans-serif; line-height: 1.6; color: #2c3e50; background: #f8f9fa; }
        .header { background: #1a252f; color: white; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-logo { display: flex; align-items: center; gap: 15px; }
        .header-logo img { height: 50px; width: auto; }
        .header-title { font-size: 1.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; color: #ffffff; font-family: 'League Spartan', sans-serif; margin: 0; }
        .user-info { display: flex; align-items: center; gap: 15px; font-family: 'League Spartan', sans-serif; }
        .logout-btn { background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background 0.3s ease; font-family: 'League Spartan', sans-serif; }
        .logout-btn:hover { background: #2980b9; }
        .switch-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background 0.3s ease; font-family: 'League Spartan', sans-serif; margin-right: 10px; }
        .switch-btn:hover { background: #c0392b; }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .dashboard-header { text-align: center; margin-bottom: 40px; }
        .dashboard-title { font-size: 2.5rem; color: #2c3e50; margin-bottom: 10px; font-weight: 800; font-family: 'League Spartan', sans-serif; }
        .dashboard-subtitle { color: #7f8c8d; font-size: 1.1rem; font-family: 'League Spartan', sans-serif; }
        .tab-navigation { display: flex; background: white; border-radius: 10px 10px 0 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 0; }
        .tab-button { flex: 1; padding: 20px; background: #f8f9fa; border: none; cursor: pointer; font-size: 1.1rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; border-bottom: 3px solid transparent; font-family: 'League Spartan', sans-serif; }
        .tab-button.active { background: white; color: #2c3e50; border-bottom-color: #3498db; }
        .tab-button:hover { background: #e9ecef; }
        .tab-button.active:hover { background: white; }
        .tab-content { display: none; background: white; border-radius: 0 0 10px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; }
        .tab-content.active { display: block; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%); }
        .login-card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 100%; margin: 20px; }
        .login-title { font-size: 2rem; color: #2c3e50; margin-bottom: 20px; font-weight: 800; font-family: 'League Spartan', sans-serif; }
        .login-btn { background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.3s ease; width: 100%; font-family: 'League Spartan', sans-serif; }
        .login-btn:hover { background: #2980b9; }
        .login-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; text-align: left; font-family: 'League Spartan', sans-serif; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 4px; font-size: 1rem; transition: border-color 0.3s ease; font-family: 'League Spartan', sans-serif; }
        .form-group input:focus { outline: none; border-color: #3498db; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 20px 0; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 4px; margin: 20px 0; border: 1px solid #c3e6cb; }
        .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 4px; margin: 20px 0; border: 1px solid #b8daff; }
        .hidden { display: none; }
        .events-grid, .venues-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .event-card, .venue-card { background: #fff; border: 1px solid #ecf0f1; border-radius: 10px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .event-card:hover, .venue-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .event-name, .venue-name { font-size: 1.6rem; font-weight: 700; color: #2c3e50; margin-bottom: 10px; font-family: 'League Spartan', sans-serif; }
        .event-detail, .venue-detail { margin-bottom: 8px; color: #5d6d7e; font-family: 'League Spartan', sans-serif; }
        .event-detail strong, .venue-detail strong { color: #2c3e50; font-weight: 600; }
        .event-actions { margin-top: 20px; display: flex; gap: 10px; }
        .btn { background: #3498db; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; display: inline-block; font-weight: 600; transition: background 0.3s ease; border: none; text-decoration: none; font-family: 'League Spartan', sans-serif; }
        .btn-primary { background: #e67e22; }
        .btn-primary:hover { background: #d35400; }
        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .empty-state { text-align: center; padding: 60px 20px; color: #7f8c8d; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 15px; color: #5d6d7e; }
        .empty-state p { font-size: 1.1rem; margin-bottom: 25px; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .status-approved { background: #d4edda; color: #155724; }
        .venue-feature { margin-top: 20px; padding-top: 15px; border-top: 1px solid #ecf0f1; }
        .venue-feature h4 { color: #2c3e50; font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; }
        .driving-tips { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; font-size: 0.95rem; line-height: 1.5; color: #2c3e50; }
        .video-container { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .video-container iframe { border-radius: 8px; }
        
        /* Login method toggle styles */
        .login-method-btn { flex: 1; padding: 10px 15px; border: none; background: transparent; color: #7f8c8d; cursor: pointer; border-radius: 4px; font-weight: 600; transition: all 0.3s ease; font-family: 'League Spartan', sans-serif; }
        .login-method-btn.active { background: #2c3e50; color: white; }
        .login-method-btn:hover:not(.active) { background: rgba(44, 62, 80, 0.1); }
        .password-form { transition: all 0.3s ease; }
        .password-form.hidden { opacity: 0; transform: translateY(-10px); }
        
        /* Photo modal styles */
        .photo-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
        .photo-modal-content { position: relative; margin: auto; display: block; width: 90%; max-width: 800px; max-height: 90%; margin-top: 5%; }
        .photo-modal-image { width: 100%; height: auto; border-radius: 8px; }
        .photo-modal-caption { text-align: center; color: white; padding: 15px; font-size: 1.1rem; }
        .photo-modal-close { position: absolute; top: 15px; right: 25px; color: white; font-size: 35px; font-weight: bold; cursor: pointer; background: rgba(0,0,0,0.5); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .photo-modal-close:hover { background: rgba(255,255,255,0.2); }
        
        /* Event media sections */
        .event-media-section { border-top: 1px solid #ecf0f1; padding-top: 20px; }
        .photos-grid img:hover { transform: scale(1.05); }
        .videos-grid iframe { transition: transform 0.3s ease; }

        /* Event attendee modal styles */
        .event-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .event-modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .event-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #ecf0f1; }
        .event-modal-title { font-size: 1.8rem; font-weight: 700; color: #2c3e50; margin: 0; }
        .event-modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; background: none; border: none; }
        .event-modal-close:hover { color: #e74c3c; }
        .event-details { margin-bottom: 25px; }
        .event-detail-item { margin-bottom: 10px; font-size: 1rem; }
        .event-detail-item strong { color: #2c3e50; }
        .attendees-section h3 { color: #2c3e50; font-size: 1.4rem; margin-bottom: 15px; font-weight: 600; }
        .attendees-list { list-style: none; padding: 0; margin: 0; }
        .attendee-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #e74c3c; display: flex; justify-content: space-between; align-items: center; }
        .attendee-info { flex-grow: 1; }
        .attendee-name { font-weight: 600; color: #2c3e50; font-size: 1.1rem; }
        .attendee-company { color: #7f8c8d; font-size: 0.9rem; margin-top: 2px; }
        .attendee-status { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .status-registered { background: #d4edda; color: #155724; }
        .status-attended { background: #cce7ff; color: #004085; }
        .clickable-event { cursor: pointer; transition: all 0.2s ease; }
        .clickable-event:hover { transform: scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .member-name-clickable { cursor: pointer; transition: all 0.2s ease; border-radius: 4px; padding: 6px 12px; border: 1px solid rgba(255,255,255,0.3); }
        .member-name-clickable:hover { background: rgba(255,255,255,0.1); text-decoration: underline; border-color: rgba(255,255,255,0.6); }

        /* Generic modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #ecf0f1; }
        .modal-title { font-size: 1.6rem; font-weight: 700; color: #2c3e50; margin: 0; }
        .modal-body { line-height: 1.6; }

        @media (max-width: 768px) {
            .header { padding: 12px 0; }
            .header-content { padding: 0 15px; }
            .header-logo img { height: 40px; }
            .header-title { font-size: 1.4rem; letter-spacing: 1px; }
            .tab-navigation { flex-direction: column; }
            .tab-button { padding: 15px; font-size: 1rem; }
            .events-grid, .venues-grid { grid-template-columns: 1fr; }
            .login-card { padding: 30px; }
            .event-modal-content { width: 95%; margin: 10% auto; padding: 20px; }
            .event-modal-title { font-size: 1.5rem; }
            .modal-content { width: 95%; margin: 10% auto; padding: 20px; }
            .modal-title { font-size: 1.4rem; }
            .attendee-item { flex-direction: column; align-items: flex-start; }
            .attendee-status { margin-top: 8px; }
        }
        @media (max-width: 480px) {
            .header-logo { flex-direction: column; gap: 8px; text-align: center; }
            .header-logo img { height: 35px; }
            .header-title { font-size: 1.2rem; letter-spacing: 1px; }
            .header-content { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <!-- Initial loading state to prevent login flash -->
    <div id="loadingSection" class="login-container">
        <div class="login-card">
            <h1 class="login-title">The Kartel Members</h1>
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 2rem; margin-bottom: 20px;">⏳</div>
                <p style="color: #7f8c8d;">Loading...</p>
            </div>
        </div>
    </div>

    <div id="loginSection" class="login-container hidden">
        <div id="loginContainer">
            <!-- Login form will be rendered by auth module -->
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <header class="header">
            <!-- Header content will be rendered by topbar module -->
        </header>

        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Welcome to Your Dashboard</h1>
                <p class="dashboard-subtitle">Manage your events and explore venues.</p>
            </div>

            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('upcomingEvents')">📅 Upcoming Events</button>
                <button class="tab-button" onclick="switchTab('myEvents')">✅ My Events</button>
                <button class="tab-button" onclick="switchTab('venues')">🏁 Venues</button>
            </div>

            <div id="upcomingEventsTab" class="tab-content active">
                <div id="upcomingEventsContainer">
                    <div class="loading">Loading upcoming events...</div>
                </div>
            </div>

            <div id="myEventsTab" class="tab-content">
                <div id="myEventsContainer">
                    <div class="loading">Loading your events...</div>
                </div>
            </div>

            <div id="venuesTab" class="tab-content">
                <div id="venuesContainer">
                    <div class="loading">Loading venues...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Attendees Modal -->
    <div id="eventModal" class="event-modal">
        <div class="event-modal-content">
            <div class="event-modal-header">
                <h2 class="event-modal-title" id="eventModalTitle">Event Details</h2>
                <button class="event-modal-close" onclick="closeEventModal()">&times;</button>
            </div>
            <div class="event-details" id="eventModalDetails">
                <!-- Event details will be populated here -->
            </div>
            <!-- Event Photos Section -->
            <div id="eventPhotosSection" class="event-media-section" style="display: none; margin-bottom: 25px;">
                <h3 style="color: #2c3e50; font-size: 1.4rem; margin-bottom: 15px; font-weight: 600;">📸 Event Photos</h3>
                <div id="eventPhotosGrid" class="photos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
                    <!-- Photos will be populated here -->
                </div>
            </div>

            <!-- Event Videos Section -->
            <div id="eventVideosSection" class="event-media-section" style="display: none; margin-bottom: 25px;">
                <h3 style="color: #2c3e50; font-size: 1.4rem; margin-bottom: 15px; font-weight: 600;">🎥 Event Videos</h3>
                <div id="eventVideosGrid" class="videos-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                    <!-- Videos will be populated here -->
                </div>
            </div>

            <div class="attendees-section">
                <h3>Registered Attendees <span id="attendeeCount" class="status-badge status-approved">0</span></h3>
                <ul class="attendees-list" id="attendeesList">
                    <!-- Attendees will be populated here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Profile Update Modal -->
    <div id="profileModal" class="event-modal">
        <div class="event-modal-content">
            <div class="event-modal-header">
                <h2 class="event-modal-title">Update Profile</h2>
                <button class="event-modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="event-modal-body">
                <form id="profileForm">
                    <div class="form-group">
                        <label for="profileFirstName">First Name *</label>
                        <input type="text" id="profileFirstName" name="profileFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="profileLastName">Last Name *</label>
                        <input type="text" id="profileLastName" name="profileLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email Address</label>
                        <input type="email" id="profileEmail" name="profileEmail" disabled>
                        <small style="color: #7f8c8d;">Email address cannot be changed</small>
                    </div>
                    <div class="form-group">
                        <label for="profileCompany">Company</label>
                        <input type="text" id="profileCompany" name="profileCompany">
                    </div>
                    <div class="form-group">
                        <label for="profilePosition">Position</label>
                        <input type="text" id="profilePosition" name="profilePosition">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone">Mobile Number</label>
                        <input type="tel" id="profilePhone" name="profilePhone">
                    </div>
                    <div class="form-group">
                        <label for="profileLinkedin">LinkedIn Profile</label>
                        <input type="text" id="profileLinkedin" name="profileLinkedin" placeholder="Your LinkedIn username (e.g., john-smith)">
                        <small style="color: #7f8c8d;">Just enter your username - we'll add linkedin.com/in/ automatically</small>
                    </div>
                    
                    <!-- Password Setup Section -->
                    <div class="form-group" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ecf0f1;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">Password Setup</h4>
                        <div class="form-group">
                            <label for="profilePassword">New Password</label>
                            <input type="password" id="profilePassword" name="profilePassword" minlength="8" placeholder="Leave blank to keep current password">
                            <small style="color: #7f8c8d;">Must be at least 8 characters long</small>
                        </div>
                        <div class="form-group">
                            <label for="profileConfirmPassword">Confirm New Password</label>
                            <input type="password" id="profileConfirmPassword" name="profileConfirmPassword" minlength="8" placeholder="Confirm your new password">
                        </div>
                        <small style="color: #7f8c8d;">
                            <span id="passwordStatus">Password not set - use magic link login only</span>
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">Update Profile</button>
                        <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
                    </div>
                </form>
                <div id="profileMessage" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal">
        <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
        <div class="photo-modal-content">
            <img id="photoModalImage" class="photo-modal-image" src="" alt="Event Photo">
            <div id="photoModalCaption" class="photo-modal-caption"></div>
        </div>
    </div>

    <!-- LinkedIn Prompt Modal -->
    <div id="linkedinPromptModal" class="modal" style="z-index: 1001;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">🔗 Connect with Fellow Members</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; line-height: 1.6;">Help other Kartel members connect with you by adding your LinkedIn profile to your account. This makes it easy to continue networking after events!</p>
                
                <div class="form-group">
                    <label for="linkedinPromptInput">Your LinkedIn Username</label>
                    <input type="text" id="linkedinPromptInput" placeholder="e.g., john-smith">
                    <small style="color: #7f8c8d;">Just enter your username - we'll add linkedin.com/in/ automatically</small>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="linkedinDismissCheckbox" style="margin: 0;">
                        <span style="font-size: 0.9rem;">I don't have a LinkedIn profile or don't want to share it</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                    <button type="button" class="btn btn-success" onclick="saveLinkedInFromPrompt()">Add LinkedIn</button>
                    <button type="button" class="btn btn-secondary" onclick="closeLinkedInPrompt()">Skip for Now</button>
                </div>
                
                <p style="text-align: center; margin-top: 15px; font-size: 0.9rem; color: #7f8c8d;">
                    You can always add this later in your profile settings
                </p>
            </div>
            <div id="linkedinPromptMessage" class="hidden"></div>
        </div>
    </div>

    <script>
        let memberToken = localStorage.getItem('kartel_member_token');
        let currentMember = null;
        let allEvents = [];
        let allVenues = [];

        function showMessage(message, type = 'success', containerId = 'loginMessage') {
            console.log(`📢 Showing message: [${type}] ${message}`);
            const container = document.getElementById(containerId);
            
            // Check if container exists before trying to access it
            if (!container) {
                console.warn(`⚠️ Message container '${containerId}' not found, skipping message display`);
                return;
            }
            
            container.classList.remove('hidden', 'success', 'error');
            container.classList.add(type);
            container.textContent = message;
            setTimeout(() => {
                container.classList.add('hidden');
                container.textContent = '';
            }, 5000);
        }

        function showLogin() {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            showLoginForm();
        }

        function showLoginForm() {
            document.getElementById('magicLinkForm').classList.remove('hidden');
            document.getElementById('loginInstruction').classList.remove('hidden');
            document.getElementById('checkEmailMessage').classList.add('hidden');
            document.getElementById('loginMessage').classList.add('hidden');
        }

        function showMagicLinkForm() {
            document.getElementById('magicLinkTab').classList.add('active');
            document.getElementById('passwordTab').classList.remove('active');
            document.getElementById('magicLinkForm').classList.remove('hidden');
            document.getElementById('passwordForm').classList.add('hidden');
            document.getElementById('loginInstruction').textContent = 'Enter your email to receive a secure login link';
            document.getElementById('checkEmailMessage').classList.add('hidden');
            document.getElementById('loginMessage').classList.add('hidden');
        }

        function showPasswordForm() {
            document.getElementById('passwordTab').classList.add('active');
            document.getElementById('magicLinkTab').classList.remove('active');
            document.getElementById('passwordForm').classList.remove('hidden');
            document.getElementById('magicLinkForm').classList.add('hidden');
            document.getElementById('loginInstruction').textContent = 'Sign in with your email and password';
            document.getElementById('checkEmailMessage').classList.add('hidden');
            document.getElementById('loginMessage').classList.add('hidden');
        }

        function showForgotPassword() {
            showMagicLinkForm();
            document.getElementById('loginInstruction').textContent = 'Enter your email to receive a password reset link';
            document.getElementById('memberEmail').value = document.getElementById('passwordEmail').value;
            
            // Update the magic link form to handle password reset
            const magicLinkForm = document.getElementById('magicLinkForm');
            const magicLinkBtn = document.getElementById('magicLinkBtn');
            
            magicLinkBtn.textContent = 'Send Reset Link';
            magicLinkForm.setAttribute('data-reset-mode', 'true');
        }

        function showPasswordResetForm(resetToken) {
            // Clear URL parameters
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Create password reset form
            const loginCard = document.querySelector('.login-card');
            loginCard.innerHTML = `
                <h1 class="login-title">Reset Your Password</h1>
                <p style="margin-bottom: 20px; color: #7f8c8d;">Enter your email and new password</p>
                
                <form id="passwordResetForm" data-reset-token="${resetToken}">
                    <div class="form-group">
                        <label for="resetEmail">Email Address</label>
                        <input type="email" id="resetEmail" name="resetEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="newPassword" required placeholder="Enter new password" minlength="8">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm new password" minlength="8">
                    </div>
                    <button type="submit" id="resetPasswordBtn" class="login-btn">Reset Password</button>
                </form>
                
                <div id="resetMessage" class="hidden"></div>
                
                <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 20px; text-align: center;">
                    <a href="/members.html" style="color: #3498db; text-decoration: underline;">Back to Login</a>
                </p>
            `;
            
            // Add event listener for password reset form
            document.getElementById('passwordResetForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('resetEmail').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const resetBtn = document.getElementById('resetPasswordBtn');
                const resetToken = document.getElementById('passwordResetForm').getAttribute('data-reset-token');
                
                if (newPassword !== confirmPassword) {
                    showResetMessage('Passwords do not match. Please try again.', 'error');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showResetMessage('Password must be at least 8 characters long.', 'error');
                    return;
                }
                
                resetBtn.disabled = true;
                resetBtn.textContent = 'Resetting...';
                
                try {
                    const response = await fetch('/.netlify/functions/reset-member-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email, 
                            resetToken, 
                            newPassword 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        showResetMessage('Password reset successful! You can now log in with your new password.', 'success');
                        
                        // Redirect to login after 3 seconds
                        setTimeout(() => {
                            window.location.href = '/members.html';
                        }, 3000);
                    } else {
                        showResetMessage(result.error || 'Failed to reset password. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('Password reset error:', error);
                    showResetMessage('Network error. Please check your connection and try again.', 'error');
                } finally {
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Reset Password';
                }
            });
        }

        function showResetMessage(message, type = 'info') {
            const messageContainer = document.getElementById('resetMessage');
            messageContainer.className = type;
            messageContainer.textContent = message;
            messageContainer.classList.remove('hidden');
            
            if (type === 'error') {
                setTimeout(() => {
                    messageContainer.classList.add('hidden');
                }, 5000);
            }
        }

        function showDashboard() {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            // Member display name is now handled by unified top bar module
            // Load venues in background for booking reminders
            loadVenuesData();
            
            // Check hash to determine which tab to show
            const hash = window.location.hash;
            if (hash === '#events') {
                switchTab('upcomingEvents');
            } else if (hash === '#my-events') {
                switchTab('myEvents');
            } else if (hash === '#venues') {
                switchTab('venues');
            } else {
                switchTab('upcomingEvents');
            }
            
            // Check for pending registration from email links
            checkPendingRegistration();
            
            // Check if user is also an admin
            checkIfAdmin();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'upcomingEvents') {
                loadEvents('upcoming');
            } else if (tabName === 'myEvents') {
                loadEvents('my');
            } else if (tabName === 'venues') {
                loadVenues();
            }
        }

        async function checkAuth() {
            console.log('🔍 Checking existing authentication...');
            console.log('📊 Auth state:', {
                hasToken: !!memberToken,
                hasStoredEmail: !!localStorage.getItem('kartel_member_email'),
                hasStoredId: !!localStorage.getItem('kartel_member_id')
            });
            
            // Check for corrupted auth state and clean it up
            if (memberToken && !localStorage.getItem('kartel_member_email')) {
                console.log('🧹 Detected corrupted member auth, cleaning up...');
                memberToken = null;
                localStorage.removeItem('kartel_member_token');
                localStorage.removeItem('kartel_member_id');
                localStorage.removeItem('kartel_member_email');
                localStorage.removeItem('kartel_member_firstName');
                localStorage.removeItem('kartel_member_lastName');
                localStorage.removeItem('kartel_member_company');
                localStorage.removeItem('kartel_member_position');
                localStorage.removeItem('kartel_member_phone');
                localStorage.removeItem('kartel_member_linkedin');
                localStorage.removeItem('kartel_member_hasPassword');
            }
            
            if (memberToken && localStorage.getItem('kartel_member_email')) {
                console.log('✅ Found existing auth, loading member data...');
                currentMember = {
                    email: localStorage.getItem('kartel_member_email'),
                    id: localStorage.getItem('kartel_member_id'),
                    firstName: localStorage.getItem('kartel_member_firstName'),
                    lastName: localStorage.getItem('kartel_member_lastName'),
                    company: localStorage.getItem('kartel_member_company'),
                    position: localStorage.getItem('kartel_member_position'),
                    phone: localStorage.getItem('kartel_member_phone'),
                    linkedin: localStorage.getItem('kartel_member_linkedin'),
                    hasPassword: localStorage.getItem('kartel_member_hasPassword') === 'true',
                    isAdmin: localStorage.getItem('kartel_member_isAdmin') === 'true'
                };
                console.log('👤 Current member:', currentMember.email);
                showDashboard();
                
                // Check if LinkedIn prompt should be shown
                if (shouldShowLinkedInPrompt()) {
                    setTimeout(() => showLinkedInPrompt(), 1000);
                }
            } else {
                console.log('🔄 No existing auth found, showing login...');
                showLogin();
            }
        }

        // Old form handlers removed - now handled by unified auth module
        // Unified Authentication Integration for Members
        window.onAuthSuccess = function(user, isAdmin) {
            console.log('🎉 Member auth success:', user, isAdmin);
            
            // Set current member data for compatibility with existing code
            currentMember = user;
            memberToken = kartelAuth.getToken();
            
            // Update topbar with super admin status if applicable
            if (window.kartelTopBar) {
                // Check multiple sources for super admin status
                const authSuperAdmin = kartelAuth.isUserSuperAdmin();
                const userSuperAdmin = user.isSuperAdmin;
                const storedSuperAdmin = localStorage.getItem('kartel_is_super_admin') === 'true';
                
                console.log('🔍 Super admin status check from members:', {
                    authSuperAdmin,
                    userSuperAdmin, 
                    storedSuperAdmin,
                    userEmail: user.email,
                    authObject: kartelAuth
                });
                
                // Set super admin if any source indicates it
                if (authSuperAdmin || userSuperAdmin || storedSuperAdmin) {
                    user.isSuperAdmin = true;
                }
                
                console.log('🔄 Updating topbar from members - final isSuperAdmin:', user.isSuperAdmin);
                window.kartelTopBar.updateUser(user, isAdmin);
            }
            
            // Initialize member dashboard
            showDashboard();
            
            // Handle URL parameters after auth is complete - increased delay for better reliability
            setTimeout(handleUrlParameters, 500);
        };

        // Override existing functions to work with unified auth
        window.logout = function() {
            kartelAuth.logout();
        };
        
        window.switchToAdminView = function() {
            if (kartelAuth.isUserAdmin()) {
                window.location.href = '/admin.html';
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 Members page DOMContentLoaded - unified auth will handle all initialization');
            
            // Let unified auth system handle all initialization including password reset
            // URL parameter handling will be triggered by onAuthSuccess callback
            console.log('🔄 Allowing unified auth system to handle initialization...');
        });

        async function verifyLoginToken(token) {
            console.log('🔐 Starting token verification process...');
            console.log('📝 Token length:', token ? token.length : 'No token');
            
            try {
                console.log('📡 Making API request to verify-login-token...');
                const response = await fetch('/.netlify/functions/verify-login-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                console.log('📊 API Response status:', response.status);
                console.log('📋 API Response headers:', Object.fromEntries(response.headers));
                
                const result = await response.json();
                console.log('📄 API Response data:', {
                    success: result.success,
                    hasToken: !!result.token,
                    memberId: result.memberId,
                    memberEmail: result.memberEmail,
                    error: result.error
                });
                
                if (response.ok && result.success) {
                    console.log('✅ Token verification successful!');
                    memberToken = result.token;
                    const profile = result.memberProfile || {};
                    currentMember = {
                        id: result.memberId,
                        email: result.memberEmail,
                        firstName: profile.firstName || result.memberFullName?.split(' ')[0] || result.memberEmail,
                        lastName: profile.lastName || '',
                        fullName: result.memberFullName,
                        company: profile.company || '',
                        position: profile.position || '',
                        phone: profile.phone || '',
                        linkedin: profile.linkedin || '',
                        hasPassword: profile.hasPassword || false,
                        isAdmin: !!result.isAdmin
                    };
                    console.log('💾 Storing complete member data in localStorage...');
                    localStorage.setItem('kartel_member_token', memberToken);
                    localStorage.setItem('kartel_member_id', currentMember.id);
                    localStorage.setItem('kartel_member_email', currentMember.email);
                    localStorage.setItem('kartel_member_firstName', currentMember.firstName);
                    localStorage.setItem('kartel_member_lastName', currentMember.lastName);
                    localStorage.setItem('kartel_member_company', currentMember.company);
                    localStorage.setItem('kartel_member_position', currentMember.position);
                    localStorage.setItem('kartel_member_phone', currentMember.phone);
                    localStorage.setItem('kartel_member_linkedin', currentMember.linkedin);
                    localStorage.setItem('kartel_member_isAdmin', result.isAdmin ? 'true' : 'false');
                    localStorage.setItem('kartel_member_hasPassword', currentMember.hasPassword ? 'true' : 'false');
                    
                    console.log('🧹 Cleaning URL and showing dashboard...');
                    window.history.replaceState({}, document.title, window.location.pathname);
                    showDashboard();
                    showMessage('Login successful! Welcome to your members area.', 'success');
                    
                    // Check if LinkedIn prompt should be shown
                    if (shouldShowLinkedInPrompt()) {
                        setTimeout(() => showLinkedInPrompt(), 2000);
                    }
                } else {
                    console.log('❌ Token verification failed:', result.error);
                    const errorMessage = result.error || 'Invalid or expired login link.';
                    if (result.error && result.error.includes('expired')) {
                        showMessage(errorMessage + ' Please request a new login link.', 'error');
                    } else {
                        showMessage(errorMessage, 'error');
                    }
                    showLogin();
                }
            } catch (error) {
                console.error('💥 Token verification network error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                showMessage('Network error during login. Please check your connection and try again.', 'error');
                showLogin();
            }
        }

        // Logout button now handled by unified auth module

        // Keep all your existing event and venue loading functions here
        async function loadEvents(type) {
            console.log(`📅 Loading ${type} events...`);
            console.log('🔑 Using token:', memberToken ? 'Token available' : 'No token');
            
            const container = type === 'upcoming' ? document.getElementById('upcomingEventsContainer') : document.getElementById('myEventsContainer');
            
            if (!container) {
                console.error(`❌ Container not found for ${type} events`);
                return;
            }
            
            container.innerHTML = '<div class="loading">Loading events...</div>';

            try {
                console.log('📡 Making API request to get-events-member...');
                // Add cache busting parameter to ensure fresh data
                const cacheBuster = `?t=${Date.now()}`;
                const response = await fetch(`/.netlify/functions/get-events-member${cacheBuster}`, {
                    headers: { 
                        'Authorization': `Bearer ${memberToken}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                console.log('📊 API Response:', response.status, response.statusText);
                
                if (response.status === 401) {
                    console.error('❌ Unauthorized - token may be invalid');
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return;
                }
                if (!response.ok) {
                    console.error('❌ API Error:', response.status, response.statusText);
                    throw new Error(`Failed to load events: ${response.status}`);
                }

                const data = await response.json();
                console.log('📄 Events data received:', data);
                allEvents = data.events || [];
                console.log(`✅ Found ${allEvents.length} events`);
                renderEvents(type, container);

            } catch (error) {
                console.error('Error loading events:', error);
                container.innerHTML = `<div class="error">Failed to load events. ${error.message}</div>`;
            }
        }

        function renderEvents(type, container) {
            let eventsToDisplay = [];
            if (type === 'upcoming') {
                // Show ALL upcoming events, regardless of signup status
                eventsToDisplay = allEvents.filter(event => 
                    new Date(event.date) >= new Date()
                );
            } else if (type === 'my') {
                eventsToDisplay = allEvents.filter(event => 
                    event.attendees && event.attendees.some(a => a.id === currentMember.id || a.memberId === currentMember.id)
                );
            }

            if (eventsToDisplay.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No ${type === 'upcoming' ? 'upcoming' : 'registered'} events found</h3>
                        <p>${type === 'upcoming' ? 'Check back later for new opportunities or view your past events.' : 'You have not signed up for any events yet. Head to "Upcoming Events" to find some!'}</p>
                    </div>
                `;
                return;
            }

            const eventsHTML = eventsToDisplay.map(event => {
                const currentAttendeesCount = event.attendees ? event.attendees.length : 0;
                const isSignedUp = event.attendees && event.attendees.some(a => a.id === currentMember.id || a.memberId === currentMember.id);
                const eventDate = new Date(event.date);
                const today = new Date();
                const isPastEvent = eventDate < today;
                const attendeeText = (type === 'my' && isPastEvent) ? "Click to see who came." : "Click to see who's coming";
                
                return `
                    <div class="event-card clickable-event" onclick="showEventDetails('${event.id}')">
                        <div class="event-name">${event.name}</div>
                        <div class="event-detail"><strong>Date:</strong> ${new Date(event.date).toLocaleDateString()}</div>
                        <div class="event-detail"><strong>Time:</strong> ${event.time || 'N/A'}</div>
                        <div class="event-detail"><strong>Venue:</strong> ${event.venue || 'N/A'}</div>
                        <div class="event-detail"><strong>Description:</strong> ${event.description || 'No description.'}</div>
                        <div class="event-detail">
                            <strong>Attendees:</strong> 
                            <span class="status-badge status-approved">${currentAttendeesCount}</span>
                            <small style="color: #7f8c8d; margin-left: 10px;">${attendeeText}</small>
                        </div>
                        <div class="event-actions" onclick="event.stopPropagation()">
                            ${type === 'upcoming' ? `
                                ${isSignedUp ? `
                                    <button class="btn btn-secondary" onclick="cancelSignUp(this, '${event.id}')">Cancel Sign-up</button>
                                    <span class="status-badge status-approved">Registered</span>
                                ` : `
                                    <button class="btn btn-primary" onclick="console.log('Button clicked!'); signUpForEvent(this, '${event.id}')">Sign Up</button>
                                `}
                            ` : `
                                ${!isPastEvent ? `<button class="btn btn-secondary" onclick="cancelSignUp(this, '${event.id}')">Cancel Sign-up</button>` : ''}
                                ${isSignedUp ? `<span class="status-badge status-approved">${event.attendees.find(a => a.id === currentMember.id || a.memberId === currentMember.id)?.attended ? 'Attended' : 'Registered'}</span>` : ''}
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = `<div class="events-grid">${eventsHTML}</div>`;
        }

        async function signUpForEvent(buttonElement, eventId) {
            console.log('signUpForEvent called with:', { buttonElement, eventId, currentMember, memberToken });
            
            if (!currentMember || !currentMember.id) {
                console.log('No current member or member ID');
                showMessage('You must be logged in to sign up for events.', 'error');
                return;
            }

            if (!memberToken) {
                console.log('No member token available');
                showMessage('Authentication token missing. Please log in again.', 'error');
                showLogin();
                return;
            }

            const btn = buttonElement;
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Signing up...';

            console.log('Sending sign-up request...');

            try {
                const requestBody = { 
                    eventId: eventId,
                    memberId: currentMember.id,
                    memberName: `${currentMember.firstName} ${currentMember.lastName}`,
                    memberEmail: currentMember.email,
                    memberCompany: currentMember.company || '',
                    memberLinkedin: currentMember.linkedin || ''
                };
                
                console.log('Request body:', requestBody);

                const response = await fetch('/.netlify/functions/sign-up-event', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${memberToken}`
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);

                if (response.status === 401) {
                    console.log('Unauthorized response, showing login');
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('Response result:', result);

                if (response.ok && result.success) {
                    console.log('Sign-up successful!');
                    showMessage('Successfully signed up for the event!', 'success');
                    
                    // Show booking reminder alert after a short delay
                    setTimeout(() => {
                        showBookingReminder(eventId);
                    }, 1500);
                    
                    loadEvents('upcoming'); 
                    loadEvents('my');       
                } else {
                    console.log('Sign-up failed:', result);
                    showMessage(result.error || 'Failed to sign up for event.', 'error');
                }
            } catch (error) {
                console.error('Sign-up error:', error);
                showMessage('Failed to sign up for event due to network error. Please try again.', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function showBookingReminder(eventId) {
            // Find the event to get venue information
            const event = allEvents.find(e => e.id === eventId);
            if (!event) {
                console.log('Event not found for booking reminder');
                return;
            }

            // Find the venue to get booking URL
            const venue = allVenues.find(v => v.id === event.venueId || v.name === event.venue);
            
            // Create and show booking reminder modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); z-index: 2000; display: flex; 
                align-items: center; justify-content: center; font-family: 'League Spartan', sans-serif;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; max-width: 500px; 
                margin: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); text-align: center;
            `;
            
            // Create header
            const header = document.createElement('h3');
            header.style.cssText = 'color: #2c3e50; margin-bottom: 20px; font-size: 1.5rem;';
            header.textContent = '🎉 Registration Successful!';
            
            // Create description
            const description = document.createElement('p');
            description.style.cssText = 'color: #5d6d7e; margin-bottom: 25px; line-height: 1.6;';
            description.innerHTML = '<strong>Important:</strong> Don\'t forget to book your karting session directly with the track if you haven\'t already.';
            
            // Create venue info container
            const venueContainer = document.createElement('div');
            venueContainer.style.cssText = 'background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;';
            
            if (venue && venue.website) {
                const venueName = document.createElement('p');
                venueName.style.cssText = 'color: #2c3e50; margin-bottom: 15px; font-weight: 600;';
                venueName.textContent = `📍 ${venue.name}`;
                
                const bookingLink = document.createElement('a');
                bookingLink.href = venue.website;
                bookingLink.target = '_blank';
                bookingLink.style.cssText = `
                    display: inline-block; background: #e74c3c; color: white; padding: 12px 24px; 
                    text-decoration: none; border-radius: 6px; font-weight: 600; 
                    transition: background 0.3s ease; cursor: pointer;
                `;
                bookingLink.textContent = '🔗 Book Your Session Now';
                
                // Add hover effects
                bookingLink.addEventListener('mouseenter', () => {
                    bookingLink.style.background = '#c0392b';
                });
                bookingLink.addEventListener('mouseleave', () => {
                    bookingLink.style.background = '#e74c3c';
                });
                
                venueContainer.appendChild(venueName);
                venueContainer.appendChild(bookingLink);
            } else {
                const venueName = document.createElement('p');
                venueName.style.cssText = 'color: #2c3e50; margin-bottom: 10px;';
                venueName.innerHTML = `<strong>📍 ${event.venue || 'Venue details in event information'}</strong>`;
                
                if (venue && venue.phone) {
                    const venuePhone = document.createElement('p');
                    venuePhone.style.cssText = 'color: #5d6d7e; margin-bottom: 10px;';
                    venuePhone.textContent = `📞 ${venue.phone}`;
                    venueContainer.appendChild(venuePhone);
                }
                
                const contactNote = document.createElement('p');
                contactNote.style.cssText = 'color: #7f8c8d; font-size: 0.9rem;';
                contactNote.textContent = 'Contact the venue directly to book your session';
                
                venueContainer.appendChild(venueName);
                venueContainer.appendChild(contactNote);
            }
            
            // Create close button
            const closeButton = document.createElement('button');
            closeButton.style.cssText = `
                background: #95a5a6; color: white; border: none; padding: 10px 20px; 
                border-radius: 6px; cursor: pointer; font-weight: 600; font-family: 'League Spartan', sans-serif;
                transition: background 0.3s ease;
            `;
            closeButton.textContent = 'Close';
            
            // Add hover effects and click handler to close button
            closeButton.addEventListener('mouseenter', () => {
                closeButton.style.background = '#7f8c8d';
            });
            closeButton.addEventListener('mouseleave', () => {
                closeButton.style.background = '#95a5a6';
            });
            closeButton.addEventListener('click', () => {
                modal.remove();
            });
            
            // Assemble modal content
            modalContent.appendChild(header);
            modalContent.appendChild(description);
            modalContent.appendChild(venueContainer);
            modalContent.appendChild(closeButton);
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showCancellationReminder(eventId) {
            // Find the event to get venue information
            const event = allEvents.find(e => e.id === eventId);
            if (!event) {
                console.log('Event not found for cancellation reminder');
                return;
            }

            // Find the venue to get booking URL
            const venue = allVenues.find(v => v.id === event.venueId || v.name === event.venue);
            
            // Create and show cancellation reminder modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); z-index: 2000; display: flex; 
                align-items: center; justify-content: center; font-family: 'League Spartan', sans-serif;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; max-width: 500px; 
                margin: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); text-align: center;
            `;
            
            // Create header
            const header = document.createElement('h3');
            header.style.cssText = 'color: #e74c3c; margin-bottom: 20px; font-size: 1.5rem;';
            header.textContent = '🏎️ Cancellation Successful!';
            
            // Create description
            const description = document.createElement('p');
            description.style.cssText = 'color: #5d6d7e; margin-bottom: 25px; line-height: 1.6;';
            description.innerHTML = '<strong>Important:</strong> Don\'t forget to cancel your karting session booking directly with the track if you have one.';
            
            // Create venue info container
            const venueContainer = document.createElement('div');
            venueContainer.style.cssText = 'background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #e74c3c;';
            
            if (venue && venue.website) {
                const venueName = document.createElement('p');
                venueName.style.cssText = 'color: #2c3e50; margin-bottom: 15px; font-weight: 600;';
                venueName.textContent = `📍 ${venue.name}`;
                
                const cancellationLink = document.createElement('a');
                cancellationLink.href = venue.website;
                cancellationLink.target = '_blank';
                cancellationLink.style.cssText = `
                    display: inline-block; background: #e74c3c; color: white; padding: 12px 24px; 
                    text-decoration: none; border-radius: 6px; font-weight: 600; 
                    transition: background 0.3s ease; cursor: pointer;
                `;
                cancellationLink.textContent = '🔗 Cancel Track Booking';
                
                // Add hover effects
                cancellationLink.addEventListener('mouseenter', () => {
                    cancellationLink.style.background = '#c0392b';
                });
                cancellationLink.addEventListener('mouseleave', () => {
                    cancellationLink.style.background = '#e74c3c';
                });
                
                venueContainer.appendChild(venueName);
                venueContainer.appendChild(cancellationLink);
            } else {
                const venueName = document.createElement('p');
                venueName.style.cssText = 'color: #2c3e50; margin-bottom: 10px;';
                venueName.innerHTML = `<strong>📍 ${event.venue || 'Venue details in event information'}</strong>`;
                
                if (venue && venue.phone) {
                    const venuePhone = document.createElement('p');
                    venuePhone.style.cssText = 'color: #5d6d7e; margin-bottom: 10px;';
                    venuePhone.textContent = `📞 ${venue.phone}`;
                    venueContainer.appendChild(venuePhone);
                }
                
                const contactNote = document.createElement('p');
                contactNote.style.cssText = 'color: #7f8c8d; font-size: 0.9rem;';
                contactNote.textContent = 'Contact the venue directly to cancel your track booking';
                
                venueContainer.appendChild(venueName);
                venueContainer.appendChild(contactNote);
            }
            
            // Create close button
            const closeButton = document.createElement('button');
            closeButton.style.cssText = `
                background: #95a5a6; color: white; border: none; padding: 10px 20px; 
                border-radius: 6px; cursor: pointer; font-weight: 600; font-family: 'League Spartan', sans-serif;
                transition: background 0.3s ease;
            `;
            closeButton.textContent = 'Close';
            
            // Add hover effects and click handler to close button
            closeButton.addEventListener('mouseenter', () => {
                closeButton.style.background = '#7f8c8d';
            });
            closeButton.addEventListener('mouseleave', () => {
                closeButton.style.background = '#95a5a6';
            });
            closeButton.addEventListener('click', () => {
                modal.remove();
            });
            
            // Assemble modal content
            modalContent.appendChild(header);
            modalContent.appendChild(description);
            modalContent.appendChild(venueContainer);
            modalContent.appendChild(closeButton);
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function cancelSignUp(buttonElement, eventId) {
            if (!currentMember || !currentMember.id) {
                showMessage('You must be logged in to cancel event sign-ups.', 'error');
                return;
            }

            const btn = buttonElement;
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Cancelling...';

            try {
                const response = await fetch('/.netlify/functions/cancel-sign-up', {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${memberToken}`
                    },
                    body: JSON.stringify({ 
                        eventId: eventId,
                        memberId: currentMember.id
                    })
                });

                if (response.status === 401) {
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return;
                }
                
                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage('Successfully cancelled sign-up.', 'success');
                    
                    // Show cancellation reminder after a short delay
                    setTimeout(() => {
                        showCancellationReminder(eventId);
                    }, 1500);
                    
                    loadEvents('upcoming'); 
                    loadEvents('my');       
                } else {
                    showMessage(result.error || 'Failed to cancel sign-up.', 'error');
                    // Refresh UI if user wasn't actually signed up to sync the display
                    if (result.error === 'You are not signed up for this event.') {
                        // Add small delay to ensure server state is consistent
                        setTimeout(() => {
                            loadEvents('upcoming'); 
                            loadEvents('my');
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('Cancel sign-up error:', error);
                showMessage('Failed to cancel sign-up due to network error. Please try again.', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Load venues data only (for background loading)
        async function loadVenuesData() {
            try {
                const response = await fetch('/.netlify/functions/get-venues-member', {
                    headers: { 'Authorization': `Bearer ${memberToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    allVenues = data.venues || [];
                    console.log('Venues loaded for booking reminders:', allVenues.length);
                }
            } catch (error) {
                console.error('Error loading venues data:', error);
            }
        }

        async function loadVenues() {
            const container = document.getElementById('venuesContainer');
            container.innerHTML = '<div class="loading">Loading venues...</div>';

            try {
                const response = await fetch('/.netlify/functions/get-venues-member', {
                    headers: { 'Authorization': `Bearer ${memberToken}` }
                });

                if (response.status === 401) {
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return;
                }
                if (!response.ok) throw new Error('Failed to load venues');

                const data = await response.json();
                allVenues = data.venues || [];
                renderVenues(container);

            } catch (error) {
                console.error('Error loading venues:', error);
                container.innerHTML = `<div class="error">Failed to load venues. ${error.message}</div>`;
            }
        }

        function renderVenues(container) {
            if (allVenues.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No venues found</h3>
                        <p>Currently no venues are listed. Check back later!</p>
                    </div>
                `;
                return;
            }

            const venuesHTML = allVenues.map(venue => `
                <div class="venue-card">
                    <div class="venue-name">${venue.name}</div>
                    <div class="venue-detail"><strong>Address:</strong> ${venue.address}</div>
                    ${venue.phone ? `<div class="venue-detail"><strong>Phone:</strong> ${venue.phone}</div>` : ''}
                    ${venue.website ? `<div class="venue-detail"><strong>Website:</strong> <a href="${venue.website}" target="_blank" style="color: #e74c3c;">Visit Site</a></div>` : ''}
                    ${venue.notes ? `<div class="venue-detail"><strong>Notes:</strong> ${venue.notes}</div>` : ''}
                    
                    ${venue.trackMapPath ? `
                        <div class="venue-feature">
                            <h4>🏁 Track Map</h4>
                            <img src="/.netlify/functions/get-photo?path=${encodeURIComponent(venue.trackMapPath)}" 
                                 alt="Track map for ${venue.name}" 
                                 style="width: 100%; max-width: 400px; height: auto; border-radius: 8px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 loading="lazy">
                        </div>
                    ` : ''}
                    
                    ${venue.drivingTips ? `
                        <div class="venue-feature">
                            <h4>🏎️ Driving Tips</h4>
                            <div class="driving-tips">${venue.drivingTips.replace(/\n/g, '<br>')}</div>
                        </div>
                    ` : ''}
                    
                    ${venue.vimeoId ? `
                        <div class="venue-feature">
                            <h4>🎥 Track Video</h4>
                            <div class="video-container">
                                <iframe src="https://player.vimeo.com/video/${venue.vimeoId}?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" 
                                        width="100%" height="200" frameborder="0" 
                                        allow="autoplay; fullscreen; picture-in-picture; clipboard-write" 
                                        title="Track video for ${venue.name}">
                                </iframe>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            container.innerHTML = `<div class="venues-grid">${venuesHTML}</div>`;
        }

        // Event modal functions
        function showEventDetails(eventId) {
            const event = allEvents.find(e => e.id === eventId);
            if (!event) return;

            // Populate modal with event details
            document.getElementById('eventModalTitle').textContent = event.name;
            
            const eventDetails = `
                <div class="event-detail-item"><strong>Date:</strong> ${new Date(event.date).toLocaleDateString()}</div>
                <div class="event-detail-item"><strong>Time:</strong> ${event.time || 'N/A'}</div>
                <div class="event-detail-item"><strong>Venue:</strong> ${event.venue || 'N/A'}</div>
                <div class="event-detail-item"><strong>Description:</strong> ${event.description || 'No description available.'}</div>
            `;
            document.getElementById('eventModalDetails').innerHTML = eventDetails;

            // Handle event photos - only show if photos exist
            const photosSection = document.getElementById('eventPhotosSection');
            const photosGrid = document.getElementById('eventPhotosGrid');
            if (event.photos && event.photos.length > 0) {
                const photosHTML = event.photos.map(photo => `
                    <div style="position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;" onclick="openPhotoModal('${photo.path}', '${photo.caption || ''}')">
                        <img src="/.netlify/functions/get-photo?path=${encodeURIComponent(photo.path)}" 
                             alt="${photo.caption || 'Event photo'}" 
                             style="width: 100%; height: 120px; object-fit: cover; transition: transform 0.3s ease;"
                             onmouseover="this.style.transform='scale(1.05)'" 
                             onmouseout="this.style.transform='scale(1)'">
                        ${photo.caption ? `<div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; padding: 8px; font-size: 0.8rem;">${photo.caption}</div>` : ''}
                    </div>
                `).join('');
                photosGrid.innerHTML = photosHTML;
                photosSection.style.display = 'block';
            } else {
                photosSection.style.display = 'none';
            }

            // Handle event videos - only show if videos exist
            const videosSection = document.getElementById('eventVideosSection');
            const videosGrid = document.getElementById('eventVideosGrid');
            if (event.videos && event.videos.length > 0) {
                const videosHTML = event.videos.map(video => `
                    <div style="border: 1px solid #ecf0f1; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); background: white;">
                        <div style="aspect-ratio: 16/9; background: #f8f9fa; position: relative;">
                            <iframe 
                                src="https://player.vimeo.com/video/${video.vimeoId}?badge=0&autopause=0&quality_selector=1&player_id=0&app_id=58479" 
                                width="100%" 
                                height="100%" 
                                frameborder="0" 
                                allow="autoplay; fullscreen; picture-in-picture; clipboard-write" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                title="${video.title || 'Event Video'}">
                            </iframe>
                        </div>
                        <div style="padding: 12px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; font-size: 0.9rem;">${video.title || video.fileName}</div>
                            ${video.description ? `<div style="color: #6c757d; font-size: 0.8rem; margin-bottom: 8px; line-height: 1.4;">${video.description}</div>` : ''}
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #7f8c8d;">
                                <span>Uploaded: ${new Date(video.uploadedAt).toLocaleDateString()}</span>
                                <a href="https://vimeo.com/${video.vimeoId}" target="_blank" style="color: #3498db; text-decoration: none;">View on Vimeo</a>
                            </div>
                        </div>
                    </div>
                `).join('');
                videosGrid.innerHTML = videosHTML;
                videosSection.style.display = 'block';
            } else {
                videosSection.style.display = 'none';
            }

            // Populate attendees list
            const attendees = event.attendees || [];
            document.getElementById('attendeeCount').textContent = attendees.length;
            
            // Check if event is completed and current member attended
            const eventDate = new Date(event.date);
            const today = new Date();
            const isEventCompleted = eventDate < today;
            const currentMemberAttended = attendees.some(attendee => 
                attendee.memberId === currentMember.id && attendee.attended
            );
            
            // Debug logging
            console.log('Event debugging:', {
                eventName: event.name,
                eventDate: event.date,
                isEventCompleted,
                currentMemberAttended,
                currentMemberId: currentMember.id,
                attendeesCount: attendees.length,
                attendees: attendees.map(a => ({
                    name: a.name,
                    memberId: a.memberId,
                    attended: a.attended,
                    hasLinkedIn: !!a.linkedin
                }))
            });
            
            const attendeesList = document.getElementById('attendeesList');
            if (attendees.length === 0) {
                attendeesList.innerHTML = '<li style="text-align: center; color: #7f8c8d; padding: 20px;">No one has registered yet. Be the first!</li>';
            } else {
                const attendeesHTML = attendees.map(attendee => {
                    const attendeeName = attendee.name || attendee.memberName || attendee.email || attendee.memberEmail;
                    const attendeeCompany = attendee.company || 'Company not specified';
                    
                    // Show LinkedIn link if:
                    // 1. Event is completed AND current member attended
                    // 2. This attendee also attended  
                    // 3. This attendee has a LinkedIn profile
                    // 4. This attendee is not the current member (don't show link to self)
                    const showLinkedInLink = isEventCompleted && 
                                           currentMemberAttended && 
                                           attendee.attended && 
                                           attendee.linkedin && 
                                           attendee.linkedin.trim() &&
                                           attendee.memberId !== currentMember.id;
                    
                    // Debug individual attendee
                    if (attendee.attended) {
                        console.log(`Attendee ${attendee.name} debug:`, {
                            isEventCompleted,
                            currentMemberAttended,
                            attendeeAttended: attendee.attended,
                            hasLinkedin: !!attendee.linkedin,
                            linkedinValue: attendee.linkedin,
                            isNotSelf: attendee.memberId !== currentMember.id,
                            showLinkedInLink
                        });
                    }
                    
                    return `
                        <li class="attendee-item">
                            <div class="attendee-info">
                                <div class="attendee-name">${attendeeName}</div>
                                <div class="attendee-company">${attendeeCompany}</div>
                                ${showLinkedInLink ? `
                                    <div style="margin-top: 8px;">
                                        <a href="https://linkedin.com/in/${attendee.linkedin}" target="_blank" 
                                           style="color: #0077b5; text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 4px;">
                                            🔗 Connect on LinkedIn
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                            <span class="attendee-status ${attendee.attended ? 'status-attended' : 'status-registered'}">
                                ${attendee.attended ? 'Attended' : 'Registered'}
                            </span>
                        </li>
                    `;
                }).join('');
                attendeesList.innerHTML = attendeesHTML;
            }

            // Show modal
            document.getElementById('eventModal').style.display = 'block';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        // Profile modal functions
        function openProfileModal() {
            if (!currentMember) return;
            
            // Populate form with current member data
            document.getElementById('profileFirstName').value = currentMember.firstName || '';
            document.getElementById('profileLastName').value = currentMember.lastName || '';
            document.getElementById('profileEmail').value = currentMember.email || '';
            document.getElementById('profileCompany').value = currentMember.company || '';
            document.getElementById('profilePosition').value = currentMember.position || '';
            document.getElementById('profilePhone').value = currentMember.phone || '';
            document.getElementById('profileLinkedin').value = currentMember.linkedin || '';
            
            // Clear password fields
            document.getElementById('profilePassword').value = '';
            document.getElementById('profileConfirmPassword').value = '';
            
            // Update password status display
            const passwordStatus = document.getElementById('passwordStatus');
            if (currentMember.hasPassword) {
                passwordStatus.textContent = 'Password set - you can use both login methods';
                passwordStatus.style.color = '#27ae60';
            } else {
                passwordStatus.textContent = 'Password not set - use magic link login only';
                passwordStatus.style.color = '#e74c3c';
            }
            
            // Clear any previous messages
            document.getElementById('profileMessage').classList.add('hidden');
            
            // Show modal
            document.getElementById('profileModal').style.display = 'block';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // Photo modal functions
        function openPhotoModal(photoPath, caption) {
            const modal = document.getElementById('photoModal');
            const img = document.getElementById('photoModalImage');
            const captionElement = document.getElementById('photoModalCaption');
            
            img.src = '/.netlify/functions/get-photo?path=' + encodeURIComponent(photoPath);
            captionElement.textContent = caption || '';
            modal.style.display = 'block';
        }

        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }

        async function updateProfile(profileData) {
            try {
                const response = await fetch('/.netlify/functions/update-member-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${memberToken}`
                    },
                    body: JSON.stringify(profileData)
                });

                if (response.status === 401) {
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return false;
                }

                const result = await response.json();

                if (response.ok && result.success) {
                    // Update local member data
                    currentMember = { ...currentMember, ...profileData };
                    
                    // Update password status if returned from API
                    if (result.hasPassword !== undefined) {
                        currentMember.hasPassword = result.hasPassword;
                    }
                    
                    localStorage.setItem('kartel_member_firstName', profileData.firstName);
                    localStorage.setItem('kartel_member_lastName', profileData.lastName);
                    localStorage.setItem('kartel_member_company', profileData.company);
                    localStorage.setItem('kartel_member_position', profileData.position);
                    localStorage.setItem('kartel_member_phone', profileData.phone);
                    localStorage.setItem('kartel_member_linkedin', profileData.linkedin);
                    
                    // Update display name in header (now handled by unified top bar)
                    if (window.kartelTopBar) {
                        window.kartelTopBar.updateUser(currentMember, currentMember.isAdmin);
                    }
                    
                    // Update password status display
                    updatePasswordStatusDisplay();
                    
                    showMessage('Profile updated successfully!', 'success', 'profileMessage');
                    return true;
                } else {
                    showMessage(result.error || 'Failed to update profile.', 'error', 'profileMessage');
                    return false;
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showMessage('Failed to update profile due to network error. Please try again.', 'error', 'profileMessage');
                return false;
            }
        }

        // Function to update password status display
        function updatePasswordStatusDisplay() {
            const passwordStatus = document.getElementById('passwordStatus');
            if (passwordStatus) {
                if (currentMember.hasPassword) {
                    passwordStatus.textContent = 'Password set - you can use both login methods';
                    passwordStatus.style.color = '#27ae60';
                } else {
                    passwordStatus.textContent = 'Password not set - use magic link login only';
                    passwordStatus.style.color = '#e74c3c';
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const eventModal = document.getElementById('eventModal');
            const profileModal = document.getElementById('profileModal');
            const photoModal = document.getElementById('photoModal');
            const linkedinPromptModal = document.getElementById('linkedinPromptModal');
            if (event.target === eventModal) {
                closeEventModal();
            }
            if (event.target === profileModal) {
                closeProfileModal();
            }
            if (event.target === photoModal) {
                closePhotoModal();
            }
            if (event.target === linkedinPromptModal) {
                closeLinkedInPrompt();
            }
        }

        // LinkedIn URL parsing function
        function parseLinkedInProfile(input) {
            if (!input) return '';
            
            // Remove whitespace
            const cleaned = input.trim();
            
            // If empty after trimming, return empty
            if (!cleaned) return '';
            
            // Common LinkedIn URL patterns to match (including uk.linkedin.com)
            const patterns = [
                /^https?:\/\/(www\.)?linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,
                /^https?:\/\/(www\.)?uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,
                /^https?:\/\/(www\.)?linkedin\.com\/pub\/([a-zA-Z0-9\-]+)\/?.*$/,
                /^https?:\/\/(www\.)?uk\.linkedin\.com\/pub\/([a-zA-Z0-9\-]+)\/?.*$/,
                /^linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,
                /^uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,
                /^www\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,
                /^www\.uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,
                /^([a-zA-Z0-9\-]+)$/  // Just the username
            ];
            
            // Try each pattern
            for (const pattern of patterns) {
                const match = cleaned.match(pattern);
                if (match) {
                    // Return the captured group (username)
                    return match[match.length - 1]; // Last capture group
                }
            }
            
            // If no pattern matches, return the cleaned input as-is
            // This handles edge cases or new formats
            return cleaned;
        }

        // Profile form submission handler
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const newPassword = formData.get('profilePassword').trim();
            const confirmPassword = formData.get('profileConfirmPassword').trim();
            
            // Validate password fields if provided
            if (newPassword || confirmPassword) {
                if (!newPassword || !confirmPassword) {
                    showMessage('Both password fields are required when setting a password.', 'error', 'profileMessage');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showMessage('Passwords do not match. Please try again.', 'error', 'profileMessage');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showMessage('Password must be at least 8 characters long.', 'error', 'profileMessage');
                    return;
                }
            }
            
            const profileData = {
                firstName: formData.get('profileFirstName').trim(),
                lastName: formData.get('profileLastName').trim(),
                company: formData.get('profileCompany').trim(),
                position: formData.get('profilePosition').trim(),
                phone: formData.get('profilePhone').trim(),
                linkedin: parseLinkedInProfile(formData.get('profileLinkedin')),
                memberId: currentMember.id,
                memberEmail: currentMember.email
            };
            
            // Include password if provided
            if (newPassword) {
                profileData.newPassword = newPassword;
            }
            
            if (!profileData.firstName || !profileData.lastName) {
                showMessage('First name and last name are required.', 'error', 'profileMessage');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Updating...';
            submitBtn.disabled = true;
            
            try {
                const success = await updateProfile(profileData);
                if (success && newPassword) {
                    showMessage('Profile and password updated successfully!', 'success', 'profileMessage');
                } else if (success) {
                    showMessage('Profile updated successfully!', 'success', 'profileMessage');
                }
                
                if (success) {
                    setTimeout(() => {
                        closeProfileModal();
                    }, 2000);
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        function showLoginHelp() {
            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); z-index: 2000; display: flex; 
                align-items: center; justify-content: center; font-family: 'League Spartan', sans-serif;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; padding: 40px; border-radius: 15px; max-width: 500px; 
                margin: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); text-align: left;
            `;
            
            modalContent.innerHTML = `
                <h3 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.5rem; text-align: center;">🚑 Login Help</h3>
                
                <div style="color: #5d6d7e; line-height: 1.6; margin-bottom: 25px;">
                    <p><strong>If you're having trouble logging in:</strong></p>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li>Check your email (including spam/junk folder)</li>
                        <li>The login link expires after 30 minutes</li>
                        <li>Each link can only be used once</li>
                        <li>Make sure you're using the same device/browser</li>
                        <li>Try clearing your browser cache</li>
                    </ul>
                    
                    <p style="margin-top: 20px;"><strong>Still having issues?</strong></p>
                    <p>Contact us at: <a href="mailto:hello@the-kartel.co.uk" style="color: #e74c3c;">hello@the-kartel.co.uk</a></p>
                    <p>Or call: <a href="tel:+447123456789" style="color: #e74c3c;">+44 7123 456789</a></p>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="this.closest('div').parentElement.remove()" 
                            style="background: #95a5a6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: 'League Spartan', sans-serif;">
                        Close
                    </button>
                </div>
            `;
            
            helpModal.appendChild(modalContent);
            document.body.appendChild(helpModal);
            
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }

        // LinkedIn prompt functions
        function showLinkedInPrompt() {
            if (!currentMember) return;
            
            // Clear form and message
            document.getElementById('linkedinPromptInput').value = '';
            document.getElementById('linkedinDismissCheckbox').checked = false;
            document.getElementById('linkedinPromptMessage').classList.add('hidden');
            
            // Show modal
            document.getElementById('linkedinPromptModal').style.display = 'block';
        }

        function closeLinkedInPrompt() {
            // Check if user wants to dismiss permanently
            const dismissCheckbox = document.getElementById('linkedinDismissCheckbox');
            if (dismissCheckbox.checked) {
                // Store dismissal preference
                localStorage.setItem('kartel_linkedin_dismissed', 'true');
            }
            
            document.getElementById('linkedinPromptModal').style.display = 'none';
        }

        async function saveLinkedInFromPrompt() {
            const linkedinInput = document.getElementById('linkedinPromptInput');
            const linkedin = parseLinkedInProfile(linkedinInput.value);
            
            if (!linkedin) {
                showMessage('Please enter your LinkedIn username or check the dismissal option.', 'error', 'linkedinPromptMessage');
                return;
            }
            
            const submitBtn = document.querySelector('#linkedinPromptModal .btn-success');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;
            
            try {
                const profileData = {
                    firstName: currentMember.firstName,
                    lastName: currentMember.lastName,
                    company: currentMember.company || '',
                    position: currentMember.position || '',
                    phone: currentMember.phone || '',
                    linkedin: linkedin,
                    memberId: currentMember.id,
                    memberEmail: currentMember.email
                };
                
                const success = await updateProfile(profileData);
                if (success) {
                    showMessage('LinkedIn profile added successfully!', 'success', 'linkedinPromptMessage');
                    setTimeout(() => {
                        document.getElementById('linkedinPromptModal').style.display = 'none';
                    }, 2000);
                }
            } catch (error) {
                showMessage('Failed to save LinkedIn profile. Please try again.', 'error', 'linkedinPromptMessage');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function shouldShowLinkedInPrompt() {
            // Don't show if user has dismissed it
            if (localStorage.getItem('kartel_linkedin_dismissed') === 'true') {
                return false;
            }
            
            // Don't show if member already has LinkedIn profile
            if (currentMember && currentMember.linkedin && currentMember.linkedin.trim()) {
                return false;
            }
            
            return true;
        }

        // Handle URL parameters for registration success/error messages and direct registration
        async function handleUrlParameters() {
            // Explicit authentication state check before processing URL parameters
            if (!memberToken || !currentMember) {
                console.log('⚠️ handleUrlParameters called without valid authentication, skipping');
                return;
            }
            
            const params = new URLSearchParams(window.location.search);
            const hash = window.location.hash;
            
            
            // Handle direct registration from email links
            if (params.has('register') && params.has('token') && params.has('email')) {
                const eventId = params.get('register');
                const token = params.get('token');
                const email = params.get('email');
                
                console.log('📧 Direct registration request:', { eventId, token, email });
                console.log('👤 Current member status:', currentMember ? currentMember.email : 'Not logged in');
                
                // If user is logged in, proceed with registration
                if (currentMember && currentMember.email) {
                    console.log('✅ User is logged in, checking email match');
                    // Verify the email matches the logged-in user
                    if (currentMember.email.toLowerCase() === email.toLowerCase()) {
                        console.log('✅ Email matches, proceeding with registration');
                        handleDirectRegistration(eventId, token, email);
                    } else {
                        console.log('❌ Email mismatch:', { current: currentMember.email, expected: email });
                        showMessage('Email mismatch. Please log in with the correct account.', 'error');
                        showLogin();
                    }
                } else {
                    // Check if user is logged in as admin
                    const adminToken = localStorage.getItem('kartel_admin_token');
                    const adminUser = localStorage.getItem('kartel_admin_user');
                    
                    if (adminToken && adminUser) {
                        console.log('👨‍💼 User is logged in as admin, checking if admin email matches member email');
                        try {
                            const adminData = JSON.parse(adminUser);
                            if (adminData.email && adminData.email.toLowerCase() === email.toLowerCase()) {
                                console.log('✅ Admin email matches test email, handling as admin test registration');
                                
                                // Check if this is a test event (starts with "test-")
                                if (eventId.startsWith('test-')) {
                                    console.log('🧪 Detected test event, allowing admin test registration');
                                    showMessage('Test registration detected - proceeding as admin test user...', 'info');
                                    handleDirectRegistration(eventId, token, email);
                                    return;
                                } else {
                                    // For real events, try to auto-login as member
                                    console.log('📅 Real event, attempting auto-login as member');
                                    showMessage('Detected admin login. Switching to member mode for event registration...', 'info');
                                    await autoLoginAsMember(adminData.email, eventId, token, email);
                                    return;
                                }
                            } else {
                                console.log('❌ Admin email does not match registration email');
                                showMessage(`You're logged in as admin (${adminData.email}) but this registration link is for ${email}. Please log in as the correct member.`, 'error');
                            }
                        } catch (error) {
                            console.error('Error parsing admin user data:', error);
                        }
                    }
                    
                    // Store registration info for after login
                    const pendingData = {
                        eventId, token, email,
                        originalUrl: window.location.href,
                        hash: hash || '#events'
                    };
                    console.log('💾 Storing registration info for after login:', pendingData);
                    sessionStorage.setItem('pendingRegistration', JSON.stringify(pendingData));
                    localStorage.setItem('kartel_pending_registration', JSON.stringify(pendingData));
                    showMessage('Please log in as a member to register for the event.', 'info');
                    showLogin();
                }
                
                // Clean up URL but preserve hash
                const cleanUrl = window.location.pathname + (hash ? hash : '');
                window.history.replaceState({}, document.title, cleanUrl);
                return;
            }
            
            // Handle other URL parameters
            if (params.has('registered')) {
                const eventName = params.get('registered');
                showMessage(`Successfully registered for ${eventName}!`, 'success');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (params.has('error')) {
                const errorMessage = params.get('error');
                showMessage(errorMessage, 'error');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (params.has('info')) {
                const infoMessage = params.get('info');
                showMessage(infoMessage, 'info');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Handle direct registration from email links
        async function handleDirectRegistration(eventId, token, email) {
            console.log('🎫 Processing direct registration:', { eventId, token, email });
            
            try {
                // Verify token and register for event
                const response = await fetch('/.netlify/functions/quick-register-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        eventId: eventId,
                        memberEmail: email,
                        token: token
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showMessage(`Successfully registered for ${result.eventName || 'the event'}!`, 'success');
                    
                    // Switch to My Events tab to show the newly registered event
                    switchTab('myEvents');
                    
                    // Show the event modal for the registered event after a short delay
                    setTimeout(() => {
                        if (result.eventId) {
                            showEventDetails(result.eventId);
                        }
                    }, 1000);
                    
                } else {
                    // Handle "Already registered" as a success case
                    if (result.error === 'Already registered') {
                        showMessage(result.message || `You are already registered for this event!`, 'success');
                        
                        // Switch to My Events tab to show they're already registered
                        switchTab('myEvents');
                        
                        // Show the event modal for the event they're already registered for after a short delay
                        setTimeout(() => {
                            showEventDetails(eventId);
                        }, 1000);
                        
                        console.log('✅ User already registered, switched to My Events and showing event details');
                    } else {
                        showMessage(result.error || result.message || 'Registration failed. Please try again.', 'error');
                    }
                }
                
            } catch (error) {
                console.error('Direct registration error:', error);
                showMessage('Network error during registration. Please try again.', 'error');
            }
        }

        // Auto-login as member when admin email matches
        async function autoLoginAsMember(emailAddress, eventId, token, email) {
            try {
                console.log('🔄 Attempting to auto-login as member:', emailAddress);
                
                // Check if this email exists as an approved member
                const response = await fetch('/.netlify/functions/get-applications', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('kartel_admin_token')}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch member data');
                }
                
                const data = await response.json();
                const member = data.applications?.find(app => 
                    app.email.toLowerCase() === emailAddress.toLowerCase() && 
                    app.status === 'approved'
                );
                
                if (member) {
                    console.log('✅ Found approved member, creating member session');
                    
                    // Create member session
                    const memberToken = 'admin_generated_' + Date.now();
                    currentMember = {
                        id: member.id,
                        email: member.email,
                        firstName: member.firstName,
                        lastName: member.lastName,
                        company: member.company,
                        position: member.position,
                        phone: member.phone,
                        linkedin: member.linkedin,
                        hasPassword: !!member.passwordHash
                    };
                    
                    // Store member session
                    localStorage.setItem('kartel_member_token', memberToken);
                    localStorage.setItem('kartel_member_id', currentMember.id);
                    localStorage.setItem('kartel_member_email', currentMember.email);
                    localStorage.setItem('kartel_member_firstName', currentMember.firstName || '');
                    localStorage.setItem('kartel_member_lastName', currentMember.lastName || '');
                    localStorage.setItem('kartel_member_company', currentMember.company || '');
                    localStorage.setItem('kartel_member_position', currentMember.position || '');
                    localStorage.setItem('kartel_member_phone', currentMember.phone || '');
                    localStorage.setItem('kartel_member_linkedin', currentMember.linkedin || '');
                    localStorage.setItem('kartel_member_hasPassword', currentMember.hasPassword || false);
                    
                    showDashboard();
                    showMessage('Successfully switched to member mode!', 'success');
                    
                    // Process the registration
                    setTimeout(() => {
                        handleDirectRegistration(eventId, token, email);
                    }, 500);
                    
                } else {
                    console.log('❌ Admin email not found as approved member');
                    showMessage('Your admin email is not registered as an approved member. Please log in with a member account.', 'error');
                    showLogin();
                }
                
            } catch (error) {
                console.error('Error during auto-login as member:', error);
                showMessage('Failed to switch to member mode. Please log in manually.', 'error');
                showLogin();
            }
        }

        // Check for pending registration after successful login
        function checkPendingRegistration() {
            console.log('🔍 Checking for pending registration...');
            
            // Check sessionStorage first
            let pending = sessionStorage.getItem('pendingRegistration');
            let source = 'sessionStorage';
            
            // If not in sessionStorage, check localStorage
            if (!pending) {
                pending = localStorage.getItem('kartel_pending_registration');
                source = 'localStorage';
            }
            
            if (pending) {
                console.log(`📋 Found pending registration in ${source}:`, pending);
                const data = JSON.parse(pending);
                const { eventId, token, email, originalUrl, hash } = data;
                
                // Clean up both storage locations
                sessionStorage.removeItem('pendingRegistration');
                localStorage.removeItem('kartel_pending_registration');
                
                // Verify email matches logged-in user
                if (currentMember && currentMember.email.toLowerCase() === email.toLowerCase()) {
                    console.log('✅ Email matches, proceeding with registration');
                    
                    // Restore the URL context if available
                    if (hash) {
                        console.log(`🔗 Restoring URL hash: ${hash}`);
                        window.location.hash = hash;
                        
                        // Switch to appropriate tab based on hash
                        if (hash === '#events') {
                            switchTab('upcomingEvents');
                        } else if (hash === '#my-events') {
                            switchTab('myEvents');
                        } else if (hash === '#venues') {
                            switchTab('venues');
                        }
                    }
                    
                    handleDirectRegistration(eventId, token, email);
                } else {
                    console.log('❌ Email mismatch:', { currentMember: currentMember?.email, expectedEmail: email });
                    showMessage('Email mismatch. Registration cancelled.', 'error');
                }
            } else {
                console.log('ℹ️ No pending registration found');
            }
        }

        // Note: URL parameter handling is now done conditionally in DOMContentLoaded handler
        // to avoid conflicts with authentication state

        // Expose functions to global scope for onclick attributes
        window.switchTab = switchTab;
        window.signUpForEvent = signUpForEvent;
        window.cancelSignUp = cancelSignUp;
        window.showBookingReminder = showBookingReminder;
        window.showCancellationReminder = showCancellationReminder;
        window.showLoginForm = showLoginForm;
        window.showLoginHelp = showLoginHelp;
        window.showMagicLinkForm = showMagicLinkForm;
        window.showPasswordForm = showPasswordForm;
        window.showForgotPassword = showForgotPassword;
        window.showEventDetails = showEventDetails;
        window.closeEventModal = closeEventModal;
        window.openProfileModal = openProfileModal;
        window.closeProfileModal = closeProfileModal;
        window.openPhotoModal = openPhotoModal;
        window.closePhotoModal = closePhotoModal;
        window.showLinkedInPrompt = showLinkedInPrompt;
        window.closeLinkedInPrompt = closeLinkedInPrompt;
        window.saveLinkedInFromPrompt = saveLinkedInFromPrompt;

        // Admin switch functionality
        function switchToAdminView() {
            console.log('🔧 Switching to admin view');
            
            // Ensure admin user data is stored for the admin area
            const adminToken = localStorage.getItem('kartel_admin_token');
            const adminUser = localStorage.getItem('kartel_admin_user');
            
            console.log('👨‍💼 Admin credentials check:', {
                hasAdminToken: !!adminToken,
                hasAdminUser: !!adminUser
            });
            
            // If admin user data isn't stored, reconstruct it from current member data
            if (!adminUser && currentMember && currentMember.isAdmin) {
                console.log('🔧 Reconstructing admin user data from current member...');
                const adminUserData = {
                    id: currentMember.id,
                    email: currentMember.email,
                    name: currentMember.fullName || `${currentMember.firstName} ${currentMember.lastName}`.trim(),
                    firstName: currentMember.firstName,
                    lastName: currentMember.lastName
                };
                localStorage.setItem('kartel_admin_user', JSON.stringify(adminUserData));
                console.log('✅ Admin user data stored:', adminUserData);
            }
            
            // Mark that we're switching from member to admin (for potential auto-login)
            sessionStorage.setItem('switched_from_member', 'true');
            
            window.location.href = '/admin.html';
        }

        function checkIfAdmin() {
            // Admin checking is now handled by unified top bar system
            console.log('🔍 Admin check - delegating to unified top bar system');
            
            // Update the top bar with current user information
            if (window.kartelTopBar && currentMember) {
                const isAdmin = currentMember.isAdmin || localStorage.getItem('kartel_member_isAdmin') === 'true';
                window.kartelTopBar.updateUser(currentMember, isAdmin);
                console.log('✅ Top bar updated with admin status:', isAdmin);
            }
        }

        // Check for admin credentials when showing dashboard
        function showDashboardWithAdminCheck() {
            showDashboard();
            checkIfAdmin();
        }

        window.switchToAdminView = switchToAdminView;

        // Auto-login when switching from admin
        async function attemptAdminToMemberAutoLogin() {
            console.log('🔄 Attempting admin to member auto-login...');
            
            const adminToken = localStorage.getItem('kartel_admin_token');
            const adminUser = localStorage.getItem('kartel_admin_user');
            
            if (!adminToken || !adminUser) {
                console.log('❌ No admin credentials found, showing login');
                showLogin();
                return;
            }
            
            try {
                const adminData = JSON.parse(adminUser);
                console.log('👨‍💼 Admin data:', adminData);
                
                // Call our existing auto-login function
                await autoLoginAsMember(adminData.email, null, null, adminData.email);
                
            } catch (error) {
                console.error('❌ Auto-login failed:', error);
                showLogin();
            }
        }


        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available, prompt user to refresh
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt event fired');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after user has been on the site for a few seconds
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('kartel_install_dismissed')) {
                    console.log('Showing install prompt');
                    showInstallPrompt();
                }
            }, 5000);
        });

        function showInstallPrompt() {
            const installPrompt = document.createElement('div');
            installPrompt.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #2c3e50; color: white;
                padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000; max-width: 300px; font-family: 'League Spartan', sans-serif;
            `;
            installPrompt.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: 600;">Install The Kartel App</div>
                <div style="margin-bottom: 15px; font-size: 0.9rem; opacity: 0.9;">
                    Get quick access and offline functionality
                </div>
                <div>
                    <button onclick="installApp()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px; cursor: pointer; font-family: inherit;">Install</button>
                    <button onclick="dismissInstall()" style="background: transparent; color: #bdc3c7; border: 1px solid #7f8c8d; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-family: inherit;">Later</button>
                </div>
            `;
            installPrompt.id = 'installPrompt';
            document.body.appendChild(installPrompt);
        }

        window.installApp = function() {
            console.log('Install app clicked, deferredPrompt:', !!deferredPrompt);
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('Install prompt result:', choiceResult.outcome);
                    deferredPrompt = null;
                });
            } else {
                console.warn('No deferred prompt available');
            }
            const prompt = document.getElementById('installPrompt');
            if (prompt) prompt.remove();
        };

        window.dismissInstall = function() {
            localStorage.setItem('kartel_install_dismissed', 'true');
            const prompt = document.getElementById('installPrompt');
            if (prompt) prompt.remove();
        };

        // Initialize notification manager for members
        let notificationManager;
        window.addEventListener('load', () => {
            notificationManager = new NotificationManager('member');
            window.notificationManager = notificationManager; // Make available globally
        });
    </script>
</body>
</html>