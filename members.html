<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Kartel - Members Area</title>
    <style>
        /* General Styles - Consistent with main site */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #2c3e50; background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%); color: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background 0.3s ease; }
        .logout-btn:hover { background: #c0392b; }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .dashboard-header { text-align: center; margin-bottom: 40px; }
        .dashboard-title { font-size: 2.5rem; color: #2c3e50; margin-bottom: 10px; font-weight: 800; }
        .dashboard-subtitle { color: #7f8c8d; font-size: 1.1rem; }

        /* Tab Navigation - Similar to Admin */
        .tab-navigation { display: flex; background: white; border-radius: 10px 10px 0 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 0; }
        .tab-button { flex: 1; padding: 20px; background: #f8f9fa; border: none; cursor: pointer; font-size: 1.1rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab-button.active { background: white; color: #2c3e50; border-bottom-color: #e74c3c; }
        .tab-button:hover { background: #e9ecef; }
        .tab-button.active:hover { background: white; }
        .tab-content { display: none; background: white; border-radius: 0 0 10px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; }
        .tab-content.active { display: block; }

        /* Login Specific Styles */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%); }
        .login-card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 100%; margin: 20px; }
        .login-title { font-size: 2rem; color: #2c3e50; margin-bottom: 20px; font-weight: 800; }
        .login-btn { background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.3s ease; width: 100%; }
        .login-btn:hover { background: #c0392b; }
        .login-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; text-align: left; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 4px; font-size: 1rem; transition: border-color 0.3s ease; }
        .form-group input:focus { outline: none; border-color: #e74c3c; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 20px 0; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 4px; margin: 20px 0; border: 1px solid #c3e6cb; }
        .hidden { display: none; }

        /* Event and Venue display styles - Similar to Admin, but simplified for members */
        .events-grid, .venues-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .event-card, .venue-card { background: #fff; border: 1px solid #ecf0f1; border-radius: 10px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .event-card:hover, .venue-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .event-name, .venue-name { font-size: 1.6rem; font-weight: 700; color: #2c3e50; margin-bottom: 10px; }
        .event-detail, .venue-detail { margin-bottom: 8px; color: #5d6d7e; }
        .event-detail strong, .venue-detail strong { color: #2c3e50; font-weight: 600; }
        .event-actions { margin-top: 20px; display: flex; gap: 10px; }
        .btn { background: #3498db; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; display: inline-block; font-weight: 600; transition: background 0.3s ease; border: none; text-decoration: none; }
        .btn-primary { background: #e74c3c; }
        .btn-primary:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .empty-state { text-align: center; padding: 60px 20px; color: #7f8c8d; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 15px; color: #5d6d7e; }
        .empty-state p { font-size: 1.1rem; margin-bottom: 25px; }
        /* New badge style for attendee count */
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .status-approved { background: #d4edda; color: #155724; }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 15px; }
            .tab-navigation { flex-direction: column; }
            .tab-button { padding: 15px; font-size: 1rem; }
            .events-grid, .venues-grid { grid-template-columns: 1fr; }
            .login-card { padding: 30px; }
        }
    </style>
</head>
<body>
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <h1 class="login-title">The Kartel Members</h1>
            <p style="margin-bottom: 30px; color: #7f8c8d;">Login to your exclusive members area</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="memberEmail">Email Address</label>
                    <input type="email" id="memberEmail" name="memberEmail" required placeholder="your@email.com">
                </div>
                <button type="submit" id="loginBtn" class="login-btn">Login</button>
            </form>
            <div id="loginMessage" class="hidden"></div>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <header class="header">
            <div class="header-content">
                <div class="logo">The Kartel Members</div>
                <div class="user-info">
                    <span id="memberDisplayName"></span>
                    <button id="logoutBtn" class="logout-btn">Logout</button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Welcome to Your Dashboard</h1>
                <p class="dashboard-subtitle">Manage your events and explore venues.</p>
            </div>

            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('upcomingEvents')">üìÖ Upcoming Events</button>
                <button class="tab-button" onclick="switchTab('myEvents')">‚úÖ My Events</button>
                <button class="tab-button" onclick="switchTab('venues')">üèÅ Venues</button>
            </div>

            <div id="upcomingEventsTab" class="tab-content active">
                <div id="upcomingEventsContainer">
                    <div class="loading">Loading upcoming events...</div>
                </div>
            </div>

            <div id="myEventsTab" class="tab-content">
                <div id="myEventsContainer">
                    <div class="loading">Loading your events...</div>
                </div>
            </div>

            <div id="venuesTab" class="tab-content">
                <div id="venuesContainer">
                    <div class="loading">Loading venues...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let memberToken = localStorage.getItem('kartel_member_token');
        let currentMember = null; // Stores member's details like id, email, name
        let allEvents = [];
        let allVenues = [];

        function showMessage(message, type = 'success', containerId = 'loginMessage') {
            const container = document.getElementById(containerId);
            container.classList.remove('hidden', 'success', 'error');
            container.classList.add(type);
            container.textContent = message;
            setTimeout(() => {
                container.classList.add('hidden');
                container.textContent = '';
            }, 5000);
        }

        function showLogin() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('loginMessage').classList.add('hidden'); // Clear previous messages
        }

        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('memberDisplayName').textContent = currentMember.fullName || currentMember.email;
            switchTab('upcomingEvents'); // Default to upcoming events
        }

        async function checkAuth() {
            if (memberToken && localStorage.getItem('kartel_member_email')) {
                // For a more robust auth, you'd send the token to a function to validate it
                // For now, if token and email exist, assume logged in
                currentMember = {
                    email: localStorage.getItem('kartel_member_email'),
                    id: localStorage.getItem('kartel_member_id'),
                    fullName: localStorage.getItem('kartel_member_fullName')
                };
                showDashboard();
            } else {
                showLogin();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');

            // Load data when tab is switched
            if (tabName === 'upcomingEvents') {
                loadEvents('upcoming');
            } else if (tabName === 'myEvents') {
                loadEvents('my');
            } else if (tabName === 'venues') {
                loadVenues();
            }
        }

        // --- Authentication Logic ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('memberEmail').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            
            try {
                const response = await fetch('/.netlify/functions/member-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    memberToken = result.token;
                    currentMember = {
                        id: result.memberId,
                        email: result.memberEmail,
                        fullName: result.memberFullName
                    };
                    localStorage.setItem('kartel_member_token', memberToken);
                    localStorage.setItem('kartel_member_id', currentMember.id);
                    localStorage.setItem('kartel_member_email', currentMember.email);
                    localStorage.setItem('kartel_member_fullName', currentMember.fullName);
                    showDashboard();
                    showMessage('Login successful!', 'success');
                } else {
                    showMessage(result.error || 'Login failed. Please check your email or apply for membership.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login failed due to a network error. Please try again.', 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            memberToken = null;
            currentMember = null;
            localStorage.removeItem('kartel_member_token');
            localStorage.removeItem('kartel_member_id');
            localStorage.removeItem('kartel_member_email');
            localStorage.removeItem('kartel_member_fullName');
            showLogin();
        });

        // --- Event Loading & Display ---
        async function loadEvents(type) {
            const container = type === 'upcoming' ? document.getElementById('upcomingEventsContainer') : document.getElementById('myEventsContainer');
            container.innerHTML = '<div class="loading">Loading events...</div>';

            try {
                const response = await fetch('/.netlify/functions/get-events-member', {
                    headers: { 'Authorization': `Bearer ${memberToken}` }
                });

                if (response.status === 401) { // Token invalid or expired
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return;
                }
                if (!response.ok) throw new Error('Failed to load events');

                const data = await response.json();
                allEvents = data.events || [];
                renderEvents(type, container);

            } catch (error) {
                console.error('Error loading events:', error);
                container.innerHTML = `<div class="error">Failed to load events. ${error.message}</div>`;
            }
        }

        function renderEvents(type, container) {
            let eventsToDisplay = [];
            if (type === 'upcoming') {
                // Filter for upcoming events that the member is NOT already signed up for
                eventsToDisplay = allEvents.filter(event => 
                    new Date(event.date) >= new Date() && 
                    !(event.attendees && event.attendees.some(a => a.memberId === currentMember.id))
                );
            } else if (type === 'my') {
                // Filter for events the member IS signed up for
                eventsToDisplay = allEvents.filter(event => 
                    event.attendees && event.attendees.some(a => a.memberId === currentMember.id)
                );
            }

            if (eventsToDisplay.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No ${type === 'upcoming' ? 'upcoming' : 'registered'} events found</h3>
                        <p>${type === 'upcoming' ? 'Check back later for new opportunities or view your past events.' : 'You have not signed up for any events yet. Head to "Upcoming Events" to find some!'}</p>
                    </div>
                `;
                return;
            }

            const eventsHTML = eventsToDisplay.map(event => {
                // Log the event object and its type to the console for debugging
                console.log(`Event being rendered for '${type}' tab:`, event);

                const currentAttendeesCount = event.attendees ? event.attendees.length : 0;
                const isSignedUp = event.attendees && event.attendees.some(a => a.memberId === currentMember.id);
                return `
                    <div class="event-card">
                        <div class="event-name">${event.name}</div>
                        <div class="event-detail"><strong>Date:</strong> ${new Date(event.date).toLocaleDateString()}</div>
                        <div class="event-detail"><strong>Time:</strong> ${event.time || 'N/A'}</div>
                        <div class="event-detail"><strong>Venue:</strong> ${event.venue || 'N/A'}</div>
                        <div class="event-detail"><strong>Description:</strong> ${event.description || 'No description.'}</div>
                        <div class="event-detail">
                            <strong>Attendees:</strong> 
                            <span class="status-badge status-approved">${currentAttendeesCount}</span>
                        </div>
                        <div class="event-actions">
                            ${type === 'upcoming' ? `
                                <button class="btn btn-primary" onclick="signUpForEvent(event, '${event.id}')">Sign Up</button>
                            ` : `
                                <button class="btn btn-secondary" onclick="cancelSignUp(event, '${event.id}')">Cancel Sign-up</button>
                                ${isSignedUp ? `<span class="status-badge status-approved">${event.attendees.find(a => a.memberId === currentMember.id)?.attended ? 'Attended' : 'Registered'}</span>` : ''}
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = `<div class="events-grid">${eventsHTML}</div>`;
        }

        // --- Event Sign-up/Cancel Logic ---
        async function signUpForEvent(eventObj, eventId) { // Swapped parameter order
            console.log("Sign-up button clicked for event:", eventId); // Diagnostic log
            if (!currentMember || !currentMember.id) {
                showMessage('You must be logged in to sign up for events.', 'error');
                return;
            }

            const btn = eventObj.target; // Use eventObj.target to get the clicked button
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Signing up...';

            try {
                const response = await fetch('/.netlify/functions/sign-up-event', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${memberToken}`
                    },
                    body: JSON.stringify({ 
                        eventId: eventId,
                        memberId: currentMember.id,
                        memberName: currentMember.fullName,
                        memberEmail: currentMember.email,
                        memberCompany: currentMember.company || '' // Add company if available in currentMember object
                    })
                });

                if (response.status === 401) {
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return;
                }
                
                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage('Successfully signed up for the event!', 'success');
                    loadEvents('upcoming'); // Refresh upcoming events
                    loadEvents('my');       // Refresh my events
                } else {
                    showMessage(result.error || 'Failed to sign up for event.', 'error');
                }
            } catch (error) {
                console.error('Sign-up error:', error);
                showMessage('Failed to sign up for event due to network error. Please try again.', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function cancelSignUp(eventObj, eventId) { // Swapped parameter order
            console.log("Cancel sign-up button clicked for event:", eventId); // Diagnostic log
            if (!currentMember || !currentMember.id) {
                showMessage('You must be logged in to cancel event sign-ups.', 'error');
                return;
            }

            // Replacing confirm() with a message for now, as direct confirm is not allowed.
            // A custom modal UI would be ideal for a real confirmation.
            showMessage('Cancelling your sign-up...', 'success'); 
            
            const btn = eventObj.target; // Use eventObj.target to get the clicked button
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Cancelling...';

            try {
                const response = await fetch('/.netlify/functions/cancel-sign-up', {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${memberToken}`
                    },
                    body: JSON.stringify({ 
                        eventId: eventId,
                        memberId: currentMember.id
                    })
                });

                if (response.status === 401) {
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return;
                }
                
                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage('Successfully cancelled sign-up.', 'success');
                    loadEvents('upcoming'); // Refresh upcoming events
                    loadEvents('my');       // Refresh my events
                } else {
                    showMessage(result.error || 'Failed to cancel sign-up.', 'error');
                }
            } catch (error) {
                console.error('Cancel sign-up error:', error);
                showMessage('Failed to cancel sign-up due to network error. Please try again.', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }


        // --- Venue Loading & Display ---
        async function loadVenues() {
            const container = document.getElementById('venuesContainer');
            container.innerHTML = '<div class="loading">Loading venues...</div>';

            try {
                const response = await fetch('/.netlify/functions/get-venues-member', {
                    headers: { 'Authorization': `Bearer ${memberToken}` }
                });

                if (response.status === 401) {
                    showLogin();
                    showMessage('Your session has expired. Please log in again.', 'error');
                    return;
                }
                if (!response.ok) throw new Error('Failed to load venues');

                const data = await response.json();
                allVenues = data.venues || [];
                renderVenues(container);

            } catch (error) {
                console.error('Error loading venues:', error);
                container.innerHTML = `<div class="error">Failed to load venues. ${error.message}</div>`;
            }
        }

        function renderVenues(container) {
            if (allVenues.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No venues found</h3>
                        <p>Currently no venues are listed. Check back later!</p>
                    </div>
                `;
                return;
            }

            const venuesHTML = allVenues.map(venue => `
                <div class="venue-card">
                    <div class="venue-name">${venue.name}</div>
                    <div class="venue-detail"><strong>Address:</strong> ${venue.address}</div>
                    ${venue.phone ? `<div class="venue-detail"><strong>Phone:</strong> ${venue.phone}</div>` : ''}
                    ${venue.website ? `<div class="venue-detail"><strong>Website:</strong> <a href="${venue.website}" target="_blank" style="color: #e74c3c;">Visit Site</a></div>` : ''}
                    ${venue.notes ? `<div class="venue-detail"><strong>Notes:</strong> ${venue.notes}</div>` : ''}
                </div>
            `).join('');
            container.innerHTML = `<div class="venues-grid">${venuesHTML}</div>`;
        }


        // Initial check on page load
        document.addEventListener('DOMContentLoaded', checkAuth);

        // Expose functions to global scope for onclick attributes
        window.switchTab = switchTab;
        window.signUpForEvent = signUpForEvent;
        window.cancelSignUp = cancelSignUp;
    </script>
</body>
</html>
