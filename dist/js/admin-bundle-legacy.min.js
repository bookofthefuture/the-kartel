System.register(["../notification-manager-legacy-DZahIPu6.min.js"],function(e,t){"use strict";return{setters:[null],execute:function(){let e=localStorage.getItem("kartel_admin_token"),t=[],n=[],o=[],a=null;function i(e){if(!e)return"";const t=e.trim();if(!t)return"";const n=[/^https?:\/\/(www\.)?linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?linkedin\.com\/pub\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?uk\.linkedin\.com\/pub\/([a-zA-Z0-9\-]+)\/?.*$/,/^linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^www\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^www\.uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^([a-zA-Z0-9\-]+)$/];for(const a of n){const e=t.match(a);if(e)return e[2]||e[1]}const o=t.match(/(uk\.)?linkedin\.com\/in\/([a-zA-Z0-9\-]+)/);return o?o[2]:(/^[a-zA-Z0-9\-]+$/.test(t),t)}function s(e,t="success",n="messageContainer"){const o=document.getElementById(n);o.innerHTML=`<div class="${t}">${e}</div>`,setTimeout(()=>o.innerHTML="",5e3)}function d(e,t="messageContainer"){s(e,"error",t)}async function r(){try{const t=await fetch("/.netlify/functions/get-venues",{headers:{Authorization:`Bearer ${e}`}});if(401===t.status)return e=null,localStorage.removeItem("kartel_admin_token"),void I();if(!t.ok)throw new Error("Failed to load venues");const n=await t.json();o=n.venues||[],function(){const e=o.length,t=o.filter(e=>{const t=new Date(e.createdAt),n=new Date;return t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()}).length;document.getElementById("totalVenues").textContent=e,document.getElementById("activeVenues").textContent=e,document.getElementById("venuesWithEvents").textContent=0,document.getElementById("recentVenues").textContent=t}(),c()}catch(t){console.error("Error loading venues:",t),d("Failed to load venues. Please try again.","venuesMessageContainer")}}async function l(){try{const t=await fetch("/.netlify/functions/get-venues",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=await t.json();o=e.venues||[],function(){const e=document.getElementById("eventVenue");for(;e.children.length>2;)e.removeChild(e.lastChild);o.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})}()}}catch(t){console.error("Error loading venues for dropdown:",t)}}function c(e=null){const t=document.getElementById("venuesContainer"),n=e||o;if(0===n.length)return void(t.innerHTML='\n            <div class="search-container">\n                <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()">\n            </div>\n            <div class="empty-state">\n                <h3>No venues found</h3>\n                <p>Start by adding your first karting venue to manage events effectively.</p>\n                <button class="btn btn-success" onclick="openAddVenueModal()">Add Your First Venue</button>\n            </div>\n        ');const a=n.map(e=>`\n        <div class="venue-card">\n            <div class="venue-name">${e.name}</div>\n            <div class="venue-details">\n                <div class="venue-detail"><strong>Address:</strong> ${e.address}</div>\n                ${e.phone?`<div class="venue-detail"><strong>Phone:</strong> ${e.phone}</div>`:""}\n                ${e.website?`<div class="venue-detail"><strong>Website:</strong> <a href="${e.website}" target="_blank" style="color: #e74c3c;">Visit Site</a></div>`:""}\n                ${e.notes?`<div class="venue-detail"><strong>Notes:</strong> ${e.notes}</div>`:""}\n                ${e.drivingTips?`<div class="venue-detail"><strong>Driving Tips:</strong> ${e.drivingTips.substring(0,100)}${e.drivingTips.length>100?"...":""}</div>`:""}\n                ${e.vimeoId?`<div class="venue-detail"><strong>Video:</strong> <a href="https://vimeo.com/${e.vimeoId}" target="_blank" style="color: #e74c3c;">Watch on Vimeo</a></div>`:""}\n                ${e.trackMapPath?'<div class="venue-detail"><strong>Track Map:</strong> <span style="color: #27ae60;">✓ Available</span></div>':""}\n                <div class="venue-detail"><strong>Added:</strong> ${new Date(e.createdAt).toLocaleDateString()}</div>\n            </div>\n            <div class="venue-actions">\n                <button class="action-btn edit-btn btn-small" onclick="editVenue('${e.id}')">Edit</button>\n                <button class="action-btn delete-btn btn-small" onclick="deleteVenue('${e.id}')">Delete</button>\n            </div>\n        </div>\n    `).join("");t.innerHTML=`\n        <div class="search-container">\n            <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()" value="${document.getElementById("venueSearch")?.value||""}">\n        </div>\n        <div class="venues-grid">${a}</div>\n    `}function u(){a=null,document.getElementById("modalTitle").textContent="Add New Venue",document.getElementById("venueForm").reset(),document.getElementById("trackMapPreview").style.display="none",document.getElementById("vimeoPreview").style.display="none",document.getElementById("vimeoPreview").querySelector("iframe").src="",document.getElementById("venueModal").style.display="block"}function m(){document.getElementById("venueModal").style.display="none",a=null}async function p(){try{const n=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:`Bearer ${e}`}});if(401===n.status)return e=null,localStorage.removeItem("kartel_admin_token"),void I();if(!n.ok)throw new Error("Failed to load applications");const o=await n.json();t=o.applications||[],function(){const e=t.length,n=t.filter(e=>"pending"===e.status).length,o=t.filter(e=>"approved"===e.status).length,a=t.filter(e=>"rejected"===e.status).length;document.getElementById("totalApplications").textContent=e,document.getElementById("pendingApplications").textContent=n,document.getElementById("approvedApplications").textContent=o,document.getElementById("rejectedApplications").textContent=a}(),function(){const e=document.getElementById("applicationsTableBody");0!==t.length?e.innerHTML=t.map(e=>`\n        <tr>\n            <td>\n                <strong>${e.fullName||`${e.firstName||""} ${e.lastName||""}`.trim()||e.name||"N/A"}</strong>\n                ${e.isAdmin?'<br><span style="color: #e74c3c; font-weight: bold; font-size: 12px;">👑 Administrator</span>':""}\n                ${e.importedAt?'<br><small style="color: #6c757d;">📥 Imported</small>':""}\n            </td>\n            <td>${e.email}</td>\n            <td>\n                <strong>${e.company||"N/A"}</strong>\n                ${e.position?`<br><small>${e.position}</small>`:""}\n            </td>\n            <td>${e.phone}</td>\n            <td>\n                ${e.linkedin?`<a href="https://linkedin.com/in/${e.linkedin}" target="_blank" style="color: #0077b5; text-decoration: none;">🔗 ${e.linkedin}</a>`:"N/A"}\n            </td>\n            <td><span class="status-badge status-${e.status}">${e.status}</span></td>\n            <td>${new Date(e.submittedAt).toLocaleDateString()}</td>\n            <td>\n                ${"pending"===e.status?`\n                    <button class="action-btn approve-btn" onclick="updateApplication('${e.id}', 'approved')">Approve</button>\n                    <button class="action-btn reject-btn" onclick="updateApplication('${e.id}', 'rejected')">Reject</button>\n                `:""}\n                <button class="action-btn details-btn" onclick="showDetails('${e.id}')">Details</button>\n                <button class="action-btn delete-btn" onclick="deleteApplication('${e.id}')">Delete</button>\n            </td>\n        </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="8" class="loading">No applications found</td></tr>'}()}catch(n){console.error("Error loading applications:",n),d("Failed to load applications. Please try again.")}}async function g(){try{const t=await fetch("/.netlify/functions/get-events",{headers:{Authorization:`Bearer ${e}`}});if(401===t.status)return e=null,localStorage.removeItem("kartel_admin_token"),void I();if(!t.ok)throw new Error("Failed to load events");const o=await t.json();n=o.events||[],function(){const e=n.length,t=n.filter(e=>"upcoming"===e.status).length,o=n.filter(e=>"completed"===e.status).length,a=n.reduce((e,t)=>e+(t.photos?t.photos.length:0),0);document.getElementById("totalEvents").textContent=e,document.getElementById("upcomingEvents").textContent=t,document.getElementById("completedEvents").textContent=o,document.getElementById("totalPhotos").textContent=a}(),function(){const e=document.getElementById("eventsTableBody");0!==n.length?e.innerHTML=n.map(e=>`\n        <tr>\n            <td><strong>${e.name}</strong></td>\n            <td>${new Date(e.date).toLocaleDateString()}${e.time?`<br><small>${e.time}</small>`:""}</td>\n            <td><strong>${e.venue}</strong></td>\n            <td>\n                <span class="status-badge status-approved">${e.attendees?e.attendees.length:0}</span>\n                ${e.attendees&&e.attendees.length>0?`<br><small>${e.attendees.filter(e=>e.attended).length} attended</small>`:""}\n            </td>\n            <td><span class="status-badge status-approved">${e.photos?e.photos.length:0}</span></td>\n            <td><span class="status-badge status-pending">${e.videos?e.videos.length:0}</span></td>\n            <td><span class="status-badge status-${e.status}">${e.status}</span></td>\n            <td>\n                <button class="action-btn edit-btn" onclick="editEvent('${e.id}')">Edit</button>\n                <button class="action-btn delete-btn" onclick="deleteEvent('${e.id}')">Delete</button>\n            </td>\n        </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="8" class="loading">No events found</td></tr>'}()}catch(t){console.error("Error loading events:",t),d("Failed to load events. Please try again.","eventsMessageContainer")}}async function v(t){try{const n=await fetch("/.netlify/functions/get-events",{headers:{Authorization:`Bearer ${e}`}});if(n.ok){const e=(await n.json()).events.find(e=>e.id===t);e&&e.photos?y(e.photos):y([])}}catch(n){console.error("Error loading event photos:",n)}}function y(e){const t=document.getElementById("eventPhotosGrid");if(!e||0===e.length)return void(t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No photos uploaded yet</p>');const n=e.map(e=>`\n        <div class="photo-item">\n            <img src="/.netlify/functions/get-photo?path=${encodeURIComponent(e.path)}" \n                alt="${e.caption||"Event photo"}"\n                onerror="this.style.display='none'">\n            ${e.caption?`<div class="photo-caption">${e.caption}</div>`:""}\n        </div>\n    `).join("");t.innerHTML=n}async function f(t){try{const n=await fetch("/.netlify/functions/get-events",{headers:{Authorization:`Bearer ${e}`}});if(n.ok){const e=(await n.json()).events.find(e=>e.id===t);e&&e.videos?h(e.videos):h([])}}catch(n){console.error("Error loading event videos:",n)}}function h(e){const t=document.getElementById("eventVideosGrid");if(!e||0===e.length)return void(t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No videos uploaded yet</p>');const n=e.map(e=>`\n        <div style="border: 1px solid #ecf0f1; border-radius: 8px; padding: 15px; background: white;">\n            <div style="aspect-ratio: 16/9; margin-bottom: 10px;">\n                <iframe src="https://player.vimeo.com/video/${e.vimeoId}" \n                        width="100%" height="100%" frameborder="0" \n                        allow="autoplay; fullscreen; picture-in-picture" allowfullscreen\n                        style="border-radius: 4px;">\n                </iframe>\n            </div>\n            <h5 style="color: #2c3e50; margin-bottom: 5px; font-size: 1rem;">${e.title||"Untitled Video"}</h5>\n            ${e.description?`<p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 8px;">${e.description}</p>`:""}\n            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #999;">\n                <span>Uploaded: ${new Date(e.uploadedAt).toLocaleDateString()}</span>\n                <a href="https://vimeo.com/${e.vimeoId}" target="_blank" style="color: #3498db;">View on Vimeo</a>\n            </div>\n        </div>\n    `).join("");t.innerHTML=n}function E(){document.getElementById("eventModal").style.display="none";const e=document.querySelector(".email-section");e&&(e.style.display="none")}function w(){document.getElementById("applicantModal").style.display="none"}function I(){document.getElementById("loginSection").classList.remove("hidden"),document.getElementById("dashboardSection").classList.add("hidden")}async function b(){const t=new URLSearchParams(window.location.search),n=t.get("action"),o=t.get("id"),a=t.get("token");n&&o&&a&&(console.log(`🚀 Processing quick action from URL: ${n} for ${o}`),window.history.replaceState({},document.title,window.location.pathname),await async function(t,n,o){try{s("Processing quick action...","info","messageContainer");const a=await fetch("/.netlify/functions/quick-action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t,applicationId:n,actionToken:o})}),i=await a.json();if(a.ok&&i.success){const n="approve"===t?"approved":"rejected";s(`✅ Application from ${i.application?.name||"applicant"} has been ${n} successfully!`,"success","messageContainer"),e&&p()}else s(`❌ Quick action failed: ${i.error||"Unknown error"}`,"error","messageContainer")}catch(a){console.error("Quick action error:",a),s("❌ Quick action failed due to network error","error","messageContainer")}}(n,o,a))}async function B(){try{const t=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=(await t.json()).applications.filter(e=>"approved"===e.status);return function(e){const t=document.getElementById("memberSelect");for(;t.children.length>1;)t.removeChild(t.lastChild);e.forEach(e=>{const n=document.createElement("option");n.value=e.id;const o=e.fullName||`${e.firstName||""} ${e.lastName||""}`.trim()||e.name||"Unknown";n.textContent=`${o} (${e.company||"No company"})`,n.dataset.email=e.email,n.dataset.company=e.company||"",t.appendChild(n)})}(e),e}}catch(t){console.error("Error loading approved members:",t)}return[]}async function C(e,t){try{const o=n.findIndex(t=>t.id===e);if(-1===o)return;n[o].attendees||(n[o].attendees=[]),n[o].attendees.push(t),await $(e,n[o].attendees),M(n[o].attendees),s("Attendee added successfully!","success","eventsMessageContainer")}catch(o){console.error("Error adding attendee:",o),d("Failed to add attendee. Please try again.","eventsMessageContainer")}}async function $(t,n){const o=await fetch("/.netlify/functions/update-event",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:t,updates:{attendees:n}})});if(!o.ok)throw new Error("Failed to update event attendees");return await o.json()}function M(e){const t=document.getElementById("attendeesList");if(!e||0===e.length)return t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No attendees added yet</p>',void A(0,0,0);const n=e.filter(e=>e.attended).length,o=e.filter(e=>!e.attended).length;A(e.length,n,o);const a=e.map(e=>`\n        <div class="attendee-item">\n            <div class="attendee-info">\n                <div class="attendee-name">${e.name}</div>\n                <div class="attendee-details">\n                    ${e.company?`${e.company} • `:""}${e.email}\n                    <br><small>Registered: ${new Date(e.registeredAt).toLocaleDateString()}</small>\n                </div>\n            </div>\n            <div class="attendee-status">\n                <span style="font-size: 0.8rem; margin-right: 8px;">\n                    ${e.attended?"Attended":"Registered"}\n                </span>\n                <div class="status-toggle ${e.attended?"attended":""}" \n                    onclick="toggleAttendeeStatus('${document.getElementById("editEventId").value}', '${e.memberId}')">\n                </div>\n                <button class="remove-attendee" \n                        onclick="removeAttendeeFromEvent('${document.getElementById("editEventId").value}', '${e.memberId}')">\n                    Remove\n                </button>\n            </div>\n        </div>\n    `).join("");t.innerHTML=a}function A(e,t,n){document.getElementById("registeredCount").textContent=e,document.getElementById("attendedCount").textContent=t,document.getElementById("noShowCount").textContent=n}async function x(e){const t=n.find(t=>t.id===e);t&&t.attendees?M(t.attendees):M([])}document.getElementById("photoUpload").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("photoPreview"),o=document.getElementById("uploadPhotoBtn");if(t){const e=new FileReader;e.onload=function(e){n.src=e.target.result,n.style.display="block",o.disabled=!1},e.readAsDataURL(t)}else n.style.display="none",o.disabled=!0}),document.getElementById("uploadPhotoBtn").addEventListener("click",async function(){const t=document.getElementById("photoUpload"),n=document.getElementById("photoCaption"),o=document.getElementById("editEventId").value;if(!t.files[0]||!o)return void d("Please select a photo and ensure an event is selected","eventsMessageContainer");const a=t.files[0],i=n.value.trim(),r=new FileReader;r.onload=async function(r){const l=r.target.result,c=document.getElementById("uploadPhotoBtn"),u=c.textContent;c.textContent="Uploading...",c.disabled=!0;try{const r=await fetch("/.netlify/functions/upload-photo",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:o,photoData:l,fileName:a.name,caption:i})}),c=await r.json();r.ok&&c.success?(s("Photo uploaded successfully!","success","eventsMessageContainer"),t.value="",n.value="",document.getElementById("photoPreview").style.display="none",await v(o),g()):d(c.error||"Failed to upload photo","eventsMessageContainer")}catch(m){console.error("Photo upload error:",m),d("Failed to upload photo. Please try again.","eventsMessageContainer")}finally{c.textContent=u,c.disabled=!1}},r.readAsDataURL(a)}),document.getElementById("videoUpload").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("videoPreview"),o=document.getElementById("uploadVideoBtn");if(t){const a=524288e3;if(t.size>a)return d("Video file size must be less than 500MB","eventsMessageContainer"),void(e.target.value="");const i=URL.createObjectURL(t);n.src=i,n.style.display="block",o.disabled=!1;const s=document.getElementById("videoTitle");s.value||(s.value=t.name.replace(/\.[^/.]+$/,""))}else n.style.display="none",o.disabled=!0}),document.getElementById("uploadVideoBtn").addEventListener("click",async function(){const t=document.getElementById("videoUpload"),n=document.getElementById("videoTitle"),o=document.getElementById("videoDescription"),a=document.getElementById("editEventId").value;if(!t.files[0]||!a)return void d("Please select a video and ensure an event is selected","eventsMessageContainer");const i=t.files[0],r=n.value.trim()||i.name,l=o.value.trim(),c=this,u=c.textContent,m=document.getElementById("uploadProgress"),p=document.getElementById("progressBar");c.textContent="Preparing Upload...",c.disabled=!0,m.style.display="block",p.style.width="10%";try{const v=new FileReader;v.onload=async function(v){const y=v.target.result;p.style.width="30%",c.textContent="Uploading to Vimeo...";try{const c=await fetch("/.netlify/functions/upload-video-vimeo",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:a,videoData:y,fileName:i.name,title:r,description:l})});p.style.width="90%";const u=await c.json();c.ok&&u.success?(p.style.width="100%",s(`Video uploaded successfully to Vimeo! <a href="${u.vimeoUrl}" target="_blank">View Video</a>`,"success","eventsMessageContainer"),t.value="",n.value="",o.value="",document.getElementById("videoPreview").style.display="none",await f(a),g()):d(u.error||"Failed to upload video to Vimeo","eventsMessageContainer")}catch(h){console.error("Video upload error:",h),d("Failed to upload video. Please try again.","eventsMessageContainer")}finally{c.textContent=u,c.disabled=!1,m.style.display="none",p.style.width="0%"}},v.readAsDataURL(i)}catch(v){console.error("Video processing error:",v),d("Failed to process video file. Please try again.","eventsMessageContainer"),c.textContent=u,c.disabled=!1,m.style.display="none"}}),document.addEventListener("DOMContentLoaded",function(){b(),console.log("📝 Admin.js loaded - authentication handled by unified system"),document.getElementById("refreshBtn").addEventListener("click",p),document.getElementById("refreshEventsBtn").addEventListener("click",g),document.getElementById("refreshVenuesBtn").addEventListener("click",r),document.getElementById("recoverBtn").addEventListener("click",async()=>{if(!confirm("⚠️ RECOVER DATA\n\nThis will attempt to rebuild the applications list from individual member records.\n\nThis is safe to run and will not delete any data.\n\nProceed?"))return;const t=document.getElementById("recoverBtn"),n=t.textContent;t.textContent="🔄 Recovering...",t.disabled=!0;try{const t=await fetch("/.netlify/functions/recover-applications-list",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),n=await t.json();t.ok&&n.success?(s(`✅ Recovery successful! Recovered ${n.recovered} members. Status: ${JSON.stringify(n.statusBreakdown)}`,"success"),setTimeout(()=>{p()},1e3)):d(`❌ Recovery failed: ${n.error||"Unknown error"}`)}catch(o){console.error("Recovery error:",o),d("❌ Recovery failed due to network error")}finally{t.textContent=n,t.disabled=!1}}),document.getElementById("venueForm").addEventListener("submit",async function(t){t.preventDefault();const n=new FormData(this),o={name:n.get("venueName").trim(),address:n.get("venueAddress").trim(),phone:n.get("venuePhone").trim(),website:n.get("venueWebsite").trim(),notes:n.get("venueNotes").trim(),drivingTips:n.get("venueDrivingTips").trim(),vimeoId:n.get("venueVimeoId").trim()},i=n.get("venueTrackMap");if(i&&i.size>0){const e=new FileReader,t=await new Promise((t,n)=>{e.onload=e=>t(e.target.result),e.onerror=n,e.readAsDataURL(i)});o.trackMap={data:t,fileName:i.name,fileType:i.type}}if(!o.name||!o.address)return void d("Please fill in all required fields","venuesMessageContainer");const c=this.querySelector('button[type="submit"]'),u=c.textContent;c.textContent="Saving...",c.disabled=!0;try{let t;t=a?await fetch("/.netlify/functions/update-venue",{method:"PUT",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({venueId:a,...o})}):await fetch("/.netlify/functions/create-venue",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(o)});const n=await t.json();t.ok&&n.success?(s(n.message,"success","venuesMessageContainer"),m(),r(),l()):d(n.error||"Failed to save venue","venuesMessageContainer")}catch(p){console.error("Error saving venue:",p),d("Failed to save venue. Please try again.","venuesMessageContainer")}finally{c.textContent=u,c.disabled=!1}}),document.getElementById("venueTrackMap").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("trackMapPreview"),o=document.getElementById("trackMapImage");if(t){const e=new FileReader;e.onload=function(e){o.src=e.target.result,n.style.display="block"},e.readAsDataURL(t)}else n.style.display="none"}),document.getElementById("venueVimeoId").addEventListener("input",function(e){const t=e.target.value.trim(),n=document.getElementById("vimeoPreview"),o=n.querySelector("iframe");t&&/^\d+$/.test(t)?(o.src=`https://player.vimeo.com/video/${t}`,n.style.display="block"):(n.style.display="none",o.src="")}),document.getElementById("seedVenuesBtn").addEventListener("click",async function(){if(!confirm("This will add default venues if none exist. Continue?"))return;const t=this,n=t.textContent;t.textContent="Seeding...",t.disabled=!0;try{const t=await fetch("/.netlify/functions/seed-venues",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),n=await t.json();t.ok?(s(n.message,"success","venuesMessageContainer"),n.success&&(r(),l())):d(n.error||"Failed to seed venues","venuesMessageContainer")}catch(o){console.error("Error seeding venues:",o),d("Failed to seed venues. Please try again.","venuesMessageContainer")}finally{t.textContent=n,t.disabled=!1}}),document.getElementById("eventVenue").addEventListener("change",function(){"add-new"===this.value&&(u(),this.value="")}),document.getElementById("eventForm").addEventListener("submit",async function(e){e.preventDefault();const t=new FormData(e.target),n=t.get("eventVenue");if(!n)return void d("Please select a venue","eventsMessageContainer");const a=o.find(e=>e.id===n),i={name:t.get("eventName"),date:t.get("eventDate"),time:t.get("eventTime"),venueId:n,venue:a?a.name:"",venueAddress:a?a.address:"",maxAttendees:t.get("eventMaxAttendees"),description:t.get("eventDescription"),sendAnnouncement:"on"===t.get("sendAnnouncement")};await async function(e){z=e,document.getElementById("confirmEventName").textContent=e.name||"Not specified",document.getElementById("confirmEventDate").textContent=e.date?new Date(e.date).toLocaleDateString():"Not specified",document.getElementById("confirmEventTime").textContent=e.time||"Not specified",document.getElementById("confirmEventVenue").textContent=e.venue||"Not specified",document.getElementById("confirmEventMaxAttendees").textContent=e.maxAttendees||"No limit",document.getElementById("confirmEventDescription").textContent=e.description||"No description";const t=document.getElementById("announcementInfo"),n=document.getElementById("confirmButtonText");if(e.sendAnnouncement){t.style.display="block",n.textContent="Confirm & Send";try{const e=await U();document.getElementById("approvedMemberCount").textContent=e}catch(o){console.error("Error loading approved members count:",o),document.getElementById("approvedMemberCount").textContent="Unknown"}}else t.style.display="none",n.textContent="Confirm & Create Event";document.getElementById("eventConfirmationModal").style.display="block"}(i)}),document.getElementById("editEventForm").addEventListener("submit",async function(t){t.preventDefault();const n=new FormData(this),a=n.get("editEventId"),i=n.get("editEventVenue");if(!i)return void d("Please select a venue","eventsMessageContainer");const r=o.find(e=>e.id===i),l={name:n.get("editEventName"),date:n.get("editEventDate"),time:n.get("editEventTime"),venueId:i,venue:r?r.name:"",venueAddress:r?r.address:"",maxAttendees:n.get("editEventMaxAttendees"),status:n.get("editEventStatus"),description:n.get("editEventDescription")},c=this.querySelector('button[type="submit"]'),u=c.textContent;c.textContent="Updating...",c.disabled=!0;try{const t=await fetch("/.netlify/functions/update-event",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:a,updates:l})}),n=await t.json();t.ok&&n.success?(s("Event updated successfully!","success","eventsMessageContainer"),E(),g()):d(n.error||"Failed to update event","eventsMessageContainer")}catch(m){console.error("Event update error:",m),d("Failed to update event. Please try again.","eventsMessageContainer")}finally{c.textContent=u,c.disabled=!1}}),document.getElementById("applicantForm").addEventListener("submit",async function(t){t.preventDefault();const n=new FormData(this),o={applicationId:n.get("applicantId"),firstName:n.get("applicantFirstName").trim(),lastName:n.get("applicantLastName").trim(),email:n.get("applicantEmail").trim(),company:n.get("applicantCompany").trim(),position:n.get("applicantPosition").trim(),phone:n.get("applicantPhone").trim(),linkedin:i(n.get("applicantLinkedin")),status:n.get("applicantStatus"),isAdmin:document.getElementById("applicantIsAdmin").checked};if(!o.firstName||!o.lastName||!o.email)return void s("First name, last name, and email are required.","error","applicantMessage");const a=this.querySelector('button[type="submit"]'),d=a.textContent;a.textContent="Saving...",a.disabled=!0;try{const t=await async function(t){try{const n=await fetch("/.netlify/functions/update-applicant-details",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(401===n.status)return e=null,localStorage.removeItem("kartel_admin_token"),I(),!1;const o=await n.json();return n.ok&&o.success?(s("Applicant details updated successfully!","success","messageContainer"),p(),!0):(s(o.error||"Failed to update applicant details.","error","applicantMessage"),!1)}catch(n){return console.error("Error updating applicant details:",n),s("Failed to update applicant details due to network error. Please try again.","error","applicantMessage"),!1}}(o);t&&setTimeout(()=>{w()},2e3)}finally{a.textContent=d,a.disabled=!1}}),document.getElementById("confirmCreateEventBtn").addEventListener("click",async function(){await async function(){if(!z)return void d("No event data found","eventsMessageContainer");const t=document.getElementById("confirmCreateEventBtn"),n=t.innerHTML;t.innerHTML="Creating...",t.disabled=!0;try{const t=await fetch("/.netlify/functions/create-event",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(z)}),n=await t.json();t.ok&&n.success?(O(),s("Event created successfully!","success","eventsMessageContainer"),document.getElementById("eventForm").reset(),g()):d(n.error||"Failed to create event","eventsMessageContainer")}catch(o){console.error("Event creation error:",o),d("Failed to create event. Please try again.","eventsMessageContainer")}finally{t.innerHTML=n,t.disabled=!1}}()}),document.getElementById("sendTestEmailBtn").addEventListener("click",async function(){await async function(){if(!z)return void d("No event data found","eventsMessageContainer");let t=null;try{const e=localStorage.getItem("kartel_admin_user");e&&(t=JSON.parse(e).email)}catch(a){console.error("Error getting stored user data:",a)}if(!t){if(t=prompt("Enter your email address for the test email:"),!t)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return void d("Please enter a valid email address","eventsMessageContainer")}const n=document.getElementById("sendTestEmailBtn"),o=n.textContent;n.textContent="Sending...",n.disabled=!0;try{const n={...z,id:`test-${Date.now()}`,createdAt:(new Date).toISOString()},o=await fetch("/.netlify/functions/send-test-email",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:n.id,adminEmail:t,eventData:n})}),a=await o.json();o.ok&&a.success?s(`Test email sent successfully to ${t}!`,"success","eventsMessageContainer"):d(a.error||"Failed to send test email","eventsMessageContainer")}catch(a){console.error("Test email error:",a),d("Failed to send test email. Please try again.","eventsMessageContainer")}finally{n.textContent=o,n.disabled=!1}}()}),window.onclick=function(e){const t=document.getElementById("venueModal"),n=document.getElementById("eventModal"),o=document.getElementById("applicantModal"),a=document.getElementById("eventConfirmationModal");e.target===t&&m(),e.target===n&&E(),e.target===o&&w(),e.target===a&&O()};const t=document.getElementById("videoUpload"),n=document.getElementById("videoTitle"),c=document.getElementById("videoDescription"),v=document.getElementById("videoPreview"),y=document.getElementById("uploadVideoBtn"),h=document.getElementById("uploadProgress"),B=document.getElementById("progressBar");t.addEventListener("change",function(e){const o=e.target.files[0];if(!o)return v.style.display="none",void(y.disabled=!0);if(o.size>524288e3)return alert("File size must be less than 500MB"),t.value="",v.style.display="none",void(y.disabled=!0);if(!["video/mp4","video/mov","video/quicktime","video/avi"].includes(o.type))return alert("Please select a valid video file (MP4, MOV, AVI)"),t.value="",v.style.display="none",void(y.disabled=!0);const a=URL.createObjectURL(o);v.src=a,v.style.display="block",y.disabled=!1,n.value||(n.value=o.name.replace(/\.[^/.]+$/,""))}),y.addEventListener("click",async function(){const o=t.files[0];if(!o)return;const a=document.getElementById("editEventId").value;if(!a)return void alert("Please save the event first before uploading videos");const i=n.value.trim()||o.name,r=c.value.trim();h.style.display="block",y.disabled=!0,y.textContent="Uploading...",B.style.width="10%";try{const d=await new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=t,n.readAsDataURL(o)});B.style.width="30%";const l=await fetch("/.netlify/functions/upload-video-vimeo",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:a,videoData:d,fileName:o.name,title:i,description:r})});if(B.style.width="80%",!l.ok){const e=await l.json();throw new Error(e.error||"Upload failed")}const u=await l.json();if(B.style.width="100%",!u.success)throw new Error(u.error||"Upload failed");s("Video uploaded to Vimeo successfully!","success","eventsMessageContainer"),t.value="",n.value="",c.value="",v.style.display="none",f(a),g()}catch(l){console.error("Video upload error:",l),d(`Video upload failed: ${l.message}`,"eventsMessageContainer")}finally{h.style.display="none",y.disabled=!1,y.textContent="Upload to Vimeo",B.style.width="0%"}}),console.log("🔧 Admin.js loaded, waiting for unified auth...")}),document.getElementById("memberSelect").addEventListener("change",function(){document.getElementById("addAttendeeBtn").disabled=!this.value}),document.getElementById("addAttendeeBtn").addEventListener("click",function(){const e=document.getElementById("memberSelect"),t=e.options[e.selectedIndex];if(!t.value)return;const o=document.getElementById("editEventId").value,a=t.value,i=t.textContent.split(" (")[0],s=t.dataset.email,r=t.dataset.company,l=n.find(e=>e.id===o),c=l.attendees?.find(e=>e.memberId===a);c?d("This member is already added to the event","eventsMessageContainer"):(C(o,{memberId:a,name:i,email:s,company:r,registeredAt:(new Date).toISOString(),attended:!1}),e.value="",document.getElementById("addAttendeeBtn").disabled=!0)}),window.switchTab=function(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),document.getElementById(e+"Tab").classList.add("active"),event.target.classList.add("active"),"applications"===e?p():"events"===e?(g(),l()):"venues"===e?r():"content"===e&&(F(),L(),j())},window.openAddVenueModal=u,window.closeVenueModal=m,window.editVenue=function(e){const t=o.find(t=>t.id===e);if(!t)return;a=e,document.getElementById("modalTitle").textContent="Edit Venue",document.getElementById("venueId").value=t.id,document.getElementById("venueName").value=t.name,document.getElementById("venueAddress").value=t.address,document.getElementById("venuePhone").value=t.phone||"",document.getElementById("venueWebsite").value=t.website||"",document.getElementById("venueNotes").value=t.notes||"",document.getElementById("venueDrivingTips").value=t.drivingTips||"",document.getElementById("venueVimeoId").value=t.vimeoId||"";const n=document.getElementById("trackMapPreview"),i=document.getElementById("trackMapImage");t.trackMapPath?(i.src=`/.netlify/functions/get-photo?path=${encodeURIComponent(t.trackMapPath)}`,n.style.display="block"):n.style.display="none";const s=document.getElementById("vimeoPreview"),d=s.querySelector("iframe");t.vimeoId&&/^\d+$/.test(t.vimeoId)?(d.src=`https://player.vimeo.com/video/${t.vimeoId}`,s.style.display="block"):(s.style.display="none",d.src=""),document.getElementById("venueModal").style.display="block"},window.deleteVenue=async function(t){const n=o.find(e=>e.id===t);if(n&&confirm(`Are you sure you want to delete "${n.name}"?`))try{const n=await fetch("/.netlify/functions/delete-venue",{method:"DELETE",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({venueId:t})}),o=await n.json();n.ok&&o.success?(s(o.message,"success","venuesMessageContainer"),r(),l()):d(o.error||"Failed to delete venue","venuesMessageContainer")}catch(a){console.error("Error deleting venue:",a),d("Failed to delete venue. Please try again.","venuesMessageContainer")}},window.filterVenues=function(){const e=document.getElementById("venueSearch").value.toLowerCase();e.trim()?c(o.filter(t=>t.name.toLowerCase().includes(e)||t.address.toLowerCase().includes(e)||t.notes&&t.notes.toLowerCase().includes(e)||t.drivingTips&&t.drivingTips.toLowerCase().includes(e))):c()},window.updateApplication=async function(t,n){try{if(!(await fetch("/.netlify/functions/update-application",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({applicationId:t,status:n,sendEmail:!0})})).ok)throw new Error("Failed to update application");s(`Application ${n} successfully! Email sent to applicant.`),p()}catch(o){console.error("Error updating application:",o),d("Failed to update application. Please try again.")}},window.deleteApplication=async function(n){const o=t.find(e=>e.id===n);if(!o)return;const a=o.fullName||`${o.firstName||""} ${o.lastName||""}`.trim()||"Unknown";if(confirm(`Are you sure you want to permanently delete the application for ${a}?`))try{if(!(await fetch("/.netlify/functions/delete-application",{method:"DELETE",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({applicationId:n})})).ok)throw new Error("Failed to delete application");s(`Application for ${a} deleted successfully.`),p()}catch(i){console.error("Error deleting application:",i),d("Failed to delete application. Please try again.")}},window.showDetails=function(e){const n=t.find(t=>t.id===e);if(!n)return;document.getElementById("applicantId").value=n.id,document.getElementById("applicantFirstName").value=n.firstName||"",document.getElementById("applicantLastName").value=n.lastName||"",document.getElementById("applicantEmail").value=n.email||"",document.getElementById("applicantCompany").value=n.company||"",document.getElementById("applicantPosition").value=n.position||"",document.getElementById("applicantPhone").value=n.phone||"",document.getElementById("applicantLinkedin").value=n.linkedin||"",document.getElementById("applicantOriginalMessage").value=n.message||"",document.getElementById("applicantStatus").value=n.status||"pending",document.getElementById("applicantSubmitted").value=new Date(n.submittedAt).toLocaleString(),document.getElementById("applicantIsAdmin").checked=n.isAdmin||!1;const o=document.getElementById("applicantMessage");o&&(o.classList.add("hidden"),o.textContent=""),document.getElementById("applicantModal").style.display="block"},window.editEvent=function(t){const a=n.find(e=>e.id===t);if(!a)return void d("Event not found","eventsMessageContainer");if(document.getElementById("editEventId").value=a.id,document.getElementById("editEventName").value=a.name,document.getElementById("editEventDate").value=a.date,document.getElementById("editEventTime").value=a.time||"",document.getElementById("editEventMaxAttendees").value=a.maxAttendees||"",document.getElementById("editEventStatus").value=a.status||"upcoming",document.getElementById("editEventDescription").value=a.description||"",function(){const e=document.getElementById("editEventVenue");for(;e.children.length>1;)e.removeChild(e.lastChild);o.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})}(),a.venueId)document.getElementById("editEventVenue").value=a.venueId;else{const e=Array.from(document.getElementById("editEventVenue").options).find(e=>e.textContent===a.venue);e&&(document.getElementById("editEventVenue").value=e.value)}v(a.id),f(a.id),x(a.id),B(),async function(){try{const e=await U();document.getElementById("modalApprovedMemberCount").textContent=e}catch(e){console.error("Error loading member count for modal:",e),document.getElementById("modalApprovedMemberCount").textContent="Unknown"}}(),function(t){const o=document.getElementById("sendAnnouncementEmailBtn"),a=document.getElementById("sendReminderEmailBtn"),i=document.getElementById("modalSendTestEmailBtn"),r=o.cloneNode(!0),l=a.cloneNode(!0),c=i.cloneNode(!0);o.parentNode.replaceChild(r,o),a.parentNode.replaceChild(l,a),i.parentNode.replaceChild(c,i),r.addEventListener("click",async function(){await async function(t){const o=n.find(e=>e.id===t);if(!o)return void d("Event not found","eventModalMessageContainer");const a=`Send announcement email to all approved members about "${o.name}" on ${new Date(o.date).toLocaleDateString()}?`;if(!confirm(a))return;const i=document.getElementById("sendAnnouncementEmailBtn"),r=i.textContent;i.textContent="Sending...",i.disabled=!0;try{const n=await fetch("/.netlify/functions/send-event-announcement",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:t,eventName:o.name,eventDate:o.date,eventTime:o.time,eventVenue:o.venue,eventDescription:o.description})});n.ok?s(`Announcement sent successfully! ${(await n.json()).emailsSent} emails sent.`,"success","eventModalMessageContainer"):d(`Failed to send announcement: ${(await n.json()).error}`,"eventModalMessageContainer")}catch(l){console.error("Error sending announcement:",l),d("An error occurred while sending the announcement","eventModalMessageContainer")}finally{i.textContent=r,i.disabled=!1}}(t)}),l.addEventListener("click",async function(){await async function(t){const o=n.find(e=>e.id===t);if(!o)return void d("Event not found","eventModalMessageContainer");const a=`Send reminder email to all approved members about "${o.name}" on ${new Date(o.date).toLocaleDateString()}?`;if(!confirm(a))return;const i=document.getElementById("sendReminderEmailBtn"),r=i.textContent;i.textContent="Sending...",i.disabled=!0;try{const n=await fetch("/.netlify/functions/send-event-announcement",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:t,eventName:o.name,eventDate:o.date,eventTime:o.time,eventVenue:o.venue,eventDescription:o.description,isReminder:!0})});n.ok?s(`Reminder sent successfully! ${(await n.json()).stats.sent} emails sent.`,"success","eventModalMessageContainer"):d(`Failed to send reminder: ${(await n.json()).error}`,"eventModalMessageContainer")}catch(l){console.error("Error sending reminder:",l),d("An error occurred while sending the reminder","eventModalMessageContainer")}finally{i.textContent=r,i.disabled=!1}}(t)}),c.addEventListener("click",async function(){await async function(t){const o=n.find(e=>e.id===t);if(!o)return void d("Event not found","eventsMessageContainer");let a=null;try{const e=localStorage.getItem("kartel_admin_user");e&&(a=JSON.parse(e).email)}catch(u){console.error("Error getting stored user data:",u)}if(!a){if(a=prompt("Enter your email address for the test email:"),!a)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return void d("Please enter a valid email address","eventsMessageContainer")}const i=document.getElementById("testEmailType"),r=!!i&&"reminder"===i.value,l=document.getElementById("modalSendTestEmailBtn"),c=l.textContent;l.textContent="Sending...",l.disabled=!0;try{const n=await fetch("/.netlify/functions/send-test-email",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:t,adminEmail:a,eventData:o,isReminder:r})}),i=await n.json();n.ok&&i.success?s(`Test ${r?"reminder":"announcement"} email sent successfully to ${a}!`,"success","eventModalMessageContainer"):d(`Failed to send test email: ${i.error}`,"eventModalMessageContainer")}catch(u){console.error("Error sending test email:",u),d("An error occurred while sending the test email","eventModalMessageContainer")}finally{l.textContent=c,l.disabled=!1}}(t)})}(a.id);const i=document.querySelector(".email-section");i&&(i.style.display="block"),document.getElementById("eventModal").style.display="block"},window.closeEventModal=E,window.deleteEvent=function(e){confirm("Are you sure you want to delete this event?")&&alert("Event deletion feature coming soon!")},window.loadEventPhotos=v,window.displayEventPhotos=y,window.loadEventVideos=f,window.displayEventVideos=h,window.addAttendeeToEvent=C,window.removeAttendeeFromEvent=async function(e,t){try{const o=n.findIndex(t=>t.id===e);if(-1===o)return;n[o].attendees=n[o].attendees.filter(e=>e.memberId!==t),await $(e,n[o].attendees),M(n[o].attendees),s("Attendee removed successfully!","success","eventsMessageContainer")}catch(o){console.error("Error removing attendee:",o),d("Failed to remove attendee. Please try again.","eventsMessageContainer")}},window.toggleAttendeeStatus=async function(e,t){try{const o=n.findIndex(t=>t.id===e);if(-1===o)return;const a=n[o].attendees.find(e=>e.memberId===t);if(!a)return;a.attended=!a.attended,a.statusUpdatedAt=(new Date).toISOString(),await $(e,n[o].attendees),M(n[o].attendees)}catch(o){console.error("Error updating attendee status:",o),d("Failed to update attendance status. Please try again.","eventsMessageContainer")}},window.loadEventAttendees=x,window.loadApprovedMembers=B;let k=[],S=[],T=[];async function F(){try{console.log("Loading gallery management...");try{const t=await fetch("/.netlify/functions/get-gallery",{headers:{Authorization:`Bearer ${e}`}});if(console.log("Get gallery response status:",t.status),t.ok){const e=await t.json();console.log("Gallery data received:",e),k=e.photos||[],V()}else{const e=await t.json().catch(()=>({error:"Unknown error"}));console.log("Gallery fetch error:",e),k=[]}}catch(t){console.error("Error fetching gallery:",t),k=[]}try{await async function(){try{console.log("Loading available photos from events...");const t=await fetch("/.netlify/functions/get-events",{headers:{Authorization:`Bearer ${e}`}});if(console.log("Get events response status:",t.status),!t.ok){const e=await t.json().catch(()=>({error:"Unknown error"}));throw console.error("Events fetch error:",e),new Error(`Failed to fetch events: ${e.error||t.status}`)}{const e=await t.json();console.log("Events data received:",e);const n=e.events||[];S=[],n.forEach(e=>{e.photos&&e.photos.length>0&&(console.log(`Event "${e.name}" has ${e.photos.length} photos`),e.photos.forEach(t=>{S.push({...t,eventName:e.name,eventDate:e.date})}))}),console.log(`Total photos collected: ${S.length}`)}}catch(t){throw console.error("Error loading available photos:",t),t}}(),console.log("Available photos loaded, count:",S.length)}catch(n){console.error("Error loading available photos:",n),S=[]}P(),console.log("Gallery management loaded successfully")}catch(o){console.error("Error in loadGalleryManagement:",o),d(`Failed to load gallery management: ${o.message}`,"galleryMessageContainer")}}function P(){const e=document.getElementById("availablePhotosGrid"),t=document.getElementById("selectedPhotosGrid");console.log("Rendering gallery management. Available photos:",S.length,"Selected photos:",k.length),0===S.length?e.innerHTML='<p style="color: #7f8c8d; text-align: center; grid-column: 1 / -1;">No event photos available. Upload photos to events first.</p>':e.innerHTML=S.map(e=>{const t=e.url||e.src||`/.netlify/functions/get-photo?path=${encodeURIComponent(e.path)}`;return`\n            <div class="photo-item" style="position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); ${k.find(t=>t.id===e.id)?"opacity: 0.5;":""}" \n                 onclick="selectPhoto('${e.id}')">\n                <img src="${t}" alt="${e.caption||"Event photo"}" style="width: 100%; height: 120px; object-fit: cover;">\n                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; padding: 8px 6px 6px; font-size: 0.7rem;">\n                    <div style="font-weight: 600;">${e.eventName}</div>\n                    <div style="opacity: 0.8;">${e.eventDate}</div>\n                </div>\n                ${k.find(t=>t.id===e.id)?'<div style="position: absolute; top: 5px; right: 5px; background: #27ae60; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">✓</div>':""}\n            </div>\n            `}).join(""),0===k.length?t.innerHTML='<p style="color: #7f8c8d; text-align: center; grid-column: 1 / -1;">Click photos from the left to add them here</p>':t.innerHTML=k.map(e=>{const t=e.url||e.src||`/.netlify/functions/get-photo?path=${encodeURIComponent(e.path)}`;return`\n            <div class="photo-item" style="position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" \n                 onclick="deselectPhoto('${e.id}')">\n                <img src="${t}" alt="${e.caption||"Event photo"}" style="width: 100%; height: 100px; object-fit: cover;">\n                <div style="position: absolute; top: 2px; right: 2px; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer;">×</div>\n            </div>\n            `}).join(""),document.getElementById("selectedCount").textContent=k.length}async function L(){try{const t=await fetch("/.netlify/functions/get-faqs",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=await t.json();T=e.faqs||[],document.getElementById("totalFaqs").textContent=T.length,function(){const e=document.getElementById("faqContainer");0!==T.length?e.innerHTML=T.map(e=>`\n        <div class="faq-item" style="background: white; border: 1px solid #ecf0f1; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">\n            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">\n                <h4 style="color: #2c3e50; font-weight: 600; margin: 0; flex: 1;">${e.question}</h4>\n                <div style="display: flex; gap: 10px; margin-left: 15px;">\n                    <button class="btn btn-secondary btn-small" onclick="editFaq('${e.id}')">Edit</button>\n                    <button class="btn btn-danger btn-small" onclick="deleteFaq('${e.id}')">Delete</button>\n                </div>\n            </div>\n            <p style="color: #5d6d7e; margin: 0; line-height: 1.5;">${e.answer}</p>\n            <small style="color: #95a5a6; display: block; margin-top: 10px;">Order: ${e.order||"Not set"}</small>\n        </div>\n    `).join(""):e.innerHTML='\n            <div class="empty-state">\n                <h3>No FAQs found</h3>\n                <p>Start by adding your first FAQ to help visitors understand The Kartel better.</p>\n                <button class="btn btn-success" onclick="openAddFaqModal()">Add Your First FAQ</button>\n            </div>\n        '}()}}catch(t){console.error("Error loading FAQs:",t),d("Failed to load FAQs. Please try again.","faqMessageContainer")}}function N(){document.getElementById("faqModal").style.display="none"}async function j(){try{const t=await fetch("/.netlify/functions/get-experience-video",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=(await t.json()).vimeoId||"1092055210";document.getElementById("experienceVimeoId").value=e,D(e),q(e)}}catch(t){console.error("Error loading experience video:",t),d("Failed to load experience video. Please try again.","videoMessageContainer")}}function D(e){const t=document.getElementById("experienceVideoPreview");e&&e.trim()?t.innerHTML=`\n            <iframe src="https://player.vimeo.com/video/${e}" \n                    width="100%" height="100%" frameborder="0" \n                    allow="autoplay; fullscreen; picture-in-picture" \n                    allowfullscreen></iframe>\n        `:t.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #7f8c8d;">No video selected</div>'}function V(){document.getElementById("totalGalleryPhotos").textContent=k.length}function q(e){document.getElementById("experienceVideoId").textContent=e||"-",document.getElementById("contentLastUpdated").textContent=(new Date).toLocaleDateString()}document.getElementById("faqForm").addEventListener("submit",async t=>{t.preventDefault();const n=new FormData(t.target),o={id:n.get("faqId")||Date.now().toString(),question:n.get("faqQuestion"),answer:n.get("faqAnswer"),order:parseInt(n.get("faqOrder"))||T.length+1};try{if(!(await fetch("/.netlify/functions/update-faq",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(o)})).ok)throw new Error("Failed to save FAQ");s("FAQ saved successfully!","success","faqMessageContainer"),N(),L()}catch(a){console.error("Error saving FAQ:",a),d("Failed to save FAQ. Please try again.","faqMessage")}}),document.getElementById("experienceVimeoId").addEventListener("input",e=>{D(e.target.value.trim())});let z=null;function O(){document.getElementById("eventConfirmationModal").style.display="none",z=null}async function U(){try{const t=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=await t.json();return e.applications.filter(e=>"approved"===e.status).length}return 0}catch(t){return console.error("Error loading approved members:",t),0}}window.loadGalleryManagement=F,window.selectPhoto=function(e){if(k.length>=12)return void d("Maximum 12 photos allowed in gallery","galleryMessageContainer");const t=S.find(t=>t.id===e);t&&!k.find(t=>t.id===e)&&(k.push(t),P())},window.deselectPhoto=function(e){k=k.filter(t=>t.id!==e),P()},window.saveGallerySelection=async function(){try{console.log("Saving gallery selection:",k);const t=k.map(e=>({id:e.id,url:e.url||e.src||`/.netlify/functions/get-photo?path=${encodeURIComponent(e.path)}`,alt:e.alt||e.caption||`Photo from ${e.eventName}`,caption:e.caption||`Photo from ${e.eventName}`,eventName:e.eventName,eventDate:e.eventDate,uploadedAt:e.uploadedAt}));console.log("Photos prepared for frontend:",t);const n=await fetch("/.netlify/functions/update-gallery",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({photos:t})});if(console.log("Response status:",n.status),!n.ok){const e=await n.json().catch(()=>({error:"Unknown error"}));throw console.error("Error response:",e),new Error(e.error||`Server error: ${n.status}`)}{const e=await n.json();console.log("Success response:",e),s("Gallery updated successfully!","success","galleryMessageContainer"),V()}}catch(t){console.error("Error saving gallery:",t),d(`Failed to save gallery: ${t.message}`,"galleryMessageContainer")}},window.loadFaqs=L,window.openAddFaqModal=function(){document.getElementById("faqModalTitle").textContent="Add FAQ",document.getElementById("faqId").value="",document.getElementById("faqQuestion").value="",document.getElementById("faqAnswer").value="",document.getElementById("faqOrder").value="",document.getElementById("faqModal").style.display="block"},window.editFaq=function(e){const t=T.find(t=>t.id===e);t&&(document.getElementById("faqModalTitle").textContent="Edit FAQ",document.getElementById("faqId").value=t.id,document.getElementById("faqQuestion").value=t.question,document.getElementById("faqAnswer").value=t.answer,document.getElementById("faqOrder").value=t.order||"",document.getElementById("faqModal").style.display="block")},window.closeFaqModal=N,window.deleteFaq=async function(t){if(confirm("Are you sure you want to delete this FAQ?"))try{if(!(await fetch("/.netlify/functions/delete-faq",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({id:t})})).ok)throw new Error("Failed to delete FAQ");s("FAQ deleted successfully!","success","faqMessageContainer"),L()}catch(n){console.error("Error deleting FAQ:",n),d("Failed to delete FAQ. Please try again.","faqMessageContainer")}},window.seedFaqs=async function(){if(confirm("This will populate the CMS with the existing FAQs from the website. Continue?"))try{const t=await fetch("/.netlify/functions/seed-faqs",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Failed to seed FAQs");s((await t.json()).message,"success","faqMessageContainer"),L()}catch(t){console.error("Error seeding FAQs:",t),d("Failed to seed FAQs. Please try again.","faqMessageContainer")}},window.loadExperienceVideo=j,window.updateExperienceVideo=async function(){const t=document.getElementById("experienceVimeoId").value.trim();if(t)try{if(!(await fetch("/.netlify/functions/update-experience-video",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({vimeoId:t})})).ok)throw new Error("Failed to update experience video");s("Experience video updated successfully!","success","videoMessageContainer"),D(t),q(t)}catch(n){console.error("Error updating experience video:",n),d("Failed to update experience video. Please try again.","videoMessageContainer")}else d("Please enter a Vimeo video ID","videoMessageContainer")},window.closeApplicantModal=w,window.closeEventConfirmationModal=O,window.switchToMemberView=function(){const e=localStorage.getItem("kartel_admin_user");if(e)try{const t=JSON.parse(e);console.log("👨‍💼 Switching to member view for admin:",t.email),sessionStorage.setItem("switched_from_admin","true"),window.location.href="/members.html"}catch(t){console.error("Error parsing admin user data:",t),window.location.href="/members.html"}else window.location.href="/members.html"},console.log("📦 Admin bundle loaded")}}});
