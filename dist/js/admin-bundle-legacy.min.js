System.register(["../notification-manager-legacy-BX4N0lud.min.js"],function(e,t){"use strict";var n,o,NotificationManager;return{setters:[e=>{n=e.K,o=e.a,NotificationManager=e.N}],execute:function(){let e=localStorage.getItem("kartel_admin_token"),t=[],a=[],i=[],s=null;function d(e){if(!e)return"";const t=e.trim();if(!t)return"";const n=[/^https?:\/\/(www\.)?linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?linkedin\.com\/pub\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?uk\.linkedin\.com\/pub\/([a-zA-Z0-9\-]+)\/?.*$/,/^linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^www\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^www\.uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^([a-zA-Z0-9\-]+)$/];for(const a of n){const e=t.match(a);if(e)return e[2]||e[1]}const o=t.match(/(uk\.)?linkedin\.com\/in\/([a-zA-Z0-9\-]+)/);return o?o[2]:(/^[a-zA-Z0-9\-]+$/.test(t),t)}function r(e,t="success",n="messageContainer"){const o=document.getElementById(n);o.innerHTML=`<div class="${t}">${e}</div>`,setTimeout(()=>o.innerHTML="",5e3)}function l(e,t="messageContainer"){r(e,"error",t)}async function c(){try{const t=await fetch("/.netlify/functions/get-venues",{headers:{Authorization:`Bearer ${e}`}});if(401===t.status)return e=null,localStorage.removeItem("kartel_admin_token"),void C();if(!t.ok)throw new Error("Failed to load venues");const n=await t.json();i=n.venues||[],function(){const e=i.length,t=i.filter(e=>{const t=new Date(e.createdAt),n=new Date;return t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()}).length;document.getElementById("totalVenues").textContent=e,document.getElementById("activeVenues").textContent=e,document.getElementById("venuesWithEvents").textContent=0,document.getElementById("recentVenues").textContent=t}(),m()}catch(t){console.error("Error loading venues:",t),l("Failed to load venues. Please try again.","venuesMessageContainer")}}async function u(){try{console.log("üè¢ loadVenuesForDropdown() called, authToken:",e?"present":"missing");const t=await fetch("/.netlify/functions/get-venues",{headers:{Authorization:`Bearer ${e}`}});if(console.log("üè¢ Venues API response status:",t.status),t.ok){const e=await t.json();i=e.venues||[],console.log("üè¢ Venues loaded:",i.length,"venues"),function(){const e=document.getElementById("eventVenue");for(;e.children.length>2;)e.removeChild(e.lastChild);i.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})}()}}catch(t){console.error("üè¢ Error loading venues for dropdown:",t)}}function m(e=null){const t=document.getElementById("venuesContainer"),n=e||i;if(0===n.length)return void(t.innerHTML='\n            <div class="search-container">\n                <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()">\n            </div>\n            <div class="empty-state">\n                <h3>No venues found</h3>\n                <p>Start by adding your first karting venue to manage events effectively.</p>\n                <button class="btn btn-success" onclick="openAddVenueModal()">Add Your First Venue</button>\n            </div>\n        ');const o=n.map(e=>`\n        <div class="venue-card">\n            <div class="venue-name">${e.name}</div>\n            <div class="venue-details">\n                <div class="venue-detail"><strong>Address:</strong> ${e.address}</div>\n                ${e.phone?`<div class="venue-detail"><strong>Phone:</strong> ${e.phone}</div>`:""}\n                ${e.website?`<div class="venue-detail"><strong>Website:</strong> <a href="${e.website}" target="_blank" style="color: #e74c3c;">Visit Site</a></div>`:""}\n                ${e.notes?`<div class="venue-detail"><strong>Notes:</strong> ${e.notes}</div>`:""}\n                ${e.drivingTips?`<div class="venue-detail"><strong>Driving Tips:</strong> ${e.drivingTips.substring(0,100)}${e.drivingTips.length>100?"...":""}</div>`:""}\n                ${e.vimeoId?`<div class="venue-detail"><strong>Video:</strong> <a href="https://vimeo.com/${e.vimeoId}" target="_blank" style="color: #e74c3c;">Watch on Vimeo</a></div>`:""}\n                ${e.trackMapPath?'<div class="venue-detail"><strong>Track Map:</strong> <span style="color: #27ae60;">‚úì Available</span></div>':""}\n                <div class="venue-detail"><strong>Added:</strong> ${new Date(e.createdAt).toLocaleDateString()}</div>\n            </div>\n            <div class="venue-actions">\n                <button class="action-btn edit-btn btn-small" onclick="editVenue('${e.id}')">Edit</button>\n                <button class="action-btn delete-btn btn-small" onclick="deleteVenue('${e.id}')">Delete</button>\n            </div>\n        </div>\n    `).join("");t.innerHTML=`\n        <div class="search-container">\n            <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()" value="${document.getElementById("venueSearch")?.value||""}">\n        </div>\n        <div class="venues-grid">${o}</div>\n    `}function p(){s=null,document.getElementById("modalTitle").textContent="Add New Venue",document.getElementById("venueForm").reset(),document.getElementById("trackMapPreview").style.display="none",document.getElementById("vimeoPreview").style.display="none",document.getElementById("vimeoPreview").querySelector("iframe").src="",document.getElementById("venueModal").style.display="block"}function g(){document.getElementById("venueModal").style.display="none",s=null}let v=!1;async function y(){if(v)console.log("üìã loadApplications() already in progress, skipping...");else try{v=!0,console.log("üìã loadApplications() called, authToken:",e?"present":"missing"),console.log("üìã Making API call to get-applications...");const n=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:`Bearer ${e}`}});if(console.log("üìã API response status:",n.status),401===n.status)return console.log("üìã 401 Unauthorized - clearing token"),e=null,localStorage.removeItem("kartel_admin_token"),void C();if(!n.ok)throw new Error("Failed to load applications");const o=await n.json();console.log("üìã Applications data received:",o.applications?o.applications.length:0,"applications"),t=o.applications||[],function(){const e=t.length,n=t.filter(e=>"pending"===e.status).length,o=t.filter(e=>"approved"===e.status).length,a=t.filter(e=>"rejected"===e.status).length;document.getElementById("totalApplications").textContent=e,document.getElementById("pendingApplications").textContent=n,document.getElementById("approvedApplications").textContent=o,document.getElementById("rejectedApplications").textContent=a}(),function(){const e=document.getElementById("applicationsTableBody");0!==t.length?e.innerHTML=t.map(e=>`\n        <tr>\n            <td>\n                <strong>${e.fullName||`${e.firstName||""} ${e.lastName||""}`.trim()||e.name||"N/A"}</strong>\n                ${e.isAdmin?'<br><span style="color: #e74c3c; font-weight: bold; font-size: 12px;">üëë Administrator</span>':""}\n                ${e.importedAt?'<br><small style="color: #6c757d;">üì• Imported</small>':""}\n            </td>\n            <td>${e.email}</td>\n            <td>\n                <strong>${e.company||"N/A"}</strong>\n                ${e.position?`<br><small>${e.position}</small>`:""}\n            </td>\n            <td>${e.phone}</td>\n            <td>\n                ${e.linkedin?`<a href="https://linkedin.com/in/${e.linkedin}" target="_blank" style="color: #0077b5; text-decoration: none;">üîó ${e.linkedin}</a>`:"N/A"}\n            </td>\n            <td><span class="status-badge status-${e.status}">${e.status}</span></td>\n            <td>${new Date(e.submittedAt).toLocaleDateString()}</td>\n            <td>\n                ${"pending"===e.status?`\n                    <button class="action-btn approve-btn" onclick="updateApplication('${e.id}', 'approved')">Approve</button>\n                    <button class="action-btn reject-btn" onclick="updateApplication('${e.id}', 'rejected')">Reject</button>\n                `:""}\n                <button class="action-btn details-btn" onclick="showDetails('${e.id}')">Details</button>\n                <button class="action-btn delete-btn" onclick="deleteApplication('${e.id}')">Delete</button>\n            </td>\n        </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="8" class="loading">No applications found</td></tr>'}(),console.log("üìã loadApplications() completed successfully")}catch(n){console.error("üìã Error loading applications:",n),l("Failed to load applications. Please try again.")}finally{v=!1,console.log("üìã loadApplications() flag reset")}}async function f(){try{const t=await fetch("/.netlify/functions/get-events",{headers:{Authorization:`Bearer ${e}`}});if(401===t.status)return e=null,localStorage.removeItem("kartel_admin_token"),void C();if(!t.ok)throw new Error("Failed to load events");const n=await t.json();a=n.events||[],function(){const e=a.length,t=a.filter(e=>"upcoming"===e.status).length,n=a.filter(e=>"completed"===e.status).length,o=a.reduce((e,t)=>e+(t.photos?t.photos.length:0),0);document.getElementById("totalEvents").textContent=e,document.getElementById("upcomingEvents").textContent=t,document.getElementById("completedEvents").textContent=n,document.getElementById("totalPhotos").textContent=o}(),function(){const e=document.getElementById("eventsTableBody");0!==a.length?e.innerHTML=a.map(e=>`\n        <tr>\n            <td><strong>${e.name}</strong></td>\n            <td>${new Date(e.date).toLocaleDateString()}${e.time?`<br><small>${e.time}</small>`:""}</td>\n            <td><strong>${e.venue}</strong></td>\n            <td>\n                <span class="status-badge status-approved">${e.attendees?e.attendees.length:0}</span>\n                ${e.attendees&&e.attendees.length>0?`<br><small>${e.attendees.filter(e=>e.attended).length} attended</small>`:""}\n            </td>\n            <td><span class="status-badge status-approved">${e.photos?e.photos.length:0}</span></td>\n            <td><span class="status-badge status-pending">${e.videos?e.videos.length:0}</span></td>\n            <td><span class="status-badge status-${e.status}">${e.status}</span></td>\n            <td>\n                <button class="action-btn edit-btn" onclick="editEvent('${e.id}')">Edit</button>\n                <button class="action-btn delete-btn" onclick="deleteEvent('${e.id}')">Delete</button>\n            </td>\n        </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="8" class="loading">No events found</td></tr>'}()}catch(t){console.error("Error loading events:",t),l("Failed to load events. Please try again.","eventsMessageContainer")}}async function h(t){try{const n=await fetch("/.netlify/functions/get-events",{headers:{Authorization:`Bearer ${e}`}});if(n.ok){const e=(await n.json()).events.find(e=>e.id===t);e&&e.photos?E(e.photos):E([])}}catch(n){console.error("Error loading event photos:",n)}}function E(e){const t=document.getElementById("eventPhotosGrid");if(!e||0===e.length)return void(t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No photos uploaded yet</p>');const n=e.map(e=>`\n        <div class="photo-item">\n            <img src="/.netlify/functions/get-photo?path=${encodeURIComponent(e.path)}" \n                alt="${e.caption||"Event photo"}"\n                onerror="this.style.display='none'">\n            ${e.caption?`<div class="photo-caption">${e.caption}</div>`:""}\n        </div>\n    `).join("");t.innerHTML=n}async function w(t){try{const n=await fetch("/.netlify/functions/get-events",{headers:{Authorization:`Bearer ${e}`}});if(n.ok){const e=(await n.json()).events.find(e=>e.id===t);e&&e.videos?I(e.videos):I([])}}catch(n){console.error("Error loading event videos:",n)}}function I(e){const t=document.getElementById("eventVideosGrid");if(!e||0===e.length)return void(t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No videos uploaded yet</p>');const n=e.map(e=>`\n        <div style="border: 1px solid #ecf0f1; border-radius: 8px; padding: 15px; background: white;">\n            <div style="aspect-ratio: 16/9; margin-bottom: 10px;">\n                <iframe src="https://player.vimeo.com/video/${e.vimeoId}" \n                        width="100%" height="100%" frameborder="0" \n                        allow="autoplay; fullscreen; picture-in-picture" allowfullscreen\n                        style="border-radius: 4px;">\n                </iframe>\n            </div>\n            <h5 style="color: #2c3e50; margin-bottom: 5px; font-size: 1rem;">${e.title||"Untitled Video"}</h5>\n            ${e.description?`<p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 8px;">${e.description}</p>`:""}\n            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #999;">\n                <span>Uploaded: ${new Date(e.uploadedAt).toLocaleDateString()}</span>\n                <a href="https://vimeo.com/${e.vimeoId}" target="_blank" style="color: #3498db;">View on Vimeo</a>\n            </div>\n        </div>\n    `).join("");t.innerHTML=n}function b(){document.getElementById("eventModal").style.display="none";const e=document.querySelector(".email-section");e&&(e.style.display="none")}function B(){document.getElementById("applicantModal").style.display="none"}function C(){document.getElementById("loginSection").classList.remove("hidden"),document.getElementById("dashboardSection").classList.add("hidden")}async function $(){const t=new URLSearchParams(window.location.search),n=t.get("action"),o=t.get("id"),a=t.get("token");n&&o&&a&&(console.log(`üöÄ Processing quick action from URL: ${n} for ${o}`),window.history.replaceState({},document.title,window.location.pathname),await async function(t,n,o){try{r("Processing quick action...","info","messageContainer");const a=await fetch("/.netlify/functions/quick-action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t,applicationId:n,actionToken:o})}),i=await a.json();if(a.ok&&i.success){const n="approve"===t?"approved":"rejected";r(`‚úÖ Application from ${i.application?.name||"applicant"} has been ${n} successfully!`,"success","messageContainer"),e&&y()}else r(`‚ùå Quick action failed: ${i.error||"Unknown error"}`,"error","messageContainer")}catch(a){console.error("Quick action error:",a),r("‚ùå Quick action failed due to network error","error","messageContainer")}}(n,o,a))}async function A(){try{const t=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=(await t.json()).applications.filter(e=>"approved"===e.status);return function(e){const t=document.getElementById("memberSelect");for(;t.children.length>1;)t.removeChild(t.lastChild);e.forEach(e=>{const n=document.createElement("option");n.value=e.id;const o=e.fullName||`${e.firstName||""} ${e.lastName||""}`.trim()||e.name||"Unknown";n.textContent=`${o} (${e.company||"No company"})`,n.dataset.email=e.email,n.dataset.company=e.company||"",t.appendChild(n)})}(e),e}}catch(t){console.error("Error loading approved members:",t)}return[]}async function k(e,t){try{const n=a.findIndex(t=>t.id===e);if(-1===n)return;a[n].attendees||(a[n].attendees=[]),a[n].attendees.push(t),await M(e,a[n].attendees),x(a[n].attendees),r("Attendee added successfully!","success","eventsMessageContainer")}catch(n){console.error("Error adding attendee:",n),l("Failed to add attendee. Please try again.","eventsMessageContainer")}}async function M(t,n){const o=await fetch("/.netlify/functions/update-event",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:t,updates:{attendees:n}})});if(!o.ok)throw new Error("Failed to update event attendees");return await o.json()}function x(e){const t=document.getElementById("attendeesList");if(!e||0===e.length)return t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No attendees added yet</p>',void T(0,0,0);const n=e.filter(e=>e.attended).length,o=e.filter(e=>!e.attended).length;T(e.length,n,o);const a=e.map(e=>`\n        <div class="attendee-item">\n            <div class="attendee-info">\n                <div class="attendee-name">${e.name}</div>\n                <div class="attendee-details">\n                    ${e.company?`${e.company} ‚Ä¢ `:""}${e.email}\n                    <br><small>Registered: ${new Date(e.registeredAt).toLocaleDateString()}</small>\n                </div>\n            </div>\n            <div class="attendee-status">\n                <span style="font-size: 0.8rem; margin-right: 8px;">\n                    ${e.attended?"Attended":"Registered"}\n                </span>\n                <div class="status-toggle ${e.attended?"attended":""}" \n                    onclick="toggleAttendeeStatus('${document.getElementById("editEventId").value}', '${e.memberId}')">\n                </div>\n                <button class="remove-attendee" \n                        onclick="removeAttendeeFromEvent('${document.getElementById("editEventId").value}', '${e.memberId}')">\n                    Remove\n                </button>\n            </div>\n        </div>\n    `).join("");t.innerHTML=a}function T(e,t,n){document.getElementById("registeredCount").textContent=e,document.getElementById("attendedCount").textContent=t,document.getElementById("noShowCount").textContent=n}async function S(e){const t=a.find(t=>t.id===e);t&&t.attendees?x(t.attendees):x([])}document.getElementById("photoUpload").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("photoPreview"),o=document.getElementById("uploadPhotoBtn");if(t){const e=new FileReader;e.onload=function(e){n.src=e.target.result,n.style.display="block",o.disabled=!1},e.readAsDataURL(t)}else n.style.display="none",o.disabled=!0}),document.getElementById("uploadPhotoBtn").addEventListener("click",async function(){const t=document.getElementById("photoUpload"),n=document.getElementById("photoCaption"),o=document.getElementById("editEventId").value;if(!t.files[0]||!o)return void l("Please select a photo and ensure an event is selected","eventsMessageContainer");const a=t.files[0],i=n.value.trim(),s=new FileReader;s.onload=async function(s){const d=s.target.result,c=document.getElementById("uploadPhotoBtn"),u=c.textContent;c.textContent="Uploading...",c.disabled=!0;try{const s=await fetch("/.netlify/functions/upload-photo",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:o,photoData:d,fileName:a.name,caption:i})}),c=await s.json();s.ok&&c.success?(r("Photo uploaded successfully!","success","eventsMessageContainer"),t.value="",n.value="",document.getElementById("photoPreview").style.display="none",await h(o),f()):l(c.error||"Failed to upload photo","eventsMessageContainer")}catch(m){console.error("Photo upload error:",m),l("Failed to upload photo. Please try again.","eventsMessageContainer")}finally{c.textContent=u,c.disabled=!1}},s.readAsDataURL(a)}),document.getElementById("videoUpload").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("videoPreview"),o=document.getElementById("uploadVideoBtn");if(t){const a=524288e3;if(t.size>a)return l("Video file size must be less than 500MB","eventsMessageContainer"),void(e.target.value="");const i=URL.createObjectURL(t);n.src=i,n.style.display="block",o.disabled=!1;const s=document.getElementById("videoTitle");s.value||(s.value=t.name.replace(/\.[^/.]+$/,""))}else n.style.display="none",o.disabled=!0}),document.getElementById("uploadVideoBtn").addEventListener("click",async function(){const t=document.getElementById("videoUpload"),n=document.getElementById("videoTitle"),o=document.getElementById("videoDescription"),a=document.getElementById("editEventId").value;if(!t.files[0]||!a)return void l("Please select a video and ensure an event is selected","eventsMessageContainer");const i=t.files[0],s=n.value.trim()||i.name,d=o.value.trim(),c=this,u=c.textContent,m=document.getElementById("uploadProgress"),p=document.getElementById("progressBar");c.textContent="Preparing Upload...",c.disabled=!0,m.style.display="block",p.style.width="10%";try{const g=new FileReader;g.onload=async function(g){const v=g.target.result;p.style.width="30%",c.textContent="Uploading to Vimeo...";try{const c=await fetch("/.netlify/functions/upload-video-vimeo",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:a,videoData:v,fileName:i.name,title:s,description:d})});p.style.width="90%";const u=await c.json();c.ok&&u.success?(p.style.width="100%",r(`Video uploaded successfully to Vimeo! <a href="${u.vimeoUrl}" target="_blank">View Video</a>`,"success","eventsMessageContainer"),t.value="",n.value="",o.value="",document.getElementById("videoPreview").style.display="none",await w(a),f()):l(u.error||"Failed to upload video to Vimeo","eventsMessageContainer")}catch(y){console.error("Video upload error:",y),l("Failed to upload video. Please try again.","eventsMessageContainer")}finally{c.textContent=u,c.disabled=!1,m.style.display="none",p.style.width="0%"}},g.readAsDataURL(i)}catch(g){console.error("Video processing error:",g),l("Failed to process video file. Please try again.","eventsMessageContainer"),c.textContent=u,c.disabled=!1,m.style.display="none"}}),document.addEventListener("DOMContentLoaded",function(){$(),console.log("üìù Admin.js loaded - authentication handled by unified system"),document.getElementById("refreshBtn").addEventListener("click",y),document.getElementById("refreshEventsBtn").addEventListener("click",f),document.getElementById("refreshVenuesBtn").addEventListener("click",c),document.getElementById("recoverBtn").addEventListener("click",async()=>{if(!confirm("‚ö†Ô∏è RECOVER DATA\n\nThis will attempt to rebuild the applications list from individual member records.\n\nThis is safe to run and will not delete any data.\n\nProceed?"))return;const t=document.getElementById("recoverBtn"),n=t.textContent;t.textContent="üîÑ Recovering...",t.disabled=!0;try{const t=await fetch("/.netlify/functions/recover-applications-list",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),n=await t.json();t.ok&&n.success?(r(`‚úÖ Recovery successful! Recovered ${n.recovered} members. Status: ${JSON.stringify(n.statusBreakdown)}`,"success"),setTimeout(()=>{y()},1e3)):l(`‚ùå Recovery failed: ${n.error||"Unknown error"}`)}catch(o){console.error("Recovery error:",o),l("‚ùå Recovery failed due to network error")}finally{t.textContent=n,t.disabled=!1}}),document.getElementById("venueForm").addEventListener("submit",async function(t){t.preventDefault();const n=new FormData(this),o={name:n.get("venueName").trim(),address:n.get("venueAddress").trim(),phone:n.get("venuePhone").trim(),website:n.get("venueWebsite").trim(),notes:n.get("venueNotes").trim(),drivingTips:n.get("venueDrivingTips").trim(),vimeoId:n.get("venueVimeoId").trim()},a=n.get("venueTrackMap");if(a&&a.size>0){const e=new FileReader,t=await new Promise((t,n)=>{e.onload=e=>t(e.target.result),e.onerror=n,e.readAsDataURL(a)});o.trackMap={data:t,fileName:a.name,fileType:a.type}}if(!o.name||!o.address)return void l("Please fill in all required fields","venuesMessageContainer");const i=this.querySelector('button[type="submit"]'),d=i.textContent;i.textContent="Saving...",i.disabled=!0;try{let t;t=s?await fetch("/.netlify/functions/update-venue",{method:"PUT",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({venueId:s,...o})}):await fetch("/.netlify/functions/create-venue",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(o)});const n=await t.json();t.ok&&n.success?(r(n.message,"success","venuesMessageContainer"),g(),c(),u()):l(n.error||"Failed to save venue","venuesMessageContainer")}catch(m){console.error("Error saving venue:",m),l("Failed to save venue. Please try again.","venuesMessageContainer")}finally{i.textContent=d,i.disabled=!1}}),document.getElementById("venueTrackMap").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("trackMapPreview"),o=document.getElementById("trackMapImage");if(t){const e=new FileReader;e.onload=function(e){o.src=e.target.result,n.style.display="block"},e.readAsDataURL(t)}else n.style.display="none"}),document.getElementById("venueVimeoId").addEventListener("input",function(e){const t=e.target.value.trim(),n=document.getElementById("vimeoPreview"),o=n.querySelector("iframe");t&&/^\d+$/.test(t)?(o.src=`https://player.vimeo.com/video/${t}`,n.style.display="block"):(n.style.display="none",o.src="")}),document.getElementById("seedVenuesBtn").addEventListener("click",async function(){if(!confirm("This will add default venues if none exist. Continue?"))return;const t=this,n=t.textContent;t.textContent="Seeding...",t.disabled=!0;try{const t=await fetch("/.netlify/functions/seed-venues",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),n=await t.json();t.ok?(r(n.message,"success","venuesMessageContainer"),n.success&&(c(),u())):l(n.error||"Failed to seed venues","venuesMessageContainer")}catch(o){console.error("Error seeding venues:",o),l("Failed to seed venues. Please try again.","venuesMessageContainer")}finally{t.textContent=n,t.disabled=!1}}),document.getElementById("eventVenue").addEventListener("change",function(){"add-new"===this.value&&(p(),this.value="")}),document.getElementById("eventForm").addEventListener("submit",async function(e){e.preventDefault();const t=new FormData(e.target),n=t.get("eventVenue");if(!n)return void l("Please select a venue","eventsMessageContainer");const o=i.find(e=>e.id===n),a={name:t.get("eventName"),date:t.get("eventDate"),time:t.get("eventTime"),venueId:n,venue:o?o.name:"",venueAddress:o?o.address:"",maxAttendees:t.get("eventMaxAttendees"),description:t.get("eventDescription"),sendAnnouncement:"on"===t.get("sendAnnouncement")};await async function(e){R=e,document.getElementById("confirmEventName").textContent=e.name||"Not specified",document.getElementById("confirmEventDate").textContent=e.date?new Date(e.date).toLocaleDateString():"Not specified",document.getElementById("confirmEventTime").textContent=e.time||"Not specified",document.getElementById("confirmEventVenue").textContent=e.venue||"Not specified",document.getElementById("confirmEventMaxAttendees").textContent=e.maxAttendees||"No limit",document.getElementById("confirmEventDescription").textContent=e.description||"No description";const t=document.getElementById("announcementInfo"),n=document.getElementById("confirmButtonText");if(e.sendAnnouncement){t.style.display="block",n.textContent="Confirm & Send";try{const e=await Q();document.getElementById("approvedMemberCount").textContent=e}catch(o){console.error("Error loading approved members count:",o),document.getElementById("approvedMemberCount").textContent="Unknown"}}else t.style.display="none",n.textContent="Confirm & Create Event";document.getElementById("eventConfirmationModal").style.display="block"}(a)}),document.getElementById("editEventForm").addEventListener("submit",async function(t){t.preventDefault();const n=new FormData(this),o=n.get("editEventId"),a=n.get("editEventVenue");if(!a)return void l("Please select a venue","eventsMessageContainer");const s=i.find(e=>e.id===a),d={name:n.get("editEventName"),date:n.get("editEventDate"),time:n.get("editEventTime"),venueId:a,venue:s?s.name:"",venueAddress:s?s.address:"",maxAttendees:n.get("editEventMaxAttendees"),status:n.get("editEventStatus"),description:n.get("editEventDescription")},c=this.querySelector('button[type="submit"]'),u=c.textContent;c.textContent="Updating...",c.disabled=!0;try{const t=await fetch("/.netlify/functions/update-event",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:o,updates:d})}),n=await t.json();t.ok&&n.success?(r("Event updated successfully!","success","eventsMessageContainer"),b(),f()):l(n.error||"Failed to update event","eventsMessageContainer")}catch(m){console.error("Event update error:",m),l("Failed to update event. Please try again.","eventsMessageContainer")}finally{c.textContent=u,c.disabled=!1}}),document.getElementById("applicantForm").addEventListener("submit",async function(t){t.preventDefault();const n=new FormData(this),o={applicationId:n.get("applicantId"),firstName:n.get("applicantFirstName").trim(),lastName:n.get("applicantLastName").trim(),email:n.get("applicantEmail").trim(),company:n.get("applicantCompany").trim(),position:n.get("applicantPosition").trim(),phone:n.get("applicantPhone").trim(),linkedin:d(n.get("applicantLinkedin")),status:n.get("applicantStatus"),isAdmin:document.getElementById("applicantIsAdmin").checked};if(!o.firstName||!o.lastName||!o.email)return void r("First name, last name, and email are required.","error","applicantMessage");const a=this.querySelector('button[type="submit"]'),i=a.textContent;a.textContent="Saving...",a.disabled=!0;try{const t=await async function(t){try{const n=await fetch("/.netlify/functions/update-applicant-details",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(401===n.status)return e=null,localStorage.removeItem("kartel_admin_token"),C(),!1;const o=await n.json();return n.ok&&o.success?(r("Applicant details updated successfully!","success","messageContainer"),y(),!0):(r(o.error||"Failed to update applicant details.","error","applicantMessage"),!1)}catch(n){return console.error("Error updating applicant details:",n),r("Failed to update applicant details due to network error. Please try again.","error","applicantMessage"),!1}}(o);t&&setTimeout(()=>{B()},2e3)}finally{a.textContent=i,a.disabled=!1}}),document.getElementById("confirmCreateEventBtn").addEventListener("click",async function(){await async function(){if(!R)return void l("No event data found","eventsMessageContainer");const t=document.getElementById("confirmCreateEventBtn"),n=t.innerHTML;t.innerHTML="Creating...",t.disabled=!0;try{const t=await fetch("/.netlify/functions/create-event",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(R)}),n=await t.json();t.ok&&n.success?(H(),r("Event created successfully!","success","eventsMessageContainer"),document.getElementById("eventForm").reset(),f()):l(n.error||"Failed to create event","eventsMessageContainer")}catch(o){console.error("Event creation error:",o),l("Failed to create event. Please try again.","eventsMessageContainer")}finally{t.innerHTML=n,t.disabled=!1}}()}),document.getElementById("sendTestEmailBtn").addEventListener("click",async function(){await async function(){if(!R)return void l("No event data found","eventsMessageContainer");let t=null;try{const e=localStorage.getItem("kartel_admin_user");e&&(t=JSON.parse(e).email)}catch(a){console.error("Error getting stored user data:",a)}if(!t){if(t=prompt("Enter your email address for the test email:"),!t)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return void l("Please enter a valid email address","eventsMessageContainer")}const n=document.getElementById("sendTestEmailBtn"),o=n.textContent;n.textContent="Sending...",n.disabled=!0;try{const n={...R,id:`test-${Date.now()}`,createdAt:(new Date).toISOString()},o=await fetch("/.netlify/functions/send-test-email",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:n.id,adminEmail:t,eventData:n})}),a=await o.json();o.ok&&a.success?r(`Test email sent successfully to ${t}!`,"success","eventsMessageContainer"):l(a.error||"Failed to send test email","eventsMessageContainer")}catch(a){console.error("Test email error:",a),l("Failed to send test email. Please try again.","eventsMessageContainer")}finally{n.textContent=o,n.disabled=!1}}()}),window.onclick=function(e){const t=document.getElementById("venueModal"),n=document.getElementById("eventModal"),o=document.getElementById("applicantModal"),a=document.getElementById("eventConfirmationModal");e.target===t&&g(),e.target===n&&b(),e.target===o&&B(),e.target===a&&H()};const t=document.getElementById("videoUpload"),n=document.getElementById("videoTitle"),o=document.getElementById("videoDescription"),a=document.getElementById("videoPreview"),m=document.getElementById("uploadVideoBtn"),v=document.getElementById("uploadProgress"),h=document.getElementById("progressBar");t.addEventListener("change",function(e){const o=e.target.files[0];if(!o)return a.style.display="none",void(m.disabled=!0);if(o.size>524288e3)return alert("File size must be less than 500MB"),t.value="",a.style.display="none",void(m.disabled=!0);if(!["video/mp4","video/mov","video/quicktime","video/avi"].includes(o.type))return alert("Please select a valid video file (MP4, MOV, AVI)"),t.value="",a.style.display="none",void(m.disabled=!0);const i=URL.createObjectURL(o);a.src=i,a.style.display="block",m.disabled=!1,n.value||(n.value=o.name.replace(/\.[^/.]+$/,""))}),m.addEventListener("click",async function(){const i=t.files[0];if(!i)return;const s=document.getElementById("editEventId").value;if(!s)return void alert("Please save the event first before uploading videos");const d=n.value.trim()||i.name,c=o.value.trim();v.style.display="block",m.disabled=!0,m.textContent="Uploading...",h.style.width="10%";try{const l=await new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=t,n.readAsDataURL(i)});h.style.width="30%";const u=await fetch("/.netlify/functions/upload-video-vimeo",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:s,videoData:l,fileName:i.name,title:d,description:c})});if(h.style.width="80%",!u.ok){const e=await u.json();throw new Error(e.error||"Upload failed")}const m=await u.json();if(h.style.width="100%",!m.success)throw new Error(m.error||"Upload failed");r("Video uploaded to Vimeo successfully!","success","eventsMessageContainer"),t.value="",n.value="",o.value="",a.style.display="none",w(s),f()}catch(u){console.error("Video upload error:",u),l(`Video upload failed: ${u.message}`,"eventsMessageContainer")}finally{v.style.display="none",m.disabled=!1,m.textContent="Upload to Vimeo",h.style.width="0%"}}),console.log("üîß Admin.js loaded, waiting for unified auth...")}),document.getElementById("memberSelect").addEventListener("change",function(){document.getElementById("addAttendeeBtn").disabled=!this.value}),document.getElementById("addAttendeeBtn").addEventListener("click",function(){const e=document.getElementById("memberSelect"),t=e.options[e.selectedIndex];if(!t.value)return;const n=document.getElementById("editEventId").value,o=t.value,i=t.textContent.split(" (")[0],s=t.dataset.email,d=t.dataset.company,r=a.find(e=>e.id===n),c=r.attendees?.find(e=>e.memberId===o);c?l("This member is already added to the event","eventsMessageContainer"):(k(n,{memberId:o,name:i,email:s,company:d,registeredAt:(new Date).toISOString(),attended:!1}),e.value="",document.getElementById("addAttendeeBtn").disabled=!0)}),window.switchTab=function(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),document.getElementById(e+"Tab").classList.add("active"),event.target.classList.add("active"),"applications"===e?y():"events"===e?(f(),u()):"venues"===e?c():"content"===e&&(N(),D(),q())},window.openAddVenueModal=p,window.closeVenueModal=g,window.editVenue=function(e){const t=i.find(t=>t.id===e);if(!t)return;s=e,document.getElementById("modalTitle").textContent="Edit Venue",document.getElementById("venueId").value=t.id,document.getElementById("venueName").value=t.name,document.getElementById("venueAddress").value=t.address,document.getElementById("venuePhone").value=t.phone||"",document.getElementById("venueWebsite").value=t.website||"",document.getElementById("venueNotes").value=t.notes||"",document.getElementById("venueDrivingTips").value=t.drivingTips||"",document.getElementById("venueVimeoId").value=t.vimeoId||"";const n=document.getElementById("trackMapPreview"),o=document.getElementById("trackMapImage");t.trackMapPath?(o.src=`/.netlify/functions/get-photo?path=${encodeURIComponent(t.trackMapPath)}`,n.style.display="block"):n.style.display="none";const a=document.getElementById("vimeoPreview"),d=a.querySelector("iframe");t.vimeoId&&/^\d+$/.test(t.vimeoId)?(d.src=`https://player.vimeo.com/video/${t.vimeoId}`,a.style.display="block"):(a.style.display="none",d.src=""),document.getElementById("venueModal").style.display="block"},window.deleteVenue=async function(t){const n=i.find(e=>e.id===t);if(n&&confirm(`Are you sure you want to delete "${n.name}"?`))try{const n=await fetch("/.netlify/functions/delete-venue",{method:"DELETE",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({venueId:t})}),o=await n.json();n.ok&&o.success?(r(o.message,"success","venuesMessageContainer"),c(),u()):l(o.error||"Failed to delete venue","venuesMessageContainer")}catch(o){console.error("Error deleting venue:",o),l("Failed to delete venue. Please try again.","venuesMessageContainer")}},window.filterVenues=function(){const e=document.getElementById("venueSearch").value.toLowerCase();e.trim()?m(i.filter(t=>t.name.toLowerCase().includes(e)||t.address.toLowerCase().includes(e)||t.notes&&t.notes.toLowerCase().includes(e)||t.drivingTips&&t.drivingTips.toLowerCase().includes(e))):m()},window.updateApplication=async function(t,n){try{if(!(await fetch("/.netlify/functions/update-application",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({applicationId:t,status:n,sendEmail:!0})})).ok)throw new Error("Failed to update application");r(`Application ${n} successfully! Email sent to applicant.`),y()}catch(o){console.error("Error updating application:",o),l("Failed to update application. Please try again.")}},window.deleteApplication=async function(n){const o=t.find(e=>e.id===n);if(!o)return;const a=o.fullName||`${o.firstName||""} ${o.lastName||""}`.trim()||"Unknown";if(confirm(`Are you sure you want to permanently delete the application for ${a}?`))try{if(!(await fetch("/.netlify/functions/delete-application",{method:"DELETE",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({applicationId:n})})).ok)throw new Error("Failed to delete application");r(`Application for ${a} deleted successfully.`),y()}catch(i){console.error("Error deleting application:",i),l("Failed to delete application. Please try again.")}},window.showDetails=function(e){const n=t.find(t=>t.id===e);if(!n)return;document.getElementById("applicantId").value=n.id,document.getElementById("applicantFirstName").value=n.firstName||"",document.getElementById("applicantLastName").value=n.lastName||"",document.getElementById("applicantEmail").value=n.email||"",document.getElementById("applicantCompany").value=n.company||"",document.getElementById("applicantPosition").value=n.position||"",document.getElementById("applicantPhone").value=n.phone||"",document.getElementById("applicantLinkedin").value=n.linkedin||"",document.getElementById("applicantOriginalMessage").value=n.message||"",document.getElementById("applicantStatus").value=n.status||"pending",document.getElementById("applicantSubmitted").value=new Date(n.submittedAt).toLocaleString(),document.getElementById("applicantIsAdmin").checked=n.isAdmin||!1;const o=document.getElementById("applicantMessage");o&&(o.classList.add("hidden"),o.textContent=""),document.getElementById("applicantModal").style.display="block"},window.editEvent=function(t){const n=a.find(e=>e.id===t);if(!n)return void l("Event not found","eventsMessageContainer");if(document.getElementById("editEventId").value=n.id,document.getElementById("editEventName").value=n.name,document.getElementById("editEventDate").value=n.date,document.getElementById("editEventTime").value=n.time||"",document.getElementById("editEventMaxAttendees").value=n.maxAttendees||"",document.getElementById("editEventStatus").value=n.status||"upcoming",document.getElementById("editEventDescription").value=n.description||"",function(){const e=document.getElementById("editEventVenue");for(;e.children.length>1;)e.removeChild(e.lastChild);i.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})}(),n.venueId)document.getElementById("editEventVenue").value=n.venueId;else{const e=Array.from(document.getElementById("editEventVenue").options).find(e=>e.textContent===n.venue);e&&(document.getElementById("editEventVenue").value=e.value)}h(n.id),w(n.id),S(n.id),A(),async function(){try{const e=await Q();document.getElementById("modalApprovedMemberCount").textContent=e}catch(e){console.error("Error loading member count for modal:",e),document.getElementById("modalApprovedMemberCount").textContent="Unknown"}}(),function(t){const n=document.getElementById("sendAnnouncementEmailBtn"),o=document.getElementById("sendReminderEmailBtn"),i=document.getElementById("modalSendTestEmailBtn"),s=n.cloneNode(!0),d=o.cloneNode(!0),c=i.cloneNode(!0);n.parentNode.replaceChild(s,n),o.parentNode.replaceChild(d,o),i.parentNode.replaceChild(c,i),s.addEventListener("click",async function(){await async function(t){const n=a.find(e=>e.id===t);if(!n)return void l("Event not found","eventModalMessageContainer");const o=`Send announcement email to all approved members about "${n.name}" on ${new Date(n.date).toLocaleDateString()}?`;if(!confirm(o))return;const i=document.getElementById("sendAnnouncementEmailBtn"),s=i.textContent;i.textContent="Sending...",i.disabled=!0;try{const o=await fetch("/.netlify/functions/send-event-announcement",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:t,eventName:n.name,eventDate:n.date,eventTime:n.time,eventVenue:n.venue,eventDescription:n.description})});o.ok?r(`Announcement sent successfully! ${(await o.json()).emailsSent} emails sent.`,"success","eventModalMessageContainer"):l(`Failed to send announcement: ${(await o.json()).error}`,"eventModalMessageContainer")}catch(d){console.error("Error sending announcement:",d),l("An error occurred while sending the announcement","eventModalMessageContainer")}finally{i.textContent=s,i.disabled=!1}}(t)}),d.addEventListener("click",async function(){await async function(t){const n=a.find(e=>e.id===t);if(!n)return void l("Event not found","eventModalMessageContainer");const o=`Send reminder email to all approved members about "${n.name}" on ${new Date(n.date).toLocaleDateString()}?`;if(!confirm(o))return;const i=document.getElementById("sendReminderEmailBtn"),s=i.textContent;i.textContent="Sending...",i.disabled=!0;try{const o=await fetch("/.netlify/functions/send-event-announcement",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:t,eventName:n.name,eventDate:n.date,eventTime:n.time,eventVenue:n.venue,eventDescription:n.description,isReminder:!0})});o.ok?r(`Reminder sent successfully! ${(await o.json()).stats.sent} emails sent.`,"success","eventModalMessageContainer"):l(`Failed to send reminder: ${(await o.json()).error}`,"eventModalMessageContainer")}catch(d){console.error("Error sending reminder:",d),l("An error occurred while sending the reminder","eventModalMessageContainer")}finally{i.textContent=s,i.disabled=!1}}(t)}),c.addEventListener("click",async function(){await async function(t){const n=a.find(e=>e.id===t);if(!n)return void l("Event not found","eventsMessageContainer");let o=null;try{const e=localStorage.getItem("kartel_admin_user");e&&(o=JSON.parse(e).email)}catch(u){console.error("Error getting stored user data:",u)}if(!o){if(o=prompt("Enter your email address for the test email:"),!o)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o))return void l("Please enter a valid email address","eventsMessageContainer")}const i=document.getElementById("testEmailType"),s=!!i&&"reminder"===i.value,d=document.getElementById("modalSendTestEmailBtn"),c=d.textContent;d.textContent="Sending...",d.disabled=!0;try{const a=await fetch("/.netlify/functions/send-test-email",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({eventId:t,adminEmail:o,eventData:n,isReminder:s})}),i=await a.json();a.ok&&i.success?r(`Test ${s?"reminder":"announcement"} email sent successfully to ${o}!`,"success","eventModalMessageContainer"):l(`Failed to send test email: ${i.error}`,"eventModalMessageContainer")}catch(u){console.error("Error sending test email:",u),l("An error occurred while sending the test email","eventModalMessageContainer")}finally{d.textContent=c,d.disabled=!1}}(t)})}(n.id);const o=document.querySelector(".email-section");o&&(o.style.display="block"),document.getElementById("eventModal").style.display="block"},window.closeEventModal=b,window.deleteEvent=function(e){confirm("Are you sure you want to delete this event?")&&alert("Event deletion feature coming soon!")},window.loadEventPhotos=h,window.displayEventPhotos=E,window.loadEventVideos=w,window.displayEventVideos=I,window.addAttendeeToEvent=k,window.removeAttendeeFromEvent=async function(e,t){try{const n=a.findIndex(t=>t.id===e);if(-1===n)return;a[n].attendees=a[n].attendees.filter(e=>e.memberId!==t),await M(e,a[n].attendees),x(a[n].attendees),r("Attendee removed successfully!","success","eventsMessageContainer")}catch(n){console.error("Error removing attendee:",n),l("Failed to remove attendee. Please try again.","eventsMessageContainer")}},window.toggleAttendeeStatus=async function(e,t){try{const n=a.findIndex(t=>t.id===e);if(-1===n)return;const o=a[n].attendees.find(e=>e.memberId===t);if(!o)return;o.attended=!o.attended,o.statusUpdatedAt=(new Date).toISOString(),await M(e,a[n].attendees),x(a[n].attendees)}catch(n){console.error("Error updating attendee status:",n),l("Failed to update attendance status. Please try again.","eventsMessageContainer")}},window.loadEventAttendees=S,window.loadApprovedMembers=A;let P=[],F=[],L=[];async function N(){try{console.log("Loading gallery management...");try{const t=await fetch("/.netlify/functions/get-gallery",{headers:{Authorization:`Bearer ${e}`}});if(console.log("Get gallery response status:",t.status),t.ok){const e=await t.json();console.log("Gallery data received:",e),P=e.photos||[],O()}else{const e=await t.json().catch(()=>({error:"Unknown error"}));console.log("Gallery fetch error:",e),P=[]}}catch(t){console.error("Error fetching gallery:",t),P=[]}try{await async function(){try{console.log("Loading available photos from events...");const t=await fetch("/.netlify/functions/get-events",{headers:{Authorization:`Bearer ${e}`}});if(console.log("Get events response status:",t.status),!t.ok){const e=await t.json().catch(()=>({error:"Unknown error"}));throw console.error("Events fetch error:",e),new Error(`Failed to fetch events: ${e.error||t.status}`)}{const e=await t.json();console.log("Events data received:",e);const n=e.events||[];F=[],n.forEach(e=>{e.photos&&e.photos.length>0&&(console.log(`Event "${e.name}" has ${e.photos.length} photos`),e.photos.forEach(t=>{F.push({...t,eventName:e.name,eventDate:e.date})}))}),console.log(`Total photos collected: ${F.length}`)}}catch(t){throw console.error("Error loading available photos:",t),t}}(),console.log("Available photos loaded, count:",F.length)}catch(n){console.error("Error loading available photos:",n),F=[]}j(),console.log("Gallery management loaded successfully")}catch(o){console.error("Error in loadGalleryManagement:",o),l(`Failed to load gallery management: ${o.message}`,"galleryMessageContainer")}}function j(){const e=document.getElementById("availablePhotosGrid"),t=document.getElementById("selectedPhotosGrid");console.log("Rendering gallery management. Available photos:",F.length,"Selected photos:",P.length),0===F.length?e.innerHTML='<p style="color: #7f8c8d; text-align: center; grid-column: 1 / -1;">No event photos available. Upload photos to events first.</p>':e.innerHTML=F.map(e=>{const t=e.url||e.src||`/.netlify/functions/get-photo?path=${encodeURIComponent(e.path)}`;return`\n            <div class="photo-item" style="position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); ${P.find(t=>t.id===e.id)?"opacity: 0.5;":""}" \n                 onclick="selectPhoto('${e.id}')">\n                <img src="${t}" alt="${e.caption||"Event photo"}" style="width: 100%; height: 120px; object-fit: cover;">\n                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; padding: 8px 6px 6px; font-size: 0.7rem;">\n                    <div style="font-weight: 600;">${e.eventName}</div>\n                    <div style="opacity: 0.8;">${e.eventDate}</div>\n                </div>\n                ${P.find(t=>t.id===e.id)?'<div style="position: absolute; top: 5px; right: 5px; background: #27ae60; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">‚úì</div>':""}\n            </div>\n            `}).join(""),0===P.length?t.innerHTML='<p style="color: #7f8c8d; text-align: center; grid-column: 1 / -1;">Click photos from the left to add them here</p>':t.innerHTML=P.map(e=>{const t=e.url||e.src||`/.netlify/functions/get-photo?path=${encodeURIComponent(e.path)}`;return`\n            <div class="photo-item" style="position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" \n                 onclick="deselectPhoto('${e.id}')">\n                <img src="${t}" alt="${e.caption||"Event photo"}" style="width: 100%; height: 100px; object-fit: cover;">\n                <div style="position: absolute; top: 2px; right: 2px; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer;">√ó</div>\n            </div>\n            `}).join(""),document.getElementById("selectedCount").textContent=P.length}async function D(){try{const t=await fetch("/.netlify/functions/get-faqs",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=await t.json();L=e.faqs||[],document.getElementById("totalFaqs").textContent=L.length,function(){const e=document.getElementById("faqContainer");0!==L.length?e.innerHTML=L.map(e=>`\n        <div class="faq-item" style="background: white; border: 1px solid #ecf0f1; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">\n            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">\n                <h4 style="color: #2c3e50; font-weight: 600; margin: 0; flex: 1;">${e.question}</h4>\n                <div style="display: flex; gap: 10px; margin-left: 15px;">\n                    <button class="btn btn-secondary btn-small" onclick="editFaq('${e.id}')">Edit</button>\n                    <button class="btn btn-danger btn-small" onclick="deleteFaq('${e.id}')">Delete</button>\n                </div>\n            </div>\n            <p style="color: #5d6d7e; margin: 0; line-height: 1.5;">${e.answer}</p>\n            <small style="color: #95a5a6; display: block; margin-top: 10px;">Order: ${e.order||"Not set"}</small>\n        </div>\n    `).join(""):e.innerHTML='\n            <div class="empty-state">\n                <h3>No FAQs found</h3>\n                <p>Start by adding your first FAQ to help visitors understand The Kartel better.</p>\n                <button class="btn btn-success" onclick="openAddFaqModal()">Add Your First FAQ</button>\n            </div>\n        '}()}}catch(t){console.error("Error loading FAQs:",t),l("Failed to load FAQs. Please try again.","faqMessageContainer")}}function V(){document.getElementById("faqModal").style.display="none"}async function q(){try{const t=await fetch("/.netlify/functions/get-experience-video",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=(await t.json()).vimeoId||"1092055210";document.getElementById("experienceVimeoId").value=e,z(e),U(e)}}catch(t){console.error("Error loading experience video:",t),l("Failed to load experience video. Please try again.","videoMessageContainer")}}function z(e){const t=document.getElementById("experienceVideoPreview");e&&e.trim()?t.innerHTML=`\n            <iframe src="https://player.vimeo.com/video/${e}" \n                    width="100%" height="100%" frameborder="0" \n                    allow="autoplay; fullscreen; picture-in-picture" \n                    allowfullscreen></iframe>\n        `:t.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #7f8c8d;">No video selected</div>'}function O(){document.getElementById("totalGalleryPhotos").textContent=P.length}function U(e){document.getElementById("experienceVideoId").textContent=e||"-",document.getElementById("contentLastUpdated").textContent=(new Date).toLocaleDateString()}document.getElementById("faqForm").addEventListener("submit",async t=>{t.preventDefault();const n=new FormData(t.target),o={id:n.get("faqId")||Date.now().toString(),question:n.get("faqQuestion"),answer:n.get("faqAnswer"),order:parseInt(n.get("faqOrder"))||L.length+1};try{if(!(await fetch("/.netlify/functions/update-faq",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(o)})).ok)throw new Error("Failed to save FAQ");r("FAQ saved successfully!","success","faqMessageContainer"),V(),D()}catch(a){console.error("Error saving FAQ:",a),l("Failed to save FAQ. Please try again.","faqMessage")}}),document.getElementById("experienceVimeoId").addEventListener("input",e=>{z(e.target.value.trim())});let R=null;function H(){document.getElementById("eventConfirmationModal").style.display="none",R=null}async function Q(){try{const t=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=await t.json();return e.applications.filter(e=>"approved"===e.status).length}return 0}catch(t){return console.error("Error loading approved members:",t),0}}window.loadGalleryManagement=N,window.selectPhoto=function(e){if(P.length>=12)return void l("Maximum 12 photos allowed in gallery","galleryMessageContainer");const t=F.find(t=>t.id===e);t&&!P.find(t=>t.id===e)&&(P.push(t),j())},window.deselectPhoto=function(e){P=P.filter(t=>t.id!==e),j()},window.saveGallerySelection=async function(){try{console.log("Saving gallery selection:",P);const t=P.map(e=>({id:e.id,url:e.url||e.src||`/.netlify/functions/get-photo?path=${encodeURIComponent(e.path)}`,alt:e.alt||e.caption||`Photo from ${e.eventName}`,caption:e.caption||`Photo from ${e.eventName}`,eventName:e.eventName,eventDate:e.eventDate,uploadedAt:e.uploadedAt}));console.log("Photos prepared for frontend:",t);const n=await fetch("/.netlify/functions/update-gallery",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({photos:t})});if(console.log("Response status:",n.status),!n.ok){const e=await n.json().catch(()=>({error:"Unknown error"}));throw console.error("Error response:",e),new Error(e.error||`Server error: ${n.status}`)}{const e=await n.json();console.log("Success response:",e),r("Gallery updated successfully!","success","galleryMessageContainer"),O()}}catch(t){console.error("Error saving gallery:",t),l(`Failed to save gallery: ${t.message}`,"galleryMessageContainer")}},window.loadFaqs=D,window.openAddFaqModal=function(){document.getElementById("faqModalTitle").textContent="Add FAQ",document.getElementById("faqId").value="",document.getElementById("faqQuestion").value="",document.getElementById("faqAnswer").value="",document.getElementById("faqOrder").value="",document.getElementById("faqModal").style.display="block"},window.editFaq=function(e){const t=L.find(t=>t.id===e);t&&(document.getElementById("faqModalTitle").textContent="Edit FAQ",document.getElementById("faqId").value=t.id,document.getElementById("faqQuestion").value=t.question,document.getElementById("faqAnswer").value=t.answer,document.getElementById("faqOrder").value=t.order||"",document.getElementById("faqModal").style.display="block")},window.closeFaqModal=V,window.deleteFaq=async function(t){if(confirm("Are you sure you want to delete this FAQ?"))try{if(!(await fetch("/.netlify/functions/delete-faq",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({id:t})})).ok)throw new Error("Failed to delete FAQ");r("FAQ deleted successfully!","success","faqMessageContainer"),D()}catch(n){console.error("Error deleting FAQ:",n),l("Failed to delete FAQ. Please try again.","faqMessageContainer")}},window.seedFaqs=async function(){if(confirm("This will populate the CMS with the existing FAQs from the website. Continue?"))try{const t=await fetch("/.netlify/functions/seed-faqs",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Failed to seed FAQs");r((await t.json()).message,"success","faqMessageContainer"),D()}catch(t){console.error("Error seeding FAQs:",t),l("Failed to seed FAQs. Please try again.","faqMessageContainer")}},window.loadExperienceVideo=q,window.updateExperienceVideo=async function(){const t=document.getElementById("experienceVimeoId").value.trim();if(t)try{if(!(await fetch("/.netlify/functions/update-experience-video",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({vimeoId:t})})).ok)throw new Error("Failed to update experience video");r("Experience video updated successfully!","success","videoMessageContainer"),z(t),U(t)}catch(n){console.error("Error updating experience video:",n),l("Failed to update experience video. Please try again.","videoMessageContainer")}else l("Please enter a Vimeo video ID","videoMessageContainer")},window.closeApplicantModal=B,window.closeEventConfirmationModal=H,window.switchToMemberView=function(){const e=localStorage.getItem("kartel_admin_user");if(e)try{const t=JSON.parse(e);console.log("üë®‚Äçüíº Switching to member view for admin:",t.email),sessionStorage.setItem("switched_from_admin","true"),window.location.href="/members.html"}catch(t){console.error("Error parsing admin user data:",t),window.location.href="/members.html"}else window.location.href="/members.html"},window.showDashboard=function(){console.log("üè† showDashboard() called"),console.log("üè† Hiding login section, showing dashboard section"),document.getElementById("loginSection").classList.add("hidden"),document.getElementById("dashboardSection").classList.remove("hidden"),console.log("üè† Calling loadApplications() from showDashboard()"),y()},window.loadApplications=y,window.loadVenuesForDropdown=u,window.kartelAuth=new n,window.kartelTopBar=new o,window.NotificationManager=NotificationManager,console.log("üì¶ Admin bundle loaded")}}});
