function e(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}import{K as t,a as n,N as NotificationManager}from"../notification-manager-cYTXerfR.min.js";let o=localStorage.getItem("kartel_admin_token"),a=[],i=[],s=[],d=null;function c(){return o=localStorage.getItem("kartel_admin_token")||localStorage.getItem("kartel_auth_token")||localStorage.getItem("kartel_member_token")||window.kartelAuth&&window.kartelAuth.getToken(),o}function r(e){if(!e)return"";const t=e.trim();if(!t)return"";const n=[/^https?:\/\/(www\.)?linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?linkedin\.com\/pub\/([a-zA-Z0-9\-]+)\/?.*$/,/^https?:\/\/(www\.)?uk\.linkedin\.com\/pub\/([a-zA-Z0-9\-]+)\/?.*$/,/^linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^www\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^www\.uk\.linkedin\.com\/in\/([a-zA-Z0-9\-]+)\/?.*$/,/^([a-zA-Z0-9\-]+)$/];for(const a of n){const e=t.match(a);if(e)return e[2]||e[1]}const o=t.match(/(uk\.)?linkedin\.com\/in\/([a-zA-Z0-9\-]+)/);return o?o[2]:(/^[a-zA-Z0-9\-]+$/.test(t),t)}function l(e,t="success",n="messageContainer"){const o=document.getElementById(n);o.innerHTML='<div class="'.concat(t,'">').concat(e,"</div>"),setTimeout(()=>o.innerHTML="",5e3)}function u(e,t="messageContainer"){l(e,"error",t)}async function m(){try{const e=await fetch("/.netlify/functions/get-venues",{headers:{Authorization:"Bearer ".concat(o)}});if(401===e.status)return o=null,localStorage.removeItem("kartel_admin_token"),void A();if(!e.ok)throw new Error("Failed to load venues");const t=await e.json();s=t.venues||[],function(){const e=s.length,t=s.filter(e=>{const t=new Date(e.createdAt),n=new Date;return t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()}).length;document.getElementById("totalVenues").textContent=e,document.getElementById("activeVenues").textContent=e,document.getElementById("venuesWithEvents").textContent=0,document.getElementById("recentVenues").textContent=t}(),g()}catch(e){console.error("Error loading venues:",e),u("Failed to load venues. Please try again.","venuesMessageContainer")}}async function p(){try{c(),console.log("üè¢ loadVenuesForDropdown() called, authToken:",o?"present":"missing");const e=await fetch("/.netlify/functions/get-venues",{headers:{Authorization:"Bearer ".concat(o)}});if(console.log("üè¢ Venues API response status:",e.status),e.ok){const t=await e.json();s=t.venues||[],console.log("üè¢ Venues loaded:",s.length,"venues"),function(){const e=document.getElementById("eventVenue");for(;e.children.length>2;)e.removeChild(e.lastChild);s.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})}()}}catch(e){console.error("üè¢ Error loading venues for dropdown:",e)}}function g(e=null){var t;const n=document.getElementById("venuesContainer"),o=e||s;if(0===o.length)return void(n.innerHTML='\n            <div class="search-container">\n                <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()">\n            </div>\n            <div class="empty-state">\n                <h3>No venues found</h3>\n                <p>Start by adding your first karting venue to manage events effectively.</p>\n                <button class="btn btn-success" onclick="openAddVenueModal()">Add Your First Venue</button>\n            </div>\n        ');const a=o.map(e=>'\n        <div class="venue-card">\n            <div class="venue-name">'.concat(e.name,'</div>\n            <div class="venue-details">\n                <div class="venue-detail"><strong>Address:</strong> ').concat(e.address,"</div>\n                ").concat(e.phone?'<div class="venue-detail"><strong>Phone:</strong> '.concat(e.phone,"</div>"):"","\n                ").concat(e.website?'<div class="venue-detail"><strong>Website:</strong> <a href="'.concat(e.website,'" target="_blank" style="color: #e74c3c;">Visit Site</a></div>'):"","\n                ").concat(e.notes?'<div class="venue-detail"><strong>Notes:</strong> '.concat(e.notes,"</div>"):"","\n                ").concat(e.drivingTips?'<div class="venue-detail"><strong>Driving Tips:</strong> '.concat(e.drivingTips.substring(0,100)).concat(e.drivingTips.length>100?"...":"","</div>"):"","\n                ").concat(e.vimeoId?'<div class="venue-detail"><strong>Video:</strong> <a href="https://vimeo.com/'.concat(e.vimeoId,'" target="_blank" style="color: #e74c3c;">Watch on Vimeo</a></div>'):"","\n                ").concat(e.trackMapPath?'<div class="venue-detail"><strong>Track Map:</strong> <span style="color: #27ae60;">‚úì Available</span></div>':"",'\n                <div class="venue-detail"><strong>Added:</strong> ').concat(new Date(e.createdAt).toLocaleDateString(),'</div>\n            </div>\n            <div class="venue-actions">\n                <button class="action-btn edit-btn btn-small" onclick="editVenue(\'').concat(e.id,'\')">Edit</button>\n                <button class="action-btn delete-btn btn-small" onclick="deleteVenue(\'').concat(e.id,"')\">Delete</button>\n            </div>\n        </div>\n    ")).join("");n.innerHTML='\n        <div class="search-container">\n            <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()" value="'.concat((null==(t=document.getElementById("venueSearch"))?void 0:t.value)||"",'">\n        </div>\n        <div class="venues-grid">').concat(a,"</div>\n    ")}function v(){d=null,document.getElementById("modalTitle").textContent="Add New Venue",document.getElementById("venueForm").reset(),document.getElementById("trackMapPreview").style.display="none",document.getElementById("vimeoPreview").style.display="none",document.getElementById("vimeoPreview").querySelector("iframe").src="",document.getElementById("venueModal").style.display="block"}function y(){document.getElementById("venueModal").style.display="none",d=null}let f=!1;async function h(){if(f)console.log("üìã loadApplications() already in progress, skipping...");else try{f=!0,c(),console.log("üìã loadApplications() called, authToken:",o?"present":"missing"),console.log("üìã Making API call to get-applications...");const e=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:"Bearer ".concat(o)}});if(console.log("üìã API response status:",e.status),401===e.status)return console.log("üìã 401 Unauthorized - clearing token"),o=null,localStorage.removeItem("kartel_admin_token"),void A();if(!e.ok)throw new Error("Failed to load applications");const t=await e.json();console.log("üìã Applications data received:",t.applications?t.applications.length:0,"applications"),a=t.applications||[],function(){const e=a.length,t=a.filter(e=>"pending"===e.status).length,n=a.filter(e=>"approved"===e.status).length,o=a.filter(e=>"rejected"===e.status).length;document.getElementById("totalApplications").textContent=e,document.getElementById("pendingApplications").textContent=t,document.getElementById("approvedApplications").textContent=n,document.getElementById("rejectedApplications").textContent=o}(),function(){const e=document.getElementById("applicationsTableBody");if(0===a.length)return void(e.innerHTML='<tr><td colspan="8" class="loading">No applications found</td></tr>');e.innerHTML=a.map(e=>"\n        <tr>\n            <td>\n                <strong>".concat(e.fullName||"".concat(e.firstName||""," ").concat(e.lastName||"").trim()||e.name||"N/A","</strong>\n                ").concat(e.isAdmin?'<br><span style="color: #e74c3c; font-weight: bold; font-size: 12px;">üëë Administrator</span>':"","\n                ").concat(e.importedAt?'<br><small style="color: #6c757d;">üì• Imported</small>':"","\n            </td>\n            <td>").concat(e.email,"</td>\n            <td>\n                <strong>").concat(e.company||"N/A","</strong>\n                ").concat(e.position?"<br><small>".concat(e.position,"</small>"):"","\n            </td>\n            <td>").concat(e.phone,"</td>\n            <td>\n                ").concat(e.linkedin?'<a href="https://linkedin.com/in/'.concat(e.linkedin,'" target="_blank" style="color: #0077b5; text-decoration: none;">üîó ').concat(e.linkedin,"</a>"):"N/A",'\n            </td>\n            <td><span class="status-badge status-').concat(e.status,'">').concat(e.status,"</span></td>\n            <td>").concat(new Date(e.submittedAt).toLocaleDateString(),"</td>\n            <td>\n                ").concat("pending"===e.status?'\n                    <button class="action-btn approve-btn" onclick="updateApplication(\''.concat(e.id,"', 'approved')\">Approve</button>\n                    <button class=\"action-btn reject-btn\" onclick=\"updateApplication('").concat(e.id,"', 'rejected')\">Reject</button>\n                "):"",'\n                <button class="action-btn details-btn" onclick="showDetails(\'').concat(e.id,'\')">Details</button>\n                <button class="action-btn delete-btn" onclick="deleteApplication(\'').concat(e.id,"')\">Delete</button>\n            </td>\n        </tr>\n    ")).join("")}(),console.log("üìã loadApplications() completed successfully")}catch(e){console.error("üìã Error loading applications:",e),u("Failed to load applications. Please try again.")}finally{f=!1,console.log("üìã loadApplications() flag reset")}}async function w(){try{const e=await fetch("/.netlify/functions/get-events",{headers:{Authorization:"Bearer ".concat(o)}});if(401===e.status)return o=null,localStorage.removeItem("kartel_admin_token"),void A();if(!e.ok)throw new Error("Failed to load events");const t=await e.json();i=t.events||[],function(){const e=i.length,t=i.filter(e=>"upcoming"===e.status).length,n=i.filter(e=>"completed"===e.status).length,o=i.reduce((e,t)=>e+(t.photos?t.photos.length:0),0);document.getElementById("totalEvents").textContent=e,document.getElementById("upcomingEvents").textContent=t,document.getElementById("completedEvents").textContent=n,document.getElementById("totalPhotos").textContent=o}(),function(){const e=document.getElementById("eventsTableBody");if(0===i.length)return void(e.innerHTML='<tr><td colspan="8" class="loading">No events found</td></tr>');e.innerHTML=i.map(e=>"\n        <tr>\n            <td><strong>".concat(e.name,"</strong></td>\n            <td>").concat(new Date(e.date).toLocaleDateString()).concat(e.time?"<br><small>".concat(e.time,"</small>"):"","</td>\n            <td><strong>").concat(e.venue,'</strong></td>\n            <td>\n                <span class="status-badge status-approved">').concat(e.attendees?e.attendees.length:0,"</span>\n                ").concat(e.attendees&&e.attendees.length>0?"<br><small>".concat(e.attendees.filter(e=>e.attended).length," attended</small>"):"",'\n            </td>\n            <td><span class="status-badge status-approved">').concat(e.photos?e.photos.length:0,'</span></td>\n            <td><span class="status-badge status-pending">').concat(e.videos?e.videos.length:0,'</span></td>\n            <td><span class="status-badge status-').concat(e.status,'">').concat(e.status,'</span></td>\n            <td>\n                <button class="action-btn edit-btn" onclick="editEvent(\'').concat(e.id,'\')">Edit</button>\n                <button class="action-btn delete-btn" onclick="deleteEvent(\'').concat(e.id,"')\">Delete</button>\n            </td>\n        </tr>\n    ")).join("")}()}catch(e){console.error("Error loading events:",e),u("Failed to load events. Please try again.","eventsMessageContainer")}}async function E(e){try{const t=await fetch("/.netlify/functions/get-events",{headers:{Authorization:"Bearer ".concat(o)}});if(t.ok){const n=(await t.json()).events.find(t=>t.id===e);n&&n.photos?I(n.photos):I([])}}catch(t){console.error("Error loading event photos:",t)}}function I(e){const t=document.getElementById("eventPhotosGrid");if(!e||0===e.length)return void(t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No photos uploaded yet</p>');const n=e.map(e=>'\n        <div class="photo-item">\n            <img src="/.netlify/functions/get-photo?path='.concat(encodeURIComponent(e.path),'" \n                alt="').concat(e.caption||"Event photo",'"\n                onerror="this.style.display=\'none\'">\n            ').concat(e.caption?'<div class="photo-caption">'.concat(e.caption,"</div>"):"","\n        </div>\n    ")).join("");t.innerHTML=n}async function b(e){try{const t=await fetch("/.netlify/functions/get-events",{headers:{Authorization:"Bearer ".concat(o)}});if(t.ok){const n=(await t.json()).events.find(t=>t.id===e);n&&n.videos?B(n.videos):B([])}}catch(t){console.error("Error loading event videos:",t)}}function B(e){const t=document.getElementById("eventVideosGrid");if(!e||0===e.length)return void(t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No videos uploaded yet</p>');const n=e.map(e=>'\n        <div style="border: 1px solid #ecf0f1; border-radius: 8px; padding: 15px; background: white;">\n            <div style="aspect-ratio: 16/9; margin-bottom: 10px;">\n                <iframe src="https://player.vimeo.com/video/'.concat(e.vimeoId,'" \n                        width="100%" height="100%" frameborder="0" \n                        allow="autoplay; fullscreen; picture-in-picture" allowfullscreen\n                        style="border-radius: 4px;">\n                </iframe>\n            </div>\n            <h5 style="color: #2c3e50; margin-bottom: 5px; font-size: 1rem;">').concat(e.title||"Untitled Video","</h5>\n            ").concat(e.description?'<p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 8px;">'.concat(e.description,"</p>"):"",'\n            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #999;">\n                <span>Uploaded: ').concat(new Date(e.uploadedAt).toLocaleDateString(),'</span>\n                <a href="https://vimeo.com/').concat(e.vimeoId,'" target="_blank" style="color: #3498db;">View on Vimeo</a>\n            </div>\n        </div>\n    ')).join("");t.innerHTML=n}function C(){document.getElementById("eventModal").style.display="none";const e=document.querySelector(".email-section");e&&(e.style.display="none")}function k(){document.getElementById("applicantModal").style.display="none"}function A(){document.getElementById("loginSection").classList.remove("hidden"),document.getElementById("dashboardSection").classList.add("hidden")}async function M(){const e=new URLSearchParams(window.location.search),t=e.get("action"),n=e.get("id"),a=e.get("token");t&&n&&a&&(console.log("üöÄ Processing quick action from URL: ".concat(t," for ").concat(n)),window.history.replaceState({},document.title,window.location.pathname),await async function(e,t,n){var a;try{l("Processing quick action...","info","messageContainer");const i=await fetch("/.netlify/functions/quick-action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:e,applicationId:t,actionToken:n})}),s=await i.json();if(i.ok&&s.success){const t="approve"===e?"approved":"rejected";l("‚úÖ Application from ".concat((null==(a=s.application)?void 0:a.name)||"applicant"," has been ").concat(t," successfully!"),"success","messageContainer"),o&&h()}else l("‚ùå Quick action failed: ".concat(s.error||"Unknown error"),"error","messageContainer")}catch(i){console.error("Quick action error:",i),l("‚ùå Quick action failed due to network error","error","messageContainer")}}(t,n,a))}async function x(){try{const e=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:"Bearer ".concat(o)}});if(e.ok){const t=(await e.json()).applications.filter(e=>"approved"===e.status);return function(e){const t=document.getElementById("memberSelect");for(;t.children.length>1;)t.removeChild(t.lastChild);e.forEach(e=>{const n=document.createElement("option");n.value=e.id;const o=e.fullName||"".concat(e.firstName||""," ").concat(e.lastName||"").trim()||e.name||"Unknown";n.textContent="".concat(o," (").concat(e.company||"No company",")"),n.dataset.email=e.email,n.dataset.company=e.company||"",t.appendChild(n)})}(t),t}}catch(e){console.error("Error loading approved members:",e)}return[]}async function S(e,t){try{const n=i.findIndex(t=>t.id===e);if(-1===n)return;i[n].attendees||(i[n].attendees=[]),i[n].attendees.push(t),await T(e,i[n].attendees),P(i[n].attendees),l("Attendee added successfully!","success","eventsMessageContainer")}catch(n){console.error("Error adding attendee:",n),u("Failed to add attendee. Please try again.","eventsMessageContainer")}}async function T(e,t){const n=await fetch("/.netlify/functions/update-event",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:e,updates:{attendees:t}})});if(!n.ok)throw new Error("Failed to update event attendees");return await n.json()}function P(e){const t=document.getElementById("attendeesList");if(!e||0===e.length)return t.innerHTML='<p style="color: #7f8c8d; text-align: center; padding: 20px;">No attendees added yet</p>',void F(0,0,0);const n=e.filter(e=>e.attended).length,o=e.filter(e=>!e.attended).length;F(e.length,n,o);const a=e.map(e=>'\n        <div class="attendee-item">\n            <div class="attendee-info">\n                <div class="attendee-name">'.concat(e.name,'</div>\n                <div class="attendee-details">\n                    ').concat(e.company?"".concat(e.company," ‚Ä¢ "):"").concat(e.email,"\n                    <br><small>Registered: ").concat(new Date(e.registeredAt).toLocaleDateString(),'</small>\n                </div>\n            </div>\n            <div class="attendee-status">\n                <span style="font-size: 0.8rem; margin-right: 8px;">\n                    ').concat(e.attended?"Attended":"Registered",'\n                </span>\n                <div class="status-toggle ').concat(e.attended?"attended":"",'" \n                    onclick="toggleAttendeeStatus(\'').concat(document.getElementById("editEventId").value,"', '").concat(e.memberId,'\')">\n                </div>\n                <button class="remove-attendee" \n                        onclick="removeAttendeeFromEvent(\'').concat(document.getElementById("editEventId").value,"', '").concat(e.memberId,"')\">\n                    Remove\n                </button>\n            </div>\n        </div>\n    ")).join("");t.innerHTML=a}function F(e,t,n){document.getElementById("registeredCount").textContent=e,document.getElementById("attendedCount").textContent=t,document.getElementById("noShowCount").textContent=n}async function L(e){const t=i.find(t=>t.id===e);t&&t.attendees?P(t.attendees):P([])}document.getElementById("photoUpload").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("photoPreview"),o=document.getElementById("uploadPhotoBtn");if(t){const e=new FileReader;e.onload=function(e){n.src=e.target.result,n.style.display="block",o.disabled=!1},e.readAsDataURL(t)}else n.style.display="none",o.disabled=!0}),document.getElementById("uploadPhotoBtn").addEventListener("click",async function(){const e=document.getElementById("photoUpload"),t=document.getElementById("photoCaption"),n=document.getElementById("editEventId").value;if(!e.files[0]||!n)return void u("Please select a photo and ensure an event is selected","eventsMessageContainer");const a=e.files[0],i=t.value.trim(),s=new FileReader;s.onload=async function(s){const d=s.target.result,c=document.getElementById("uploadPhotoBtn"),r=c.textContent;c.textContent="Uploading...",c.disabled=!0;try{const s=await fetch("/.netlify/functions/upload-photo",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:n,photoData:d,fileName:a.name,caption:i})}),c=await s.json();s.ok&&c.success?(l("Photo uploaded successfully!","success","eventsMessageContainer"),e.value="",t.value="",document.getElementById("photoPreview").style.display="none",await E(n),w()):u(c.error||"Failed to upload photo","eventsMessageContainer")}catch(m){console.error("Photo upload error:",m),u("Failed to upload photo. Please try again.","eventsMessageContainer")}finally{c.textContent=r,c.disabled=!1}},s.readAsDataURL(a)}),document.getElementById("videoUpload").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("videoPreview"),o=document.getElementById("uploadVideoBtn");if(t){const a=524288e3;if(t.size>a)return u("Video file size must be less than 500MB","eventsMessageContainer"),void(e.target.value="");const i=URL.createObjectURL(t);n.src=i,n.style.display="block",o.disabled=!1;const s=document.getElementById("videoTitle");s.value||(s.value=t.name.replace(/\.[^/.]+$/,""))}else n.style.display="none",o.disabled=!0}),document.getElementById("uploadVideoBtn").addEventListener("click",async function(){const e=document.getElementById("videoUpload"),t=document.getElementById("videoTitle"),n=document.getElementById("videoDescription"),a=document.getElementById("editEventId").value;if(!e.files[0]||!a)return void u("Please select a video and ensure an event is selected","eventsMessageContainer");const i=e.files[0],s=t.value.trim()||i.name,d=n.value.trim(),c=this,r=c.textContent,m=document.getElementById("uploadProgress"),p=document.getElementById("progressBar");c.textContent="Preparing Upload...",c.disabled=!0,m.style.display="block",p.style.width="10%";try{const g=new FileReader;g.onload=async function(g){const v=g.target.result;p.style.width="30%",c.textContent="Uploading to Vimeo...";try{const c=await fetch("/.netlify/functions/upload-video-vimeo",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:a,videoData:v,fileName:i.name,title:s,description:d})});p.style.width="90%";const r=await c.json();c.ok&&r.success?(p.style.width="100%",l('Video uploaded successfully to Vimeo! <a href="'.concat(r.vimeoUrl,'" target="_blank">View Video</a>'),"success","eventsMessageContainer"),e.value="",t.value="",n.value="",document.getElementById("videoPreview").style.display="none",await b(a),w()):u(r.error||"Failed to upload video to Vimeo","eventsMessageContainer")}catch(y){console.error("Video upload error:",y),u("Failed to upload video. Please try again.","eventsMessageContainer")}finally{c.textContent=r,c.disabled=!1,m.style.display="none",p.style.width="0%"}},g.readAsDataURL(i)}catch(g){console.error("Video processing error:",g),u("Failed to process video file. Please try again.","eventsMessageContainer"),c.textContent=r,c.disabled=!1,m.style.display="none"}}),document.addEventListener("DOMContentLoaded",function(){M(),console.log("üìù Admin.js loaded - authentication handled by unified system"),document.getElementById("refreshBtn").addEventListener("click",h),document.getElementById("refreshEventsBtn").addEventListener("click",w),document.getElementById("refreshVenuesBtn").addEventListener("click",m),document.getElementById("recoverBtn").addEventListener("click",async()=>{if(!confirm("‚ö†Ô∏è RECOVER DATA\n\nThis will attempt to rebuild the applications list from individual member records.\n\nThis is safe to run and will not delete any data.\n\nProceed?"))return;const e=document.getElementById("recoverBtn"),t=e.textContent;e.textContent="üîÑ Recovering...",e.disabled=!0;try{const e=await fetch("/.netlify/functions/recover-applications-list",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"}}),t=await e.json();e.ok&&t.success?(l("‚úÖ Recovery successful! Recovered ".concat(t.recovered," members. Status: ").concat(JSON.stringify(t.statusBreakdown)),"success"),setTimeout(()=>{h()},1e3)):u("‚ùå Recovery failed: ".concat(t.error||"Unknown error"))}catch(n){console.error("Recovery error:",n),u("‚ùå Recovery failed due to network error")}finally{e.textContent=t,e.disabled=!1}}),document.getElementById("venueForm").addEventListener("submit",async function(e){e.preventDefault();const t=new FormData(this),n={name:t.get("venueName").trim(),address:t.get("venueAddress").trim(),phone:t.get("venuePhone").trim(),website:t.get("venueWebsite").trim(),notes:t.get("venueNotes").trim(),drivingTips:t.get("venueDrivingTips").trim(),vimeoId:t.get("venueVimeoId").trim()},a=t.get("venueTrackMap");if(a&&a.size>0){const e=new FileReader,t=await new Promise((t,n)=>{e.onload=e=>t(e.target.result),e.onerror=n,e.readAsDataURL(a)});n.trackMap={data:t,fileName:a.name,fileType:a.type}}if(!n.name||!n.address)return void u("Please fill in all required fields","venuesMessageContainer");const i=this.querySelector('button[type="submit"]'),s=i.textContent;i.textContent="Saving...",i.disabled=!0;try{let e;e=d?await fetch("/.netlify/functions/update-venue",{method:"PUT",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({venueId:d,...n})}):await fetch("/.netlify/functions/create-venue",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify(n)});const t=await e.json();e.ok&&t.success?(l(t.message,"success","venuesMessageContainer"),y(),m(),p()):u(t.error||"Failed to save venue","venuesMessageContainer")}catch(c){console.error("Error saving venue:",c),u("Failed to save venue. Please try again.","venuesMessageContainer")}finally{i.textContent=s,i.disabled=!1}}),document.getElementById("venueTrackMap").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("trackMapPreview"),o=document.getElementById("trackMapImage");if(t){const e=new FileReader;e.onload=function(e){o.src=e.target.result,n.style.display="block"},e.readAsDataURL(t)}else n.style.display="none"}),document.getElementById("venueVimeoId").addEventListener("input",function(e){const t=e.target.value.trim(),n=document.getElementById("vimeoPreview"),o=n.querySelector("iframe");t&&/^\d+$/.test(t)?(o.src="https://player.vimeo.com/video/".concat(t),n.style.display="block"):(n.style.display="none",o.src="")}),document.getElementById("seedVenuesBtn").addEventListener("click",async function(){if(!confirm("This will add default venues if none exist. Continue?"))return;const e=this,t=e.textContent;e.textContent="Seeding...",e.disabled=!0;try{const e=await fetch("/.netlify/functions/seed-venues",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"}}),t=await e.json();e.ok?(l(t.message,"success","venuesMessageContainer"),t.success&&(m(),p())):u(t.error||"Failed to seed venues","venuesMessageContainer")}catch(n){console.error("Error seeding venues:",n),u("Failed to seed venues. Please try again.","venuesMessageContainer")}finally{e.textContent=t,e.disabled=!1}}),document.getElementById("eventVenue").addEventListener("change",function(){"add-new"===this.value&&(v(),this.value="")}),document.getElementById("eventForm").addEventListener("submit",async function(e){e.preventDefault();const t=new FormData(e.target),n=t.get("eventVenue");if(!n)return void u("Please select a venue","eventsMessageContainer");const o=s.find(e=>e.id===n),a={name:t.get("eventName"),date:t.get("eventDate"),time:t.get("eventTime"),venueId:n,venue:o?o.name:"",venueAddress:o?o.address:"",maxAttendees:t.get("eventMaxAttendees"),description:t.get("eventDescription"),sendAnnouncement:"on"===t.get("sendAnnouncement")};await async function(e){Q=e,document.getElementById("confirmEventName").textContent=e.name||"Not specified",document.getElementById("confirmEventDate").textContent=e.date?new Date(e.date).toLocaleDateString():"Not specified",document.getElementById("confirmEventTime").textContent=e.time||"Not specified",document.getElementById("confirmEventVenue").textContent=e.venue||"Not specified",document.getElementById("confirmEventMaxAttendees").textContent=e.maxAttendees||"No limit",document.getElementById("confirmEventDescription").textContent=e.description||"No description";const t=document.getElementById("announcementInfo"),n=document.getElementById("confirmButtonText");if(e.sendAnnouncement){t.style.display="block",n.textContent="Confirm & Send";try{const e=await $();document.getElementById("approvedMemberCount").textContent=e}catch(o){console.error("Error loading approved members count:",o),document.getElementById("approvedMemberCount").textContent="Unknown"}}else t.style.display="none",n.textContent="Confirm & Create Event";document.getElementById("eventConfirmationModal").style.display="block"}(a)}),document.getElementById("editEventForm").addEventListener("submit",async function(e){e.preventDefault();const t=new FormData(this),n=t.get("editEventId"),a=t.get("editEventVenue");if(!a)return void u("Please select a venue","eventsMessageContainer");const i=s.find(e=>e.id===a),d={name:t.get("editEventName"),date:t.get("editEventDate"),time:t.get("editEventTime"),venueId:a,venue:i?i.name:"",venueAddress:i?i.address:"",maxAttendees:t.get("editEventMaxAttendees"),status:t.get("editEventStatus"),description:t.get("editEventDescription")},c=this.querySelector('button[type="submit"]'),r=c.textContent;c.textContent="Updating...",c.disabled=!0;try{const e=await fetch("/.netlify/functions/update-event",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:n,updates:d})}),t=await e.json();e.ok&&t.success?(l("Event updated successfully!","success","eventsMessageContainer"),C(),w()):u(t.error||"Failed to update event","eventsMessageContainer")}catch(m){console.error("Event update error:",m),u("Failed to update event. Please try again.","eventsMessageContainer")}finally{c.textContent=r,c.disabled=!1}}),document.getElementById("applicantForm").addEventListener("submit",async function(e){e.preventDefault();const t=new FormData(this),n={applicationId:t.get("applicantId"),firstName:t.get("applicantFirstName").trim(),lastName:t.get("applicantLastName").trim(),email:t.get("applicantEmail").trim(),company:t.get("applicantCompany").trim(),position:t.get("applicantPosition").trim(),phone:t.get("applicantPhone").trim(),linkedin:r(t.get("applicantLinkedin")),status:t.get("applicantStatus"),isAdmin:document.getElementById("applicantIsAdmin").checked};if(!n.firstName||!n.lastName||!n.email)return void l("First name, last name, and email are required.","error","applicantMessage");const a=this.querySelector('button[type="submit"]'),i=a.textContent;a.textContent="Saving...",a.disabled=!0;try{const e=await async function(e){try{const t=await fetch("/.netlify/functions/update-applicant-details",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify(e)});if(401===t.status)return o=null,localStorage.removeItem("kartel_admin_token"),A(),!1;const n=await t.json();return t.ok&&n.success?(l("Applicant details updated successfully!","success","messageContainer"),h(),!0):(l(n.error||"Failed to update applicant details.","error","applicantMessage"),!1)}catch(t){return console.error("Error updating applicant details:",t),l("Failed to update applicant details due to network error. Please try again.","error","applicantMessage"),!1}}(n);e&&setTimeout(()=>{k()},2e3)}finally{a.textContent=i,a.disabled=!1}}),document.getElementById("confirmCreateEventBtn").addEventListener("click",async function(){await async function(){if(!Q)return void u("No event data found","eventsMessageContainer");const e=document.getElementById("confirmCreateEventBtn"),t=e.innerHTML;e.innerHTML="Creating...",e.disabled=!0;try{const e=await fetch("/.netlify/functions/create-event",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify(Q)}),t=await e.json();e.ok&&t.success?(J(),l("Event created successfully!","success","eventsMessageContainer"),document.getElementById("eventForm").reset(),w()):u(t.error||"Failed to create event","eventsMessageContainer")}catch(n){console.error("Event creation error:",n),u("Failed to create event. Please try again.","eventsMessageContainer")}finally{e.innerHTML=t,e.disabled=!1}}()}),document.getElementById("sendTestEmailBtn").addEventListener("click",async function(){await async function(){if(!Q)return void u("No event data found","eventsMessageContainer");let e=null;try{const t=localStorage.getItem("kartel_admin_user");if(t){e=JSON.parse(t).email}}catch(a){console.error("Error getting stored user data:",a)}if(!e){if(e=prompt("Enter your email address for the test email:"),!e)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return void u("Please enter a valid email address","eventsMessageContainer")}const t=document.getElementById("sendTestEmailBtn"),n=t.textContent;t.textContent="Sending...",t.disabled=!0;try{const t={...Q,id:"test-".concat(Date.now()),createdAt:(new Date).toISOString()},n=await fetch("/.netlify/functions/send-test-email",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:t.id,adminEmail:e,eventData:t})}),a=await n.json();n.ok&&a.success?l("Test email sent successfully to ".concat(e,"!"),"success","eventsMessageContainer"):u(a.error||"Failed to send test email","eventsMessageContainer")}catch(a){console.error("Test email error:",a),u("Failed to send test email. Please try again.","eventsMessageContainer")}finally{t.textContent=n,t.disabled=!1}}()}),window.onclick=function(e){const t=document.getElementById("venueModal"),n=document.getElementById("eventModal"),o=document.getElementById("applicantModal"),a=document.getElementById("eventConfirmationModal");e.target===t&&y(),e.target===n&&C(),e.target===o&&k(),e.target===a&&J()};const e=document.getElementById("videoUpload"),t=document.getElementById("videoTitle"),n=document.getElementById("videoDescription"),a=document.getElementById("videoPreview"),i=document.getElementById("uploadVideoBtn"),c=document.getElementById("uploadProgress"),g=document.getElementById("progressBar");e.addEventListener("change",function(n){const o=n.target.files[0];if(!o)return a.style.display="none",void(i.disabled=!0);if(o.size>524288e3)return alert("File size must be less than 500MB"),e.value="",a.style.display="none",void(i.disabled=!0);if(!["video/mp4","video/mov","video/quicktime","video/avi"].includes(o.type))return alert("Please select a valid video file (MP4, MOV, AVI)"),e.value="",a.style.display="none",void(i.disabled=!0);const s=URL.createObjectURL(o);a.src=s,a.style.display="block",i.disabled=!1,t.value||(t.value=o.name.replace(/\.[^/.]+$/,""))}),i.addEventListener("click",async function(){const s=e.files[0];if(!s)return;const d=document.getElementById("editEventId").value;if(!d)return void alert("Please save the event first before uploading videos");const r=t.value.trim()||s.name,m=n.value.trim();c.style.display="block",i.disabled=!0,i.textContent="Uploading...",g.style.width="10%";try{const i=await new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=t,n.readAsDataURL(s)});g.style.width="30%";const c=await fetch("/.netlify/functions/upload-video-vimeo",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:d,videoData:i,fileName:s.name,title:r,description:m})});if(g.style.width="80%",!c.ok){const e=await c.json();throw new Error(e.error||"Upload failed")}const u=await c.json();if(g.style.width="100%",!u.success)throw new Error(u.error||"Upload failed");l("Video uploaded to Vimeo successfully!","success","eventsMessageContainer"),e.value="",t.value="",n.value="",a.style.display="none",b(d),w()}catch(p){console.error("Video upload error:",p),u("Video upload failed: ".concat(p.message),"eventsMessageContainer")}finally{c.style.display="none",i.disabled=!1,i.textContent="Upload to Vimeo",g.style.width="0%"}}),console.log("üîß Admin.js loaded, waiting for unified auth...")}),document.getElementById("memberSelect").addEventListener("change",function(){document.getElementById("addAttendeeBtn").disabled=!this.value}),document.getElementById("addAttendeeBtn").addEventListener("click",function(){var e;const t=document.getElementById("memberSelect"),n=t.options[t.selectedIndex];if(!n.value)return;const o=document.getElementById("editEventId").value,a=n.value,s=n.textContent.split(" (")[0],d=n.dataset.email,c=n.dataset.company;(null==(e=i.find(e=>e.id===o).attendees)?void 0:e.find(e=>e.memberId===a))?u("This member is already added to the event","eventsMessageContainer"):(S(o,{memberId:a,name:s,email:d,company:c,registeredAt:(new Date).toISOString(),attended:!1}),t.value="",document.getElementById("addAttendeeBtn").disabled=!0)}),window.switchTab=function(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),document.getElementById(e+"Tab").classList.add("active"),event.target.classList.add("active"),"applications"===e?h():"events"===e?(w(),p()):"venues"===e?m():"content"===e&&(V(),z(),U())},window.openAddVenueModal=v,window.closeVenueModal=y,window.editVenue=function(e){const t=s.find(t=>t.id===e);if(!t)return;d=e,document.getElementById("modalTitle").textContent="Edit Venue",document.getElementById("venueId").value=t.id,document.getElementById("venueName").value=t.name,document.getElementById("venueAddress").value=t.address,document.getElementById("venuePhone").value=t.phone||"",document.getElementById("venueWebsite").value=t.website||"",document.getElementById("venueNotes").value=t.notes||"",document.getElementById("venueDrivingTips").value=t.drivingTips||"",document.getElementById("venueVimeoId").value=t.vimeoId||"";const n=document.getElementById("trackMapPreview"),o=document.getElementById("trackMapImage");t.trackMapPath?(o.src="/.netlify/functions/get-photo?path=".concat(encodeURIComponent(t.trackMapPath)),n.style.display="block"):n.style.display="none";const a=document.getElementById("vimeoPreview"),i=a.querySelector("iframe");t.vimeoId&&/^\d+$/.test(t.vimeoId)?(i.src="https://player.vimeo.com/video/".concat(t.vimeoId),a.style.display="block"):(a.style.display="none",i.src=""),document.getElementById("venueModal").style.display="block"},window.deleteVenue=async function(e){const t=s.find(t=>t.id===e);if(t&&confirm('Are you sure you want to delete "'.concat(t.name,'"?')))try{const t=await fetch("/.netlify/functions/delete-venue",{method:"DELETE",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({venueId:e})}),n=await t.json();t.ok&&n.success?(l(n.message,"success","venuesMessageContainer"),m(),p()):u(n.error||"Failed to delete venue","venuesMessageContainer")}catch(n){console.error("Error deleting venue:",n),u("Failed to delete venue. Please try again.","venuesMessageContainer")}},window.filterVenues=function(){const e=document.getElementById("venueSearch").value.toLowerCase();if(!e.trim())return void g();g(s.filter(t=>t.name.toLowerCase().includes(e)||t.address.toLowerCase().includes(e)||t.notes&&t.notes.toLowerCase().includes(e)||t.drivingTips&&t.drivingTips.toLowerCase().includes(e)))},window.updateApplication=async function(e,t){try{if(!(await fetch("/.netlify/functions/update-application",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({applicationId:e,status:t,sendEmail:!0})})).ok)throw new Error("Failed to update application");l("Application ".concat(t," successfully! Email sent to applicant.")),h()}catch(n){console.error("Error updating application:",n),u("Failed to update application. Please try again.")}},window.deleteApplication=async function(e){const t=a.find(t=>t.id===e);if(!t)return;const n=t.fullName||"".concat(t.firstName||""," ").concat(t.lastName||"").trim()||"Unknown";if(confirm("Are you sure you want to permanently delete the application for ".concat(n,"?")))try{if(!(await fetch("/.netlify/functions/delete-application",{method:"DELETE",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({applicationId:e})})).ok)throw new Error("Failed to delete application");l("Application for ".concat(n," deleted successfully.")),h()}catch(i){console.error("Error deleting application:",i),u("Failed to delete application. Please try again.")}},window.showDetails=function(e){const t=a.find(t=>t.id===e);if(!t)return;document.getElementById("applicantId").value=t.id,document.getElementById("applicantFirstName").value=t.firstName||"",document.getElementById("applicantLastName").value=t.lastName||"",document.getElementById("applicantEmail").value=t.email||"",document.getElementById("applicantCompany").value=t.company||"",document.getElementById("applicantPosition").value=t.position||"",document.getElementById("applicantPhone").value=t.phone||"",document.getElementById("applicantLinkedin").value=t.linkedin||"",document.getElementById("applicantOriginalMessage").value=t.message||"",document.getElementById("applicantStatus").value=t.status||"pending",document.getElementById("applicantSubmitted").value=new Date(t.submittedAt).toLocaleString(),document.getElementById("applicantIsAdmin").checked=t.isAdmin||!1;const n=document.getElementById("applicantMessage");n&&(n.classList.add("hidden"),n.textContent=""),document.getElementById("applicantModal").style.display="block"},window.editEvent=function(e){const t=i.find(t=>t.id===e);if(!t)return void u("Event not found","eventsMessageContainer");if(document.getElementById("editEventId").value=t.id,document.getElementById("editEventName").value=t.name,document.getElementById("editEventDate").value=t.date,document.getElementById("editEventTime").value=t.time||"",document.getElementById("editEventMaxAttendees").value=t.maxAttendees||"",document.getElementById("editEventStatus").value=t.status||"upcoming",document.getElementById("editEventDescription").value=t.description||"",function(){const e=document.getElementById("editEventVenue");for(;e.children.length>1;)e.removeChild(e.lastChild);s.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})}(),t.venueId)document.getElementById("editEventVenue").value=t.venueId;else{const e=Array.from(document.getElementById("editEventVenue").options).find(e=>e.textContent===t.venue);e&&(document.getElementById("editEventVenue").value=e.value)}E(t.id),b(t.id),L(t.id),x(),async function(){try{const e=await $();document.getElementById("modalApprovedMemberCount").textContent=e}catch(e){console.error("Error loading member count for modal:",e),document.getElementById("modalApprovedMemberCount").textContent="Unknown"}}(),function(e){const t=document.getElementById("sendAnnouncementEmailBtn"),n=document.getElementById("sendReminderEmailBtn"),a=document.getElementById("modalSendTestEmailBtn"),s=t.cloneNode(!0),d=n.cloneNode(!0),c=a.cloneNode(!0);t.parentNode.replaceChild(s,t),n.parentNode.replaceChild(d,n),a.parentNode.replaceChild(c,a),s.addEventListener("click",async function(){await async function(e){const t=i.find(t=>t.id===e);if(!t)return void u("Event not found","eventModalMessageContainer");const n='Send announcement email to all approved members about "'.concat(t.name,'" on ').concat(new Date(t.date).toLocaleDateString(),"?");if(!confirm(n))return;const a=document.getElementById("sendAnnouncementEmailBtn"),s=a.textContent;a.textContent="Sending...",a.disabled=!0;try{const n=await fetch("/.netlify/functions/send-event-announcement",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:e,eventName:t.name,eventDate:t.date,eventTime:t.time,eventVenue:t.venue,eventDescription:t.description})});if(n.ok){const e=await n.json();l("Announcement sent successfully! ".concat(e.emailsSent," emails sent."),"success","eventModalMessageContainer")}else{const e=await n.json();u("Failed to send announcement: ".concat(e.error),"eventModalMessageContainer")}}catch(d){console.error("Error sending announcement:",d),u("An error occurred while sending the announcement","eventModalMessageContainer")}finally{a.textContent=s,a.disabled=!1}}(e)}),d.addEventListener("click",async function(){await async function(e){const t=i.find(t=>t.id===e);if(!t)return void u("Event not found","eventModalMessageContainer");const n='Send reminder email to all approved members about "'.concat(t.name,'" on ').concat(new Date(t.date).toLocaleDateString(),"?");if(!confirm(n))return;const a=document.getElementById("sendReminderEmailBtn"),s=a.textContent;a.textContent="Sending...",a.disabled=!0;try{const n=await fetch("/.netlify/functions/send-event-announcement",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:e,eventName:t.name,eventDate:t.date,eventTime:t.time,eventVenue:t.venue,eventDescription:t.description,isReminder:!0})});if(n.ok){const e=await n.json();l("Reminder sent successfully! ".concat(e.stats.sent," emails sent."),"success","eventModalMessageContainer")}else{const e=await n.json();u("Failed to send reminder: ".concat(e.error),"eventModalMessageContainer")}}catch(d){console.error("Error sending reminder:",d),u("An error occurred while sending the reminder","eventModalMessageContainer")}finally{a.textContent=s,a.disabled=!1}}(e)}),c.addEventListener("click",async function(){await async function(e){const t=i.find(t=>t.id===e);if(!t)return void u("Event not found","eventsMessageContainer");let n=null;try{const e=localStorage.getItem("kartel_admin_user");if(e){n=JSON.parse(e).email}}catch(r){console.error("Error getting stored user data:",r)}if(!n){if(n=prompt("Enter your email address for the test email:"),!n)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n))return void u("Please enter a valid email address","eventsMessageContainer")}const a=document.getElementById("testEmailType"),s=!!a&&"reminder"===a.value,d=document.getElementById("modalSendTestEmailBtn"),c=d.textContent;d.textContent="Sending...",d.disabled=!0;try{const a=await fetch("/.netlify/functions/send-test-email",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({eventId:e,adminEmail:n,eventData:t,isReminder:s})}),i=await a.json();if(a.ok&&i.success){l("Test ".concat(s?"reminder":"announcement"," email sent successfully to ").concat(n,"!"),"success","eventModalMessageContainer")}else u("Failed to send test email: ".concat(i.error),"eventModalMessageContainer")}catch(r){console.error("Error sending test email:",r),u("An error occurred while sending the test email","eventModalMessageContainer")}finally{d.textContent=c,d.disabled=!1}}(e)})}(t.id);const n=document.querySelector(".email-section");n&&(n.style.display="block"),document.getElementById("eventModal").style.display="block"},window.closeEventModal=C,window.deleteEvent=function(e){confirm("Are you sure you want to delete this event?")&&alert("Event deletion feature coming soon!")},window.loadEventPhotos=E,window.displayEventPhotos=I,window.loadEventVideos=b,window.displayEventVideos=B,window.addAttendeeToEvent=S,window.removeAttendeeFromEvent=async function(e,t){try{const n=i.findIndex(t=>t.id===e);if(-1===n)return;i[n].attendees=i[n].attendees.filter(e=>e.memberId!==t),await T(e,i[n].attendees),P(i[n].attendees),l("Attendee removed successfully!","success","eventsMessageContainer")}catch(n){console.error("Error removing attendee:",n),u("Failed to remove attendee. Please try again.","eventsMessageContainer")}},window.toggleAttendeeStatus=async function(e,t){try{const n=i.findIndex(t=>t.id===e);if(-1===n)return;const o=i[n].attendees.find(e=>e.memberId===t);if(!o)return;o.attended=!o.attended,o.statusUpdatedAt=(new Date).toISOString(),await T(e,i[n].attendees),P(i[n].attendees)}catch(n){console.error("Error updating attendee status:",n),u("Failed to update attendance status. Please try again.","eventsMessageContainer")}},window.loadEventAttendees=L,window.loadApprovedMembers=x;let N=[],j=[],D=[];async function V(){try{console.log("Loading gallery management...");try{const e=await fetch("/.netlify/functions/get-gallery",{headers:{Authorization:"Bearer ".concat(o)}});if(console.log("Get gallery response status:",e.status),e.ok){const t=await e.json();console.log("Gallery data received:",t),N=t.photos||[],_()}else{const t=await e.json().catch(()=>({error:"Unknown error"}));console.log("Gallery fetch error:",t),N=[]}}catch(e){console.error("Error fetching gallery:",e),N=[]}try{await async function(){try{console.log("Loading available photos from events...");const e=await fetch("/.netlify/functions/get-events",{headers:{Authorization:"Bearer ".concat(o)}});if(console.log("Get events response status:",e.status),!e.ok){const t=await e.json().catch(()=>({error:"Unknown error"}));throw console.error("Events fetch error:",t),new Error("Failed to fetch events: ".concat(t.error||e.status))}{const t=await e.json();console.log("Events data received:",t);const n=t.events||[];j=[],n.forEach(e=>{e.photos&&e.photos.length>0&&(console.log('Event "'.concat(e.name,'" has ').concat(e.photos.length," photos")),e.photos.forEach(t=>{j.push({...t,eventName:e.name,eventDate:e.date})}))}),console.log("Total photos collected: ".concat(j.length))}}catch(e){throw console.error("Error loading available photos:",e),e}}(),console.log("Available photos loaded, count:",j.length)}catch(t){console.error("Error loading available photos:",t),j=[]}q(),console.log("Gallery management loaded successfully")}catch(n){console.error("Error in loadGalleryManagement:",n),u("Failed to load gallery management: ".concat(n.message),"galleryMessageContainer")}}function q(){const e=document.getElementById("availablePhotosGrid"),t=document.getElementById("selectedPhotosGrid");console.log("Rendering gallery management. Available photos:",j.length,"Selected photos:",N.length),0===j.length?e.innerHTML='<p style="color: #7f8c8d; text-align: center; grid-column: 1 / -1;">No event photos available. Upload photos to events first.</p>':e.innerHTML=j.map(e=>{const t=e.url||e.src||"/.netlify/functions/get-photo?path=".concat(encodeURIComponent(e.path));return'\n            <div class="photo-item" style="position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); '.concat(N.find(t=>t.id===e.id)?"opacity: 0.5;":"",'" \n                 onclick="selectPhoto(\'').concat(e.id,'\')">\n                <img src="').concat(t,'" alt="').concat(e.caption||"Event photo",'" style="width: 100%; height: 120px; object-fit: cover;">\n                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; padding: 8px 6px 6px; font-size: 0.7rem;">\n                    <div style="font-weight: 600;">').concat(e.eventName,'</div>\n                    <div style="opacity: 0.8;">').concat(e.eventDate,"</div>\n                </div>\n                ").concat(N.find(t=>t.id===e.id)?'<div style="position: absolute; top: 5px; right: 5px; background: #27ae60; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">‚úì</div>':"","\n            </div>\n            ")}).join(""),0===N.length?t.innerHTML='<p style="color: #7f8c8d; text-align: center; grid-column: 1 / -1;">Click photos from the left to add them here</p>':t.innerHTML=N.map(e=>{const t=e.url||e.src||"/.netlify/functions/get-photo?path=".concat(encodeURIComponent(e.path));return'\n            <div class="photo-item" style="position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" \n                 onclick="deselectPhoto(\''.concat(e.id,'\')">\n                <img src="').concat(t,'" alt="').concat(e.caption||"Event photo",'" style="width: 100%; height: 100px; object-fit: cover;">\n                <div style="position: absolute; top: 2px; right: 2px; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer;">√ó</div>\n            </div>\n            ')}).join(""),document.getElementById("selectedCount").textContent=N.length}async function z(){try{const e=await fetch("/.netlify/functions/get-faqs",{headers:{Authorization:"Bearer ".concat(o)}});if(e.ok){const t=await e.json();D=t.faqs||[],document.getElementById("totalFaqs").textContent=D.length,function(){const e=document.getElementById("faqContainer");if(0===D.length)return void(e.innerHTML='\n            <div class="empty-state">\n                <h3>No FAQs found</h3>\n                <p>Start by adding your first FAQ to help visitors understand The Kartel better.</p>\n                <button class="btn btn-success" onclick="openAddFaqModal()">Add Your First FAQ</button>\n            </div>\n        ');e.innerHTML=D.map(e=>'\n        <div class="faq-item" style="background: white; border: 1px solid #ecf0f1; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">\n            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">\n                <h4 style="color: #2c3e50; font-weight: 600; margin: 0; flex: 1;">'.concat(e.question,'</h4>\n                <div style="display: flex; gap: 10px; margin-left: 15px;">\n                    <button class="btn btn-secondary btn-small" onclick="editFaq(\'').concat(e.id,'\')">Edit</button>\n                    <button class="btn btn-danger btn-small" onclick="deleteFaq(\'').concat(e.id,'\')">Delete</button>\n                </div>\n            </div>\n            <p style="color: #5d6d7e; margin: 0; line-height: 1.5;">').concat(e.answer,'</p>\n            <small style="color: #95a5a6; display: block; margin-top: 10px;">Order: ').concat(e.order||"Not set","</small>\n        </div>\n    ")).join("")}()}}catch(e){console.error("Error loading FAQs:",e),u("Failed to load FAQs. Please try again.","faqMessageContainer")}}function O(){document.getElementById("faqModal").style.display="none"}async function U(){try{const e=await fetch("/.netlify/functions/get-experience-video",{headers:{Authorization:"Bearer ".concat(o)}});if(e.ok){const t=(await e.json()).vimeoId||"1092055210";document.getElementById("experienceVimeoId").value=t,R(t),H(t)}}catch(e){console.error("Error loading experience video:",e),u("Failed to load experience video. Please try again.","videoMessageContainer")}}function R(e){const t=document.getElementById("experienceVideoPreview");e&&e.trim()?t.innerHTML='\n            <iframe src="https://player.vimeo.com/video/'.concat(e,'" \n                    width="100%" height="100%" frameborder="0" \n                    allow="autoplay; fullscreen; picture-in-picture" \n                    allowfullscreen></iframe>\n        '):t.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #7f8c8d;">No video selected</div>'}function _(){document.getElementById("totalGalleryPhotos").textContent=N.length}function H(e){document.getElementById("experienceVideoId").textContent=e||"-",document.getElementById("contentLastUpdated").textContent=(new Date).toLocaleDateString()}document.getElementById("faqForm").addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(e.target),n={id:t.get("faqId")||Date.now().toString(),question:t.get("faqQuestion"),answer:t.get("faqAnswer"),order:parseInt(t.get("faqOrder"))||D.length+1};try{if(!(await fetch("/.netlify/functions/update-faq",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify(n)})).ok)throw new Error("Failed to save FAQ");l("FAQ saved successfully!","success","faqMessageContainer"),O(),z()}catch(a){console.error("Error saving FAQ:",a),u("Failed to save FAQ. Please try again.","faqMessage")}}),document.getElementById("experienceVimeoId").addEventListener("input",e=>{R(e.target.value.trim())});let Q=null;function J(){document.getElementById("eventConfirmationModal").style.display="none",Q=null}async function $(){try{const e=await fetch("/.netlify/functions/get-applications",{headers:{Authorization:"Bearer ".concat(o)}});if(e.ok){const t=await e.json();return t.applications.filter(e=>"approved"===e.status).length}return 0}catch(e){return console.error("Error loading approved members:",e),0}}window.loadGalleryManagement=V,window.selectPhoto=function(e){if(N.length>=12)return void u("Maximum 12 photos allowed in gallery","galleryMessageContainer");const t=j.find(t=>t.id===e);t&&!N.find(t=>t.id===e)&&(N.push(t),q())},window.deselectPhoto=function(e){N=N.filter(t=>t.id!==e),q()},window.saveGallerySelection=async function(){try{console.log("Saving gallery selection:",N);const e=N.map(e=>({id:e.id,url:e.url||e.src||"/.netlify/functions/get-photo?path=".concat(encodeURIComponent(e.path)),alt:e.alt||e.caption||"Photo from ".concat(e.eventName),caption:e.caption||"Photo from ".concat(e.eventName),eventName:e.eventName,eventDate:e.eventDate,uploadedAt:e.uploadedAt}));console.log("Photos prepared for frontend:",e);const t=await fetch("/.netlify/functions/update-gallery",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({photos:e})});if(console.log("Response status:",t.status),!t.ok){const e=await t.json().catch(()=>({error:"Unknown error"}));throw console.error("Error response:",e),new Error(e.error||"Server error: ".concat(t.status))}{const e=await t.json();console.log("Success response:",e),l("Gallery updated successfully!","success","galleryMessageContainer"),_()}}catch(e){console.error("Error saving gallery:",e),u("Failed to save gallery: ".concat(e.message),"galleryMessageContainer")}},window.loadFaqs=z,window.openAddFaqModal=function(){document.getElementById("faqModalTitle").textContent="Add FAQ",document.getElementById("faqId").value="",document.getElementById("faqQuestion").value="",document.getElementById("faqAnswer").value="",document.getElementById("faqOrder").value="",document.getElementById("faqModal").style.display="block"},window.editFaq=function(e){const t=D.find(t=>t.id===e);t&&(document.getElementById("faqModalTitle").textContent="Edit FAQ",document.getElementById("faqId").value=t.id,document.getElementById("faqQuestion").value=t.question,document.getElementById("faqAnswer").value=t.answer,document.getElementById("faqOrder").value=t.order||"",document.getElementById("faqModal").style.display="block")},window.closeFaqModal=O,window.deleteFaq=async function(e){if(confirm("Are you sure you want to delete this FAQ?"))try{if(!(await fetch("/.netlify/functions/delete-faq",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({id:e})})).ok)throw new Error("Failed to delete FAQ");l("FAQ deleted successfully!","success","faqMessageContainer"),z()}catch(t){console.error("Error deleting FAQ:",t),u("Failed to delete FAQ. Please try again.","faqMessageContainer")}},window.seedFaqs=async function(){if(confirm("This will populate the CMS with the existing FAQs from the website. Continue?"))try{const e=await fetch("/.netlify/functions/seed-faqs",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!e.ok)throw new Error("Failed to seed FAQs");l((await e.json()).message,"success","faqMessageContainer"),z()}catch(e){console.error("Error seeding FAQs:",e),u("Failed to seed FAQs. Please try again.","faqMessageContainer")}},window.loadExperienceVideo=U,window.updateExperienceVideo=async function(){const e=document.getElementById("experienceVimeoId").value.trim();if(e)try{if(!(await fetch("/.netlify/functions/update-experience-video",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({vimeoId:e})})).ok)throw new Error("Failed to update experience video");l("Experience video updated successfully!","success","videoMessageContainer"),R(e),H(e)}catch(t){console.error("Error updating experience video:",t),u("Failed to update experience video. Please try again.","videoMessageContainer")}else u("Please enter a Vimeo video ID","videoMessageContainer")},window.closeApplicantModal=k,window.closeEventConfirmationModal=J,window.switchToMemberView=function(){const e=localStorage.getItem("kartel_admin_user");if(e)try{const t=JSON.parse(e);console.log("üë®‚Äçüíº Switching to member view for admin:",t.email),sessionStorage.setItem("switched_from_admin","true"),window.location.href="/members.html"}catch(t){console.error("Error parsing admin user data:",t),window.location.href="/members.html"}else window.location.href="/members.html"},window.showDashboard=function(){console.log("üè† showDashboard() called"),console.log("üè† Hiding login section, showing dashboard section"),document.getElementById("loginSection").classList.add("hidden"),document.getElementById("dashboardSection").classList.remove("hidden"),console.log("üè† Calling loadApplications() from showDashboard()"),h()},window.loadApplications=h,window.loadVenuesForDropdown=p,window.kartelAuth=new t,window.kartelTopBar=new n,window.NotificationManager=NotificationManager,console.log("üì¶ Admin bundle loaded");export{e as __vite_legacy_guard};
