<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Kartel - Admin Dashboard</title>
    <style>
        @font-face { font-family: 'League Spartan'; src: url('assets/League_Spartan/LeagueSpartan-VariableFont_wght.ttf') format('truetype'); font-weight: 100 900; font-style: normal; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'League Spartan', 'Arial', sans-serif; background: #f8f9fa; color: #2c3e50; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%); color: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; font-family: 'League Spartan', sans-serif; }
        .user-info { display: flex; align-items: center; gap: 15px; font-family: 'League Spartan', sans-serif; }
        .logout-btn { background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background 0.3s ease; font-family: 'League Spartan', sans-serif; }
        .logout-btn:hover { background: #2980b9; }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .dashboard-header { text-align: center; margin-bottom: 40px; }
        .dashboard-title { font-size: 2.5rem; color: #2c3e50; margin-bottom: 10px; font-weight: 800; font-family: 'League Spartan', sans-serif; }
        .dashboard-subtitle { color: #7f8c8d; font-size: 1.1rem; font-family: 'League Spartan', sans-serif; }
        .tab-navigation { display: flex; background: white; border-radius: 10px 10px 0 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 0; }
        .tab-button { flex: 1; padding: 20px; background: #f8f9fa; border: none; cursor: pointer; font-size: 1.1rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; border-bottom: 3px solid transparent; font-family: 'League Spartan', sans-serif; }
        .tab-button.active { background: white; color: #2c3e50; border-bottom-color: #3498db; }
        .tab-button:hover { background: #e9ecef; }
        .tab-button.active:hover { background: white; }
        .tab-content { display: none; background: white; border-radius: 0 0 10px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; border-left: 4px solid #3498db; }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: #3498db; margin-bottom: 5px; font-family: 'League Spartan', sans-serif; }
        .stat-label { color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-family: 'League Spartan', sans-serif; }
        .admin-actions { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-bottom: 30px; border: 1px solid #dee2e6; }
        .admin-actions h3 { color: #2c3e50; margin-bottom: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: 'League Spartan', sans-serif; }
        .import-section, .event-form { border: 2px dashed #bdc3c7; border-radius: 8px; padding: 20px; background: white; margin-bottom: 20px; }
        .file-input { display: none; }
        .file-label, .btn { background: #3498db; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; display: inline-block; margin-bottom: 15px; font-weight: 600; transition: background 0.3s ease; border: none; text-decoration: none; font-family: 'League Spartan', sans-serif; }
        .btn-success { background: #27ae60; } .btn-success:hover { background: #219a52; }
        .btn-danger { background: #e67e22; } .btn-danger:hover { background: #d35400; }
        .btn-secondary { background: #95a5a6; } .btn-secondary:hover { background: #7f8c8d; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-family: 'League Spartan', sans-serif; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 4px; font-size: 1rem; transition: border-color 0.3s ease; font-family: 'League Spartan', sans-serif; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3498db; }
        .applications-section, .events-section { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .section-header { background: #2c3e50; color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; }
        .section-title { font-size: 1.4rem; font-weight: 700; font-family: 'League Spartan', sans-serif; }
        .refresh-btn { background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background 0.3s ease; font-family: 'League Spartan', sans-serif; }
        .refresh-btn:hover { background: #2980b9; }
        .table-container { overflow-x: auto; max-height: 600px; }
        .applications-table, .events-table { width: 100%; border-collapse: collapse; }
        .applications-table th, .applications-table td, .events-table th, .events-table td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .applications-table th, .events-table th { background: #f8f9fa; font-weight: 700; color: #2c3e50; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; }
        .applications-table tbody tr:hover, .events-table tbody tr:hover { background: #f8f9fa; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-upcoming { background: #cce5ff; color: #0056b3; }
        .status-completed { background: #d4edda; color: #155724; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: 600; margin-right: 5px; margin-bottom: 5px; transition: all 0.3s ease; }
        .approve-btn { background: #27ae60; color: white; } .approve-btn:hover { background: #219a52; }
        .reject-btn { background: #e74c3c; color: white; } .reject-btn:hover { background: #c0392b; }
        .delete-btn { background: #dc3545; color: white; } .delete-btn:hover { background: #c82333; }
        .details-btn { background: #3498db; color: white; } .details-btn:hover { background: #2980b9; }
        .edit-btn { background: #f39c12; color: white; } .edit-btn:hover { background: #e67e22; }
        .quick-approve-btn { background: #f39c12; color: white; font-size: 0.9rem; padding: 8px 16px; } .quick-approve-btn:hover { background: #e67e22; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 20px 0; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 4px; margin: 20px 0; border: 1px solid #c3e6cb; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%); }
        .login-card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 100%; margin: 20px; }
        .login-title { font-size: 2rem; color: #2c3e50; margin-bottom: 20px; font-weight: 800; }
        .login-btn { background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.3s ease; width: 100%; }
        .login-btn:hover { background: #c0392b; } .login-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .hidden { display: none; }
        .application-details { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px; }
        .detail-row { display: flex; margin-bottom: 8px; }
        .detail-label { font-weight: 600; width: 100px; color: #2c3e50; }
        .detail-value { color: #5d6d7e; }
        .venues-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
        .venue-card { border: 1px solid #ecf0f1; border-radius: 8px; padding: 20px; transition: all 0.3s ease; background: #fff; }
        .venue-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border-color: #e74c3c; }
        .venue-name { font-size: 1.4rem; font-weight: 700; color: #2c3e50; margin-bottom: 10px; }
        .venue-details { margin-bottom: 15px; }
        .venue-detail { margin-bottom: 8px; color: #5d6d7e; }
        .venue-detail strong { color: #2c3e50; font-weight: 600; }
        .venue-actions { display: flex; gap: 10px; margin-top: 15px; }
        .search-container { margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px 20px; border: 2px solid #ecf0f1; border-radius: 25px; font-size: 1rem; background: white; }
        .search-input:focus { outline: none; border-color: #e74c3c; box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
        .empty-state { text-align: center; padding: 60px 20px; color: #7f8c8d; }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 15px; color: #5d6d7e; }
        .empty-state p { font-size: 1.1rem; margin-bottom: 25px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); }
        .modal-content { background-color: white; margin: 5% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); }
        .modal-header { background: #34495e; color: white; padding: 20px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.4rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .close { color: white; font-size: 24px; font-weight: bold; cursor: pointer; background: none; border: none; }
        .close:hover { color: #e74c3c; }
        .modal-body { padding: 30px; }
        .form-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .photo-upload-section { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-top: 20px; border: 2px dashed #bdc3c7;}
        .photo-upload-section h4 { color: #2c3e50; margin-bottom: 15px; font-weight: 700;}
        .photo-preview { max-width: 200px; max-height: 200px; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
        .photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .photo-item { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .photo-item img { width: 100%; height: 120px; object-fit: cover; }
        .photo-caption { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; padding: 10px 8px 8px; font-size: 0.8rem; }
        .attendee-management-section { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-top: 20px; border: 2px solid #e9ecef; }
        .attendee-management-section h4 { color: #2c3e50; margin-bottom: 15px; font-weight: 700; }
        .attendee-selector { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .attendee-selector select { flex: 1; padding: 10px; border: 2px solid #ecf0f1; border-radius: 4px; font-size: 1rem; }
        .attendee-selector button { padding: 10px 20px; white-space: nowrap; }
        .attendees-list { max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; background: white; }
        .attendee-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f1f1f1; transition: background-color 0.2s ease; }
        .attendee-item:hover { background-color: #f8f9fa; }
        .attendee-item:last-child { border-bottom: none; }
        .attendee-info { flex: 1; }
        .attendee-name { font-weight: 600; color: #2c3e50; margin-bottom: 2px; }
        .attendee-details { font-size: 0.9rem; color: #6c757d; }
        .attendee-status { display: flex; align-items: center; gap: 10px; }
        .status-toggle { position: relative; width: 50px; height: 24px; background: #ccc; border-radius: 12px; cursor: pointer; transition: background-color 0.3s ease; }
        .status-toggle.attended { background: #27ae60; }
        .status-toggle::before { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s ease; }
        .status-toggle.attended::before { transform: translateX(26px); }
        .remove-attendee { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.3s ease; }
        .remove-attendee:hover { background: #c0392b; }
        .attendee-stats { display: flex; gap: 20px; margin-bottom: 15px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 1.5rem; font-weight: 700; color: #2c3e50; }
        .stat-label { font-size: 0.8rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 15px; }
            .tab-navigation { flex-direction: column; }
            .tab-button { padding: 15px; font-size: 1rem; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .form-row { grid-template-columns: 1fr; }
            .action-btn { width: 100%; margin-bottom: 5px; }
            .venues-grid { grid-template-columns: 1fr; }
            .form-actions { flex-direction: column; align-items: stretch; }
            .venue-actions { flex-direction: column; }
            .modal-content { margin: 2% auto; width: 95%; }
            .modal-body { padding: 20px; }
            .attendee-selector { flex-direction: column; align-items: stretch; }
            .attendee-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .attendee-status { align-self: flex-end; }
        }
    </style>
</head>
<body>
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <h1 class="login-title">The Kartel Admin</h1>
            <p style="margin-bottom: 30px; color: #7f8c8d;">Admin access required</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" id="loginBtn" class="login-btn">Login</button>
            </form>
            <div id="loginError" class="error hidden"></div>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <header class="header">
            <div class="header-content">
                <div class="logo" style="display: flex; align-items: center; gap: 15px;">
                    <img src="assets/the-kartel-logo.png" alt="The Kartel Logo" style="height: 40px; width: auto;">
                    <span>The Kartel Admin</span>
                </div>
                <div class="user-info">
                    <span id="userEmail">Admin</span>
                    <button id="logoutBtn" class="logout-btn">Logout</button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Admin Dashboard</h1>
                <p class="dashboard-subtitle">Manage applications, events, venues, and content</p>
            </div>

            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('applications')">üë• Applications</button>
                <button class="tab-button" onclick="switchTab('events')">üìÖ Events</button>
                <button class="tab-button" onclick="switchTab('venues')">üèÅ Venues</button>
            </div>

            <div id="applicationsTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalApplications">0</div><div class="stat-label">Total Applications</div></div>
                    <div class="stat-card"><div class="stat-number" id="pendingApplications">0</div><div class="stat-label">Pending Review</div></div>
                    <div class="stat-card"><div class="stat-number" id="approvedApplications">0</div><div class="stat-label">Approved Members</div></div>
                    <div class="stat-card"><div class="stat-number" id="rejectedApplications">0</div><div class="stat-label">Rejected Applications</div></div>
                </div>
                <div class="applications-section">
                    <div class="section-header">
                        <h2 class="section-title">Membership Applications</h2>
                        <button id="refreshBtn" class="refresh-btn">Refresh</button>
                    </div>
                    <div id="messageContainer"></div>
                    <div class="table-container">
                        <table class="applications-table">
                            <thead>
                                <tr><th>Name</th><th>Email</th><th>Company & Position</th><th>Phone</th><th>Status</th><th>Submitted</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="applicationsTableBody">
                                <tr><td colspan="7" class="loading">Loading applications...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="eventsTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalEvents">0</div><div class="stat-label">Total Events</div></div>
                    <div class="stat-card"><div class="stat-number" id="upcomingEvents">0</div><div class="stat-label">Upcoming Events</div></div>
                    <div class="stat-card"><div class="stat-number" id="completedEvents">0</div><div class="stat-label">Completed Events</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalPhotos">0</div><div class="stat-label">Total Photos</div></div>
                </div>
                <div class="admin-actions">
                    <h3>üìÖ Create New Event</h3>
                    <div class="event-form">
                        <form id="eventForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="eventName">Event Name *</label>
                                    <input type="text" id="eventName" name="eventName" required placeholder="Monthly Karting Championship">
                                </div>
                                <div class="form-group">
                                    <label for="eventDate">Date *</label>
                                    <input type="date" id="eventDate" name="eventDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventTime">Time</label>
                                    <input type="time" id="eventTime" name="eventTime">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="eventVenue">Venue *</label>
                                    <select id="eventVenue" name="eventVenue" required>
                                        <option value="">Select a venue...</option>
                                        <option value="add-new">+ Add New Venue</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="eventMaxAttendees">Max Attendees</label>
                                    <input type="number" id="eventMaxAttendees" name="eventMaxAttendees" placeholder="20" min="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="eventDescription">Description</label>
                                <textarea id="eventDescription" name="eventDescription" rows="3" placeholder="Monthly championship round..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">Create Event</button>
                        </form>
                    </div>
                </div>
                <div class="events-section">
                    <div class="section-header">
                        <h2 class="section-title">Events</h2>
                        <button id="refreshEventsBtn" class="refresh-btn">Refresh</button>
                    </div>
                    <div id="eventsMessageContainer"></div>
                    <div class="table-container">
                        <table class="events-table">
                            <thead>
                                <tr><th>Event</th><th>Date & Time</th><th>Venue</th><th>Attendees</th><th>Photos</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                <tr><td colspan="7" class="loading">Loading events...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="venuesTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalVenues">0</div><div class="stat-label">Total Venues</div></div>
                    <div class="stat-card"><div class="stat-number" id="activeVenues">0</div><div class="stat-label">Active Venues</div></div>
                    <div class="stat-card"><div class="stat-number" id="venuesWithEvents">0</div><div class="stat-label">Venues with Events</div></div>
                    <div class="stat-card"><div class="stat-number" id="recentVenues">0</div><div class="stat-label">Added This Month</div></div>
                </div>
                <div class="applications-section">
                    <div class="section-header">
                        <h2 class="section-title">Venues</h2>
                        <div>
                            <button id="seedVenuesBtn" class="btn btn-secondary btn-small" style="margin-right: 10px;">Seed Default Venues</button>
                            <button class="btn btn-success" onclick="openAddVenueModal()">Add New Venue</button>
                            <button id="refreshVenuesBtn" class="refresh-btn">Refresh</button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="search-container">
                            <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()">
                        </div>
                        <div id="venuesMessageContainer"></div>
                        <div id="venuesContainer">
                            <div class="venues-grid" id="venuesGrid">
                                <div class="loading">Loading venues...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="venueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Venue</h3>
                <button class="close" onclick="closeVenueModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="venueForm">
                    <input type="hidden" id="venueId" name="venueId">
                    <div class="form-group">
                        <label for="venueName">Venue Name *</label>
                        <input type="text" id="venueName" name="venueName" required placeholder="e.g., TeamSport Victoria">
                    </div>
                    <div class="form-group">
                        <label for="venueAddress">Address *</label>
                        <textarea id="venueAddress" name="venueAddress" required placeholder="Full venue address including postcode"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="venuePhone">Phone Number</label>
                        <input type="tel" id="venuePhone" name="venuePhone" placeholder="Venue contact number">
                    </div>
                    <div class="form-group">
                        <label for="venueWebsite">Website</label>
                        <input type="url" id="venueWebsite" name="venueWebsite" placeholder="https://venue-website.com">
                    </div>
                    <div class="form-group">
                        <label for="venueNotes">Notes</label>
                        <textarea id="venueNotes" name="venueNotes" placeholder="Additional information about the venue..."></textarea>
                    </div>
                    
                    <!-- New Track Information Fields -->
                    <div class="form-group">
                        <label for="venueTrackMap">Track Map</label>
                        <input type="file" id="venueTrackMap" name="venueTrackMap" accept="image/*" class="file-input">
                        <label for="venueTrackMap" class="file-label">Choose Track Map Image</label>
                        <div id="trackMapPreview" style="display: none; margin-top: 10px;">
                            <img id="trackMapImage" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 2px solid #ecf0f1;">
                        </div>
                        <small style="color: #7f8c8d;">Upload a track layout image (PNG, JPG, GIF)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="venueDrivingTips">Driving Tips</label>
                        <textarea id="venueDrivingTips" name="venueDrivingTips" placeholder="Share driving tips for this track: turn techniques, overtaking spots, racing lines, etc." rows="4"></textarea>
                        <small style="color: #7f8c8d;">Tips to help members improve their lap times at this venue</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="venueVimeoId">Vimeo Video ID</label>
                        <input type="text" id="venueVimeoId" name="venueVimeoId" placeholder="1092055210">
                        <small style="color: #7f8c8d;">Enter just the video ID from Vimeo URL (e.g., for vimeo.com/1092055210, enter: 1092055210)</small>
                        <div id="vimeoPreview" style="display: none; margin-top: 10px;">
                            <iframe width="300" height="169" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Save Venue</button>
                        <button type="button" class="btn btn-secondary" onclick="closeVenueModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="eventModalTitle">Edit Event</h3>
                <button class="close" onclick="closeEventModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editEventForm">
                    <input type="hidden" id="editEventId" name="editEventId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEventName">Event Name *</label>
                            <input type="text" id="editEventName" name="editEventName" required placeholder="Monthly Karting Championship">
                        </div>
                        <div class="form-group">
                            <label for="editEventDate">Date *</label>
                            <input type="date" id="editEventDate" name="editEventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editEventTime">Time</label>
                            <input type="time" id="editEventTime" name="editEventTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEventVenue">Venue *</label>
                            <select id="editEventVenue" name="editEventVenue" required>
                                <option value="">Select a venue...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editEventMaxAttendees">Max Attendees</label>
                            <input type="number" id="editEventMaxAttendees" name="editEventMaxAttendees" placeholder="20" min="1">
                        </div>
                        <div class="form-group">
                            <label for="editEventStatus">Status</label>
                            <select id="editEventStatus" name="editEventStatus">
                                <option value="upcoming">Upcoming</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editEventDescription">Description</label>
                        <textarea id="editEventDescription" name="editEventDescription" rows="3" placeholder="Monthly championship round..."></textarea>
                    </div>
                    <div class="photo-upload-section">
                        <h4>üì∏ Event Photos</h4>
    
                        <!-- Existing Photos Display -->
                        <div id="existingPhotos">
                            <div class="photos-grid" id="eventPhotosGrid">
                            <!-- Photos will be populated here -->
                            </div>
                        </div>
    
                        <!-- Photo Upload Form -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                            <div class="form-group">
                                <label for="photoUpload">Add New Photo</label>
                                <input type="file" id="photoUpload" accept="image/*" style="margin-bottom: 10px;">
                            </div>
                            <div class="form-group">
                                <label for="photoCaption">Photo Caption</label>
                                <input type="text" id="photoCaption" placeholder="Describe this photo...">
                            </div>
                            <img id="photoPreview" class="photo-preview" style="display: none;">
                            <br>
                            <button type="button" id="uploadPhotoBtn" class="btn btn-secondary" style="margin-top: 10px;" disabled>
                                Upload Photo
                            </button>
                        </div>
                    </div>
                    <div class="attendee-management-section">
                        <h4>üë• Event Attendees</h4>
                        
                        <!-- Attendee Stats -->
                        <div class="attendee-stats">
                            <div class="stat-item">
                                <div class="stat-number" id="registeredCount">0</div>
                                <div class="stat-label">Registered</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="attendedCount">0</div>
                                <div class="stat-label">Attended</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="noShowCount">0</div>
                                <div class="stat-label">No Show</div>
                            </div>
                        </div>
                        
                        <!-- Add Attendee -->
                        <div class="attendee-selector">
                            <select id="memberSelect">
                                <option value="">Select an approved member...</option>
                            </select>
                            <button type="button" id="addAttendeeBtn" class="btn btn-success" disabled>
                                Add Attendee
                            </button>
                        </div>
                        
                        <!-- Attendees List -->
                        <div class="attendees-list" id="attendeesList">
                            <!-- Attendees will be populated here -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Update Event</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEventModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('kartel_admin_token');
        let applications = [], events = [], venues = [], csvData = [];
        let currentTab = 'applications', editingVenueId = null;

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
            if (tabName === 'applications') loadApplications();
            else if (tabName === 'events') { loadEvents(); loadVenuesForDropdown(); }
            else if (tabName === 'venues') loadVenues();
        }

        function showMessage(message, type = 'success', container = 'messageContainer') {
            const messageContainer = document.getElementById(container);
            messageContainer.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => messageContainer.innerHTML = '', 5000);
        }

        function showError(message, container = 'messageContainer') { showMessage(message, 'error', container); }

        async function loadVenues() {
            try {
                const response = await fetch('/.netlify/functions/get-venues', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.status === 401) { authToken = null; localStorage.removeItem('kartel_admin_token'); showLogin(); return; }
                if (!response.ok) throw new Error('Failed to load venues');
                const data = await response.json();
                venues = data.venues || [];
                updateVenueStats();
                renderVenues();
            } catch (error) {
                console.error('Error loading venues:', error);
                showError('Failed to load venues. Please try again.', 'venuesMessageContainer');
            }
        }

        async function loadVenuesForDropdown() {
            try {
                const response = await fetch('/.netlify/functions/get-venues', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    venues = data.venues || [];
                    populateVenueDropdown();
                }
            } catch (error) { console.error('Error loading venues for dropdown:', error); }
        }

        function populateVenueDropdown() {
            const select = document.getElementById('eventVenue');
            while (select.children.length > 2) select.removeChild(select.lastChild);
            venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.id;
                option.textContent = venue.name;
                select.appendChild(option);
            });
        }

        function updateVenueStats() {
            const total = venues.length;
            const thisMonth = venues.filter(venue => {
                const venueDate = new Date(venue.createdAt);
                const now = new Date();
                return venueDate.getMonth() === now.getMonth() && venueDate.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('totalVenues').textContent = total;
            document.getElementById('activeVenues').textContent = total;
            document.getElementById('venuesWithEvents').textContent = 0;
            document.getElementById('recentVenues').textContent = thisMonth;
        }

        function renderVenues(filteredVenues = null) {
            const container = document.getElementById('venuesContainer');
            const venuesToRender = filteredVenues || venues;
            if (venuesToRender.length === 0) {
                container.innerHTML = `
                    <div class="search-container">
                        <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()">
                    </div>
                    <div class="empty-state">
                        <h3>No venues found</h3>
                        <p>Start by adding your first karting venue to manage events effectively.</p>
                        <button class="btn btn-success" onclick="openAddVenueModal()">Add Your First Venue</button>
                    </div>
                `;
                return;
            }
            const venuesHTML = venuesToRender.map(venue => `
                <div class="venue-card">
                    <div class="venue-name">${venue.name}</div>
                    <div class="venue-details">
                        <div class="venue-detail"><strong>Address:</strong> ${venue.address}</div>
                        ${venue.phone ? `<div class="venue-detail"><strong>Phone:</strong> ${venue.phone}</div>` : ''}
                        ${venue.website ? `<div class="venue-detail"><strong>Website:</strong> <a href="${venue.website}" target="_blank" style="color: #e74c3c;">Visit Site</a></div>` : ''}
                        ${venue.notes ? `<div class="venue-detail"><strong>Notes:</strong> ${venue.notes}</div>` : ''}
                        ${venue.drivingTips ? `<div class="venue-detail"><strong>Driving Tips:</strong> ${venue.drivingTips.substring(0, 100)}${venue.drivingTips.length > 100 ? '...' : ''}</div>` : ''}
                        ${venue.vimeoId ? `<div class="venue-detail"><strong>Video:</strong> <a href="https://vimeo.com/${venue.vimeoId}" target="_blank" style="color: #e74c3c;">Watch on Vimeo</a></div>` : ''}
                        ${venue.trackMapPath ? `<div class="venue-detail"><strong>Track Map:</strong> <span style="color: #27ae60;">‚úì Available</span></div>` : ''}
                        <div class="venue-detail"><strong>Added:</strong> ${new Date(venue.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="venue-actions">
                        <button class="action-btn edit-btn btn-small" onclick="editVenue('${venue.id}')">Edit</button>
                        <button class="action-btn delete-btn btn-small" onclick="deleteVenue('${venue.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `
                <div class="search-container">
                    <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()" value="${document.getElementById('venueSearch')?.value || ''}">
                </div>
                <div class="venues-grid">${venuesHTML}</div>
            `;
        }

        function filterVenues() {
            const searchTerm = document.getElementById('venueSearch').value.toLowerCase();
            if (!searchTerm.trim()) { renderVenues(); return; }
            const filteredVenues = venues.filter(venue => 
                venue.name.toLowerCase().includes(searchTerm) ||
                venue.address.toLowerCase().includes(searchTerm) ||
                (venue.notes && venue.notes.toLowerCase().includes(searchTerm)) ||
                (venue.drivingTips && venue.drivingTips.toLowerCase().includes(searchTerm))
            );
            renderVenues(filteredVenues);
        }

        function openAddVenueModal() {
            editingVenueId = null;
            document.getElementById('modalTitle').textContent = 'Add New Venue';
            document.getElementById('venueForm').reset();
            
            // Clear preview elements
            document.getElementById('trackMapPreview').style.display = 'none';
            document.getElementById('vimeoPreview').style.display = 'none';
            document.getElementById('vimeoPreview').querySelector('iframe').src = '';
            
            document.getElementById('venueModal').style.display = 'block';
        }

        function editVenue(venueId) {
            const venue = venues.find(v => v.id === venueId);
            if (!venue) return;
            editingVenueId = venueId;
            document.getElementById('modalTitle').textContent = 'Edit Venue';
            document.getElementById('venueId').value = venue.id;
            document.getElementById('venueName').value = venue.name;
            document.getElementById('venueAddress').value = venue.address;
            document.getElementById('venuePhone').value = venue.phone || '';
            document.getElementById('venueWebsite').value = venue.website || '';
            document.getElementById('venueNotes').value = venue.notes || '';
            
            // New fields for track information
            document.getElementById('venueDrivingTips').value = venue.drivingTips || '';
            document.getElementById('venueVimeoId').value = venue.vimeoId || '';
            
            // Handle track map display if it exists
            const trackMapPreview = document.getElementById('trackMapPreview');
            const trackMapImage = document.getElementById('trackMapImage');
            if (venue.trackMapPath) {
                trackMapImage.src = `/.netlify/functions/get-photo?path=${encodeURIComponent(venue.trackMapPath)}`;
                trackMapPreview.style.display = 'block';
            } else {
                trackMapPreview.style.display = 'none';
            }
            
            // Handle Vimeo preview if ID exists
            const vimeoPreview = document.getElementById('vimeoPreview');
            const iframe = vimeoPreview.querySelector('iframe');
            if (venue.vimeoId && /^\d+$/.test(venue.vimeoId)) {
                iframe.src = `https://player.vimeo.com/video/${venue.vimeoId}`;
                vimeoPreview.style.display = 'block';
            } else {
                vimeoPreview.style.display = 'none';
                iframe.src = '';
            }
            
            document.getElementById('venueModal').style.display = 'block';
        }

        function closeVenueModal() {
            document.getElementById('venueModal').style.display = 'none';
            editingVenueId = null;
        }

        async function deleteVenue(venueId) {
            const venue = venues.find(v => v.id === venueId);
            if (!venue || !confirm(`Are you sure you want to delete "${venue.name}"?`)) return;
            try {
                const response = await fetch('/.netlify/functions/delete-venue', {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ venueId })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showMessage(result.message, 'success', 'venuesMessageContainer');
                    loadVenues();
                    loadVenuesForDropdown();
                } else {
                    showError(result.error || 'Failed to delete venue', 'venuesMessageContainer');
                }
            } catch (error) {
                console.error('Error deleting venue:', error);
                showError('Failed to delete venue. Please try again.', 'venuesMessageContainer');
            }
        }

        async function loadApplications() {
            try {
                const response = await fetch('/.netlify/functions/get-applications', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.status === 401) { authToken = null; localStorage.removeItem('kartel_admin_token'); showLogin(); return; }
                if (!response.ok) throw new Error('Failed to load applications');
                const data = await response.json();
                applications = data.applications || [];
                updateStats();
                renderApplicationsTable();
            } catch (error) {
                console.error('Error loading applications:', error);
                showError('Failed to load applications. Please try again.');
            }
        }

        async function loadEvents() {
            try {
                const response = await fetch('/.netlify/functions/get-events', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.status === 401) { authToken = null; localStorage.removeItem('kartel_admin_token'); showLogin(); return; }
                if (!response.ok) throw new Error('Failed to load events');
                const data = await response.json();
                events = data.events || [];
                updateEventStats();
                renderEventsTable();
            } catch (error) {
                console.error('Error loading events:', error);
                showError('Failed to load events. Please try again.', 'eventsMessageContainer');
            }
        }

        function updateStats() {
            const total = applications.length;
            const pending = applications.filter(app => app.status === 'pending').length;
            const approved = applications.filter(app => app.status === 'approved').length;
            const rejected = applications.filter(app => app.status === 'rejected').length;
            document.getElementById('totalApplications').textContent = total;
            document.getElementById('pendingApplications').textContent = pending;
            document.getElementById('approvedApplications').textContent = approved;
            document.getElementById('rejectedApplications').textContent = rejected;
        }

        function updateEventStats() {
            const total = events.length;
            const upcoming = events.filter(evt => evt.status === 'upcoming').length;
            const completed = events.filter(evt => evt.status === 'completed').length;
            const totalPhotos = events.reduce((sum, evt) => sum + (evt.photos ? evt.photos.length : 0), 0);
            document.getElementById('totalEvents').textContent = total;
            document.getElementById('upcomingEvents').textContent = upcoming;
            document.getElementById('completedEvents').textContent = completed;
            document.getElementById('totalPhotos').textContent = totalPhotos;
        }

        function renderApplicationsTable() {
            const tbody = document.getElementById('applicationsTableBody');
            if (applications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No applications found</td></tr>';
                return;
            }
            tbody.innerHTML = applications.map(app => `
                <tr>
                    <td>
                        <strong>${app.fullName || `${app.firstName || ''} ${app.lastName || ''}`.trim() || app.name || 'N/A'}</strong>
                        ${app.importedAt ? '<br><small style="color: #6c757d;">üì• Imported</small>' : ''}
                    </td>
                    <td>${app.email}</td>
                    <td>
                        <strong>${app.company || 'N/A'}</strong>
                        ${app.position ? `<br><small>${app.position}</small>` : ''}
                    </td>
                    <td>${app.phone}</td>
                    <td><span class="status-badge status-${app.status}">${app.status}</span></td>
                    <td>${new Date(app.submittedAt).toLocaleDateString()}</td>
                    <td>
                        ${app.status === 'pending' ? `
                            <button class="action-btn approve-btn" onclick="updateApplication('${app.id}', 'approved')">Approve</button>
                            <button class="action-btn reject-btn" onclick="updateApplication('${app.id}', 'rejected')">Reject</button>
                        ` : ''}
                        <button class="action-btn details-btn" onclick="showDetails('${app.id}')">Details</button>
                        <button class="action-btn delete-btn" onclick="deleteApplication('${app.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderEventsTable() {
            const tbody = document.getElementById('eventsTableBody');
            if (events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No events found</td></tr>';
                return;
            }
            tbody.innerHTML = events.map(evt => `
                <tr>
                    <td><strong>${evt.name}</strong></td>
                    <td>${new Date(evt.date).toLocaleDateString()}${evt.time ? `<br><small>${evt.time}</small>` : ''}</td>
                    <td><strong>${evt.venue}</strong></td>
                    <td>
                        <span class="status-badge status-approved">${evt.attendees ? evt.attendees.length : 0}</span>
                        ${evt.attendees && evt.attendees.length > 0 ? 
                            `<br><small>${evt.attendees.filter(a => a.attended).length} attended</small>` : 
                            ''
                        }
                    </td>
                    <td><span class="status-badge status-approved">${evt.photos ? evt.photos.length : 0}</span></td>
                    <td><span class="status-badge status-${evt.status}">${evt.status}</span></td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editEvent('${evt.id}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteEvent('${evt.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function editEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) {
                showError('Event not found', 'eventsMessageContainer');
                return;
            }
            
            // Populate the edit form (existing code)
            document.getElementById('editEventId').value = event.id;
            document.getElementById('editEventName').value = event.name;
            document.getElementById('editEventDate').value = event.date;
            document.getElementById('editEventTime').value = event.time || '';
            document.getElementById('editEventMaxAttendees').value = event.maxAttendees || '';
            document.getElementById('editEventStatus').value = event.status || 'upcoming';
            document.getElementById('editEventDescription').value = event.description || '';
            
            // Populate venue dropdown if venues are loaded
            populateEditEventVenueDropdown();
            
            // Set the venue if it exists
            if (event.venueId) {
                document.getElementById('editEventVenue').value = event.venueId;
            } else {
                // If no venueId, try to match by venue name
                const venueOption = Array.from(document.getElementById('editEventVenue').options)
                    .find(option => option.textContent === event.venue);
                if (venueOption) {
                    document.getElementById('editEventVenue').value = venueOption.value;
                }
            }
            
            // Load event photos
            loadEventPhotos(event.id);
            
            // Load attendees and approved members
            loadEventAttendees(event.id);
            loadApprovedMembers();
            
            // Show the modal
            document.getElementById('eventModal').style.display = 'block';
        }

        // Photo upload functionality
        document.getElementById('photoUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('photoPreview');
            const uploadBtn = document.getElementById('uploadPhotoBtn');
            
            if (file) {
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    uploadBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                uploadBtn.disabled = true;
            }
        });

        document.getElementById('uploadPhotoBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('photoUpload');
            const captionInput = document.getElementById('photoCaption');
            const eventId = document.getElementById('editEventId').value;
            
            if (!fileInput.files[0] || !eventId) {
                showError('Please select a photo and ensure an event is selected', 'eventsMessageContainer');
                return;
            }
            
            const file = fileInput.files[0];
            const caption = captionInput.value.trim();
            
            // Convert file to base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const photoData = e.target.result;
                
                const uploadBtn = document.getElementById('uploadPhotoBtn');
                const originalText = uploadBtn.textContent;
                uploadBtn.textContent = 'Uploading...';
                uploadBtn.disabled = true;
                
                try {
                    const response = await fetch('/.netlify/functions/upload-photo', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            eventId: eventId,
                            photoData: photoData,
                            fileName: file.name,
                            caption: caption
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        showMessage('Photo uploaded successfully!', 'success', 'eventsMessageContainer');
                        
                        // Clear the form
                        fileInput.value = '';
                        captionInput.value = '';
                        document.getElementById('photoPreview').style.display = 'none';
                        
                        // Refresh the photos display
                        await loadEventPhotos(eventId);
                        
                        // Refresh events list to show updated photo count
                        loadEvents();
                        
                    } else {
                        showError(result.error || 'Failed to upload photo', 'eventsMessageContainer');
                    }
                    
                } catch (error) {
                    console.error('Photo upload error:', error);
                    showError('Failed to upload photo. Please try again.', 'eventsMessageContainer');
                } finally {
                    uploadBtn.textContent = originalText;
                    uploadBtn.disabled = false;
                }
            };
            
            reader.readAsDataURL(file);
        });

        // Load and display event photos
        async function loadEventPhotos(eventId) {
            try {
                const response = await fetch('/.netlify/functions/get-events', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const event = data.events.find(e => e.id === eventId);
                    
                    if (event && event.photos) {
                        displayEventPhotos(event.photos);
                    } else {
                        displayEventPhotos([]);
                    }
                }
            } catch (error) {
                console.error('Error loading event photos:', error);
            }
        }

        function displayEventPhotos(photos) {
            const photosGrid = document.getElementById('eventPhotosGrid');
            
            if (!photos || photos.length === 0) {
                photosGrid.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No photos uploaded yet</p>';
                return;
            }
            
            const photosHTML = photos.map(photo => `
                <div class="photo-item">
                    <img src="/.netlify/functions/get-photo?path=${encodeURIComponent(photo.path)}" 
                        alt="${photo.caption || 'Event photo'}"
                        onerror="this.style.display='none'">
                    ${photo.caption ? `<div class="photo-caption">${photo.caption}</div>` : ''}
                </div>
            `).join('');
            
            photosGrid.innerHTML = photosHTML;
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        function populateEditEventVenueDropdown() {
            const select = document.getElementById('editEventVenue');
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Add venue options
            venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.id;
                option.textContent = venue.name;
                select.appendChild(option);
            });
        }

        async function updateApplication(applicationId, status) {
            try {
                const response = await fetch('/.netlify/functions/update-application', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ applicationId, status, sendEmail: true })
                });
                if (!response.ok) throw new Error('Failed to update application');
                showMessage(`Application ${status} successfully! Email sent to applicant.`);
                loadApplications();
            } catch (error) {
                console.error('Error updating application:', error);
                showError('Failed to update application. Please try again.');
            }
        }

        async function deleteApplication(applicationId) {
            const app = applications.find(a => a.id === applicationId);
            if (!app) return;
            const fullName = app.fullName || `${app.firstName || ''} ${app.lastName || ''}`.trim() || 'Unknown';
            if (!confirm(`Are you sure you want to permanently delete the application for ${fullName}?`)) return;
            try {
                const response = await fetch('/.netlify/functions/delete-application', {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ applicationId })
                });
                if (!response.ok) throw new Error('Failed to delete application');
                showMessage(`Application for ${fullName} deleted successfully.`);
                loadApplications();
            } catch (error) {
                console.error('Error deleting application:', error);
                showError('Failed to delete application. Please try again.');
            }
        }

        function showDetails(applicationId) {
            const app = applications.find(a => a.id === applicationId);
            if (!app) return;
            const fullName = app.fullName || `${app.firstName || ''} ${app.lastName || ''}`.trim() || 'N/A';
            alert(`Application Details:\n\nName: ${fullName}\nEmail: ${app.email}\nCompany: ${app.company || 'N/A'}\nPosition: ${app.position || 'N/A'}\nPhone: ${app.phone}\nMessage: ${app.message || 'N/A'}\nStatus: ${app.status}\nSubmitted: ${new Date(app.submittedAt).toLocaleString()}`);
        }

        function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) return;
            alert('Event deletion feature coming soon!');
        }

        function showLogin() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            loadApplications();
        }

        function checkAuth() {
            if (authToken) showDashboard();
            else showLogin();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'Logging in...';
                try {
                    const response = await fetch('/.netlify/functions/admin-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        authToken = result.token;
                        localStorage.setItem('kartel_admin_token', authToken);
                        showDashboard();
                    } else {
                        const errorDiv = document.getElementById('loginError');
                        errorDiv.textContent = result.error || 'Invalid credentials';
                        errorDiv.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    const errorDiv = document.getElementById('loginError');
                    errorDiv.textContent = 'Login failed. Please try again.';
                    errorDiv.classList.remove('hidden');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login';
                }
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                authToken = null;
                localStorage.removeItem('kartel_admin_token');
                showLogin();
            });

            // Refresh buttons
            document.getElementById('refreshBtn').addEventListener('click', loadApplications);
            document.getElementById('refreshEventsBtn').addEventListener('click', loadEvents);
            document.getElementById('refreshVenuesBtn').addEventListener('click', loadVenues);

            // Venue form submission
            document.getElementById('venueForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const venueData = {
                    name: formData.get('venueName').trim(),
                    address: formData.get('venueAddress').trim(),
                    phone: formData.get('venuePhone').trim(),
                    website: formData.get('venueWebsite').trim(),
                    notes: formData.get('venueNotes').trim(),
                    drivingTips: formData.get('venueDrivingTips').trim(),
                    vimeoId: formData.get('venueVimeoId').trim()
                };
                
                // Handle track map upload
                const trackMapFile = formData.get('venueTrackMap');
                if (trackMapFile && trackMapFile.size > 0) {
                    const reader = new FileReader();
                    const trackMapData = await new Promise((resolve, reject) => {
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(trackMapFile);
                    });
                    venueData.trackMap = {
                        data: trackMapData,
                        fileName: trackMapFile.name,
                        fileType: trackMapFile.type
                    };
                }
                if (!venueData.name || !venueData.address) {
                    showError('Please fill in all required fields', 'venuesMessageContainer');
                    return;
                }
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;
                try {
                    let response;
                    if (editingVenueId) {
                        response = await fetch('/.netlify/functions/update-venue', {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ venueId: editingVenueId, ...venueData })
                        });
                    } else {
                        response = await fetch('/.netlify/functions/create-venue', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(venueData)
                        });
                    }
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showMessage(result.message, 'success', 'venuesMessageContainer');
                        closeVenueModal();
                        loadVenues();
                        loadVenuesForDropdown();
                    } else {
                        showError(result.error || 'Failed to save venue', 'venuesMessageContainer');
                    }
                } catch (error) {
                    console.error('Error saving venue:', error);
                    showError('Failed to save venue. Please try again.', 'venuesMessageContainer');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Track map preview functionality
            document.getElementById('venueTrackMap').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById('trackMapPreview');
                const image = document.getElementById('trackMapImage');
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        image.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });

            // Vimeo video preview functionality
            document.getElementById('venueVimeoId').addEventListener('input', function(e) {
                const vimeoId = e.target.value.trim();
                const preview = document.getElementById('vimeoPreview');
                const iframe = preview.querySelector('iframe');
                
                if (vimeoId && /^\d+$/.test(vimeoId)) {
                    iframe.src = `https://player.vimeo.com/video/${vimeoId}`;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                    iframe.src = '';
                }
            });

            // Seed venues button
            document.getElementById('seedVenuesBtn').addEventListener('click', async function() {
                if (!confirm('This will add default venues if none exist. Continue?')) return;
                const btn = this;
                const originalText = btn.textContent;
                btn.textContent = 'Seeding...';
                btn.disabled = true;
                try {
                    const response = await fetch('/.netlify/functions/seed-venues', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showMessage(result.message, 'success', 'venuesMessageContainer');
                        if (result.success) { loadVenues(); loadVenuesForDropdown(); }
                    } else {
                        showError(result.error || 'Failed to seed venues', 'venuesMessageContainer');
                    }
                } catch (error) {
                    console.error('Error seeding venues:', error);
                    showError('Failed to seed venues. Please try again.', 'venuesMessageContainer');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            // Event venue selection
            document.getElementById('eventVenue').addEventListener('change', function() {
                if (this.value === 'add-new') {
                    openAddVenueModal();
                    this.value = '';
                }
            });

            // Event form submission
            document.getElementById('eventForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const selectedVenueId = formData.get('eventVenue');
                if (!selectedVenueId) {
                    showError('Please select a venue', 'eventsMessageContainer');
                    return;
                }
                const selectedVenue = venues.find(v => v.id === selectedVenueId);
                const eventData = {
                    name: formData.get('eventName'),
                    date: formData.get('eventDate'),
                    time: formData.get('eventTime'),
                    venueId: selectedVenueId,
                    venue: selectedVenue ? selectedVenue.name : '',
                    venueAddress: selectedVenue ? selectedVenue.address : '',
                    maxAttendees: formData.get('eventMaxAttendees'),
                    description: formData.get('eventDescription')
                };
                try {
                    const response = await fetch('/.netlify/functions/create-event', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(eventData)
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showMessage('Event created successfully!', 'success', 'eventsMessageContainer');
                        document.getElementById('eventForm').reset();
                        loadEvents();
                    } else {
                        showError(result.error || 'Failed to create event', 'eventsMessageContainer');
                    }
                } catch (error) {
                    console.error('Event creation error:', error);
                    showError('Failed to create event. Please try again.', 'eventsMessageContainer');
                }
            });

            // Edit event form submission
            document.getElementById('editEventForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const eventId = formData.get('editEventId');
                const selectedVenueId = formData.get('editEventVenue');
                
                if (!selectedVenueId) {
                    showError('Please select a venue', 'eventsMessageContainer');
                    return;
                }
                
                const selectedVenue = venues.find(v => v.id === selectedVenueId);
                const updates = {
                    name: formData.get('editEventName'),
                    date: formData.get('editEventDate'),
                    time: formData.get('editEventTime'),
                    venueId: selectedVenueId,
                    venue: selectedVenue ? selectedVenue.name : '',
                    venueAddress: selectedVenue ? selectedVenue.address : '',
                    maxAttendees: formData.get('editEventMaxAttendees'),
                    status: formData.get('editEventStatus'),
                    description: formData.get('editEventDescription')
                };
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Updating...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/.netlify/functions/update-event', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ eventId, updates })
                    });
                    
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showMessage('Event updated successfully!', 'success', 'eventsMessageContainer');
                        closeEventModal();
                        loadEvents();
                    } else {
                        showError(result.error || 'Failed to update event', 'eventsMessageContainer');
                    }
                } catch (error) {
                    console.error('Event update error:', error);
                    showError('Failed to update event. Please try again.', 'eventsMessageContainer');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Modal close on outside click
            window.onclick = function(event) {
                const venueModal = document.getElementById('venueModal');
                const eventModal = document.getElementById('eventModal');
                if (event.target === venueModal) closeVenueModal();
                if (event.target === eventModal) closeEventModal();
            }

            checkAuth();
        });

        // Load approved members for attendee selection
        async function loadApprovedMembers() {
            try {
                const response = await fetch('/.netlify/functions/get-applications', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const approvedMembers = data.applications.filter(app => app.status === 'approved');
                    populateMemberSelect(approvedMembers);
                    return approvedMembers;
                }
            } catch (error) {
                console.error('Error loading approved members:', error);
            }
            return [];
        }

        function populateMemberSelect(members) {
            const select = document.getElementById('memberSelect');
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Add member options
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                const memberName = member.fullName || `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.name || 'Unknown';
                option.textContent = `${memberName} (${member.company || 'No company'})`;
                option.dataset.email = member.email;
                option.dataset.company = member.company || '';
                select.appendChild(option);
            });
        }

        // Enable/disable add attendee button based on selection
        document.getElementById('memberSelect').addEventListener('change', function() {
            const addBtn = document.getElementById('addAttendeeBtn');
            addBtn.disabled = !this.value;
        });

        // Add attendee to event
        document.getElementById('addAttendeeBtn').addEventListener('click', function() {
            const select = document.getElementById('memberSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) return;
            
            const eventId = document.getElementById('editEventId').value;
            const memberId = selectedOption.value;
            const memberName = selectedOption.textContent.split(' (')[0]; // Remove company part
            const memberEmail = selectedOption.dataset.email;
            const memberCompany = selectedOption.dataset.company;
            
            // Check if member is already added
            const event = events.find(e => e.id === eventId);
            const existingAttendee = event.attendees?.find(a => a.memberId === memberId);
            
            if (existingAttendee) {
                showError('This member is already added to the event', 'eventsMessageContainer');
                return;
            }
            
            // Add attendee to event
            addAttendeeToEvent(eventId, {
                memberId: memberId,
                name: memberName,
                email: memberEmail,
                company: memberCompany,
                registeredAt: new Date().toISOString(),
                attended: false
            });
            
            // Reset selection
            select.value = '';
            document.getElementById('addAttendeeBtn').disabled = true;
        });

        // Add attendee to event data and update display
        async function addAttendeeToEvent(eventId, attendee) {
            try {
                // Find the event in our local events array
                const eventIndex = events.findIndex(e => e.id === eventId);
                if (eventIndex === -1) return;
                
                // Initialize attendees array if it doesn't exist
                if (!events[eventIndex].attendees) {
                    events[eventIndex].attendees = [];
                }
                
                // Add the attendee
                events[eventIndex].attendees.push(attendee);
                
                // Update the event on the server
                await updateEventAttendees(eventId, events[eventIndex].attendees);
                
                // Refresh the attendees display
                displayEventAttendees(events[eventIndex].attendees);
                
                showMessage('Attendee added successfully!', 'success', 'eventsMessageContainer');
                
            } catch (error) {
                console.error('Error adding attendee:', error);
                showError('Failed to add attendee. Please try again.', 'eventsMessageContainer');
            }
        }

        // Remove attendee from event
        async function removeAttendeeFromEvent(eventId, memberId) {
            try {
                const eventIndex = events.findIndex(e => e.id === eventId);
                if (eventIndex === -1) return;
                
                // Remove the attendee
                events[eventIndex].attendees = events[eventIndex].attendees.filter(a => a.memberId !== memberId);
                
                // Update the event on the server
                await updateEventAttendees(eventId, events[eventIndex].attendees);
                
                // Refresh the attendees display
                displayEventAttendees(events[eventIndex].attendees);
                
                showMessage('Attendee removed successfully!', 'success', 'eventsMessageContainer');
                
            } catch (error) {
                console.error('Error removing attendee:', error);
                showError('Failed to remove attendee. Please try again.', 'eventsMessageContainer');
            }
        }

        // Toggle attendee attendance status
        async function toggleAttendeeStatus(eventId, memberId) {
            try {
                const eventIndex = events.findIndex(e => e.id === eventId);
                if (eventIndex === -1) return;
                
                const attendee = events[eventIndex].attendees.find(a => a.memberId === memberId);
                if (!attendee) return;
                
                // Toggle attendance status
                attendee.attended = !attendee.attended;
                attendee.statusUpdatedAt = new Date().toISOString();
                
                // Update the event on the server
                await updateEventAttendees(eventId, events[eventIndex].attendees);
                
                // Refresh the attendees display
                displayEventAttendees(events[eventIndex].attendees);
                
            } catch (error) {
                console.error('Error updating attendee status:', error);
                showError('Failed to update attendance status. Please try again.', 'eventsMessageContainer');
            }
        }

        // Update event attendees on server
        async function updateEventAttendees(eventId, attendees) {
            const response = await fetch('/.netlify/functions/update-event', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    eventId: eventId,
                    updates: {
                        attendees: attendees
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update event attendees');
            }
            
            return await response.json();
        }

        // Display event attendees
        function displayEventAttendees(attendees) {
            const attendeesList = document.getElementById('attendeesList');
            
            if (!attendees || attendees.length === 0) {
                attendeesList.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No attendees added yet</p>';
                updateAttendeeStats(0, 0, 0);
                return;
            }
            
            const attendedCount = attendees.filter(a => a.attended).length;
            const noShowCount = attendees.filter(a => !a.attended).length;
            
            updateAttendeeStats(attendees.length, attendedCount, noShowCount);
            
            const attendeesHTML = attendees.map(attendee => `
                <div class="attendee-item">
                    <div class="attendee-info">
                        <div class="attendee-name">${attendee.name}</div>
                        <div class="attendee-details">
                            ${attendee.company ? `${attendee.company} ‚Ä¢ ` : ''}${attendee.email}
                            <br><small>Registered: ${new Date(attendee.registeredAt).toLocaleDateString()}</small>
                        </div>
                    </div>
                    <div class="attendee-status">
                        <span style="font-size: 0.8rem; margin-right: 8px;">
                            ${attendee.attended ? 'Attended' : 'Registered'}
                        </span>
                        <div class="status-toggle ${attendee.attended ? 'attended' : ''}" 
                            onclick="toggleAttendeeStatus('${document.getElementById('editEventId').value}', '${attendee.memberId}')">
                        </div>
                        <button class="remove-attendee" 
                                onclick="removeAttendeeFromEvent('${document.getElementById('editEventId').value}', '${attendee.memberId}')">
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
            
            attendeesList.innerHTML = attendeesHTML;
        }

        // Update attendee statistics
        function updateAttendeeStats(registered, attended, noShow) {
            document.getElementById('registeredCount').textContent = registered;
            document.getElementById('attendedCount').textContent = attended;
            document.getElementById('noShowCount').textContent = noShow;
        }

        // Load event attendees when opening edit modal
        async function loadEventAttendees(eventId) {
            const event = events.find(e => e.id === eventId);
            if (event && event.attendees) {
                displayEventAttendees(event.attendees);
            } else {
                displayEventAttendees([]);
            }
        }

        // Global functions for onclick handlers
        window.switchTab = switchTab;
        window.openAddVenueModal = openAddVenueModal;
        window.closeVenueModal = closeVenueModal;
        window.editVenue = editVenue;
        window.deleteVenue = deleteVenue;
        window.filterVenues = filterVenues;
        window.updateApplication = updateApplication;
        window.deleteApplication = deleteApplication;
        window.showDetails = showDetails;
        window.editEvent = editEvent;
        window.closeEventModal = closeEventModal;
        window.deleteEvent = deleteEvent;
        window.loadEventPhotos = loadEventPhotos;
        window.displayEventPhotos = displayEventPhotos;
        window.addAttendeeToEvent = addAttendeeToEvent;
        window.removeAttendeeFromEvent = removeAttendeeFromEvent;
        window.toggleAttendeeStatus = toggleAttendeeStatus;
        window.loadEventAttendees = loadEventAttendees;
        window.loadApprovedMembers = loadApprovedMembers;

    </script>
</body>
</html>