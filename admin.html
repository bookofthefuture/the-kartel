<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Kartel - Admin Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    <!-- PWA Manifest and Meta Tags -->
    <link rel="manifest" href="/admin-manifest.json">
    <meta name="theme-color" content="#e74c3c">
    <meta name="background-color" content="#1a252f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Kartel Admin">
    <link rel="apple-touch-icon" href="/icons/admin-icon-192x192.svg">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/admin-icon-152x152.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/admin-icon-192x192.svg">
    
    <!-- Unified Modules -->
    <link rel="stylesheet" href="unified-styles.css">
    <link rel="stylesheet" href="admin.css">
    <!-- Bundled JavaScript for admin page -->
    <script nomodule src="/dist/polyfills-legacy.min.js"></script>
    <script nomodule src="/dist/js/admin-bundle-legacy.min.js"></script>
    <script type="module" src="/dist/js/admin-bundle.min.js"></script>
</head>
<body>
    <div id="loginSection" class="login-container">
        <div id="loginContainer">
            <!-- Login form will be rendered by auth module -->
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <header class="header">
            <!-- Header content will be rendered by topbar module -->
        </header>

        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Admin Dashboard</h1>
                <p class="dashboard-subtitle">Manage applications, events, venues, and content</p>
            </div>

            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('applications')">üë• Applications</button>
                <button class="tab-button" onclick="switchTab('events')">üìÖ Events</button>
                <button class="tab-button" onclick="switchTab('venues')">üèÅ Venues</button>
                <button class="tab-button" onclick="switchTab('content')">üìù Content</button>
            </div>

            <div id="applicationsTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalApplications">0</div><div class="stat-label">Total Applications</div></div>
                    <div class="stat-card"><div class="stat-number" id="pendingApplications">0</div><div class="stat-label">Pending Review</div></div>
                    <div class="stat-card"><div class="stat-number" id="approvedApplications">0</div><div class="stat-label">Approved Members</div></div>
                    <div class="stat-card"><div class="stat-number" id="rejectedApplications">0</div><div class="stat-label">Rejected Applications</div></div>
                </div>
                <div class="applications-section">
                    <div class="section-header">
                        <h2 class="section-title">Membership Applications</h2>
                        <div style="display: flex; gap: 10px;">
                            <button id="refreshBtn" class="refresh-btn">Refresh</button>
                            <button id="recoverBtn" class="recover-btn" style="background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">üîß Recover Data</button>
                        </div>
                    </div>
                    <div id="messageContainer"></div>
                    <div class="table-container">
                        <table class="applications-table">
                            <thead>
                                <tr><th>Name</th><th>Email</th><th>Company & Position</th><th>Phone</th><th>LinkedIn</th><th>Status</th><th>Submitted</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="applicationsTableBody">
                                <tr><td colspan="8" class="loading">Loading applications...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="eventsTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalEvents">0</div><div class="stat-label">Total Events</div></div>
                    <div class="stat-card"><div class="stat-number" id="upcomingEvents">0</div><div class="stat-label">Upcoming Events</div></div>
                    <div class="stat-card"><div class="stat-number" id="completedEvents">0</div><div class="stat-label">Completed Events</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalPhotos">0</div><div class="stat-label">Total Photos</div></div>
                </div>
                <div class="admin-actions">
                    <h3>üìÖ Create New Event</h3>
                    <div class="event-form">
                        <form id="eventForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="eventName">Event Name *</label>
                                    <input type="text" id="eventName" name="eventName" required placeholder="Monthly Karting Championship">
                                </div>
                                <div class="form-group">
                                    <label for="eventDate">Date *</label>
                                    <input type="date" id="eventDate" name="eventDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventTime">Time</label>
                                    <input type="time" id="eventTime" name="eventTime">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="eventVenue">Venue *</label>
                                    <select id="eventVenue" name="eventVenue" required>
                                        <option value="">Select a venue...</option>
                                        <option value="add-new">+ Add New Venue</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="eventMaxAttendees">Max Attendees</label>
                                    <input type="number" id="eventMaxAttendees" name="eventMaxAttendees" placeholder="20" min="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="eventDescription">Description</label>
                                <textarea id="eventDescription" name="eventDescription" rows="3" placeholder="Monthly championship round..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="sendAnnouncement" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="sendAnnouncement" name="sendAnnouncement" style="margin: 0;">
                                    <span>Send Announcement Email to All Members</span>
                                </label>
                                <small style="color: #7f8c8d;">Notify all approved members about this new event</small>
                            </div>
                            <button type="submit" class="btn btn-success">Create Event</button>
                        </form>
                    </div>
                </div>
                <div class="events-section">
                    <div class="section-header">
                        <h2 class="section-title">Events</h2>
                        <button id="refreshEventsBtn" class="refresh-btn">Refresh</button>
                    </div>
                    <div id="eventsMessageContainer"></div>
                    <div class="table-container">
                        <table class="events-table">
                            <thead>
                                <tr><th>Event</th><th>Date & Time</th><th>Venue</th><th>Attendees</th><th>Photos</th><th>Videos</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                <tr><td colspan="8" class="loading">Loading events...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="venuesTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalVenues">0</div><div class="stat-label">Total Venues</div></div>
                    <div class="stat-card"><div class="stat-number" id="activeVenues">0</div><div class="stat-label">Active Venues</div></div>
                    <div class="stat-card"><div class="stat-number" id="venuesWithEvents">0</div><div class="stat-label">Venues with Events</div></div>
                    <div class="stat-card"><div class="stat-number" id="recentVenues">0</div><div class="stat-label">Added This Month</div></div>
                </div>
                <div class="applications-section">
                    <div class="section-header">
                        <h2 class="section-title">Venues</h2>
                        <div>
                            <button id="seedVenuesBtn" class="btn btn-secondary btn-small" style="margin-right: 10px;">Seed Default Venues</button>
                            <button class="btn btn-success" onclick="openAddVenueModal()">Add New Venue</button>
                            <button id="refreshVenuesBtn" class="refresh-btn">Refresh</button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="search-container">
                            <input type="text" class="search-input" id="venueSearch" placeholder="Search venues..." onkeyup="filterVenues()">
                        </div>
                        <div id="venuesMessageContainer"></div>
                        <div id="venuesContainer">
                            <div class="venues-grid" id="venuesGrid">
                                <div class="loading">Loading venues...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="contentTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalGalleryPhotos">0</div><div class="stat-label">Gallery Photos</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalFaqs">0</div><div class="stat-label">FAQ Items</div></div>
                    <div class="stat-card"><div class="stat-number" id="experienceVideoId">-</div><div class="stat-label">Experience Video</div></div>
                    <div class="stat-card"><div class="stat-number" id="contentLastUpdated">-</div><div class="stat-label">Last Updated</div></div>
                </div>

                <!-- Home Gallery Management -->
                <div class="applications-section" style="margin-bottom: 30px;">
                    <div class="section-header">
                        <h2 class="section-title">üñºÔ∏è Home Gallery</h2>
                        <button class="refresh-btn" onclick="loadGalleryManagement()">Refresh</button>
                    </div>
                    <div style="padding: 20px;">
                        <div id="galleryMessageContainer"></div>
                        <p style="color: #7f8c8d; margin-bottom: 20px;">Select up to 12 photos from all event photos to display on the homepage gallery. Drag and drop to reorder.</p>
                        
                        <div class="form-row" style="margin-bottom: 20px;">
                            <div style="flex: 2;">
                                <h4>Available Event Photos</h4>
                                <div id="availablePhotosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #ecf0f1; padding: 15px; border-radius: 8px;">
                                    <div class="loading">Loading event photos...</div>
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <h4>Selected Gallery Photos (<span id="selectedCount">0</span>/12)</h4>
                                <div id="selectedPhotosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; min-height: 200px; border: 2px dashed #bdc3c7; padding: 15px; border-radius: 8px; background: #f8f9fa;">
                                    <p style="color: #7f8c8d; text-align: center; grid-column: 1 / -1;">Click photos from the left to add them here</p>
                                </div>
                                <button id="saveGalleryBtn" class="btn btn-success" style="margin-top: 15px; width: 100%;" onclick="saveGallerySelection()">Save Gallery</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FAQ Management -->
                <div class="applications-section" style="margin-bottom: 30px;">
                    <div class="section-header">
                        <h2 class="section-title">‚ùì FAQ Management</h2>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="seedFaqs()" style="margin-right: 10px;">Seed FAQs</button>
                            <button class="btn btn-success" onclick="openAddFaqModal()">Add FAQ</button>
                            <button class="refresh-btn" onclick="loadFaqs()">Refresh</button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div id="faqMessageContainer"></div>
                        <div id="faqContainer">
                            <div class="loading">Loading FAQs...</div>
                        </div>
                    </div>
                </div>

                <!-- Experience Video Management -->
                <div class="applications-section">
                    <div class="section-header">
                        <h2 class="section-title">üé• Experience Video</h2>
                        <button class="refresh-btn" onclick="loadExperienceVideo()">Refresh</button>
                    </div>
                    <div style="padding: 20px;">
                        <div id="videoMessageContainer"></div>
                        <div class="form-row">
                            <div style="flex: 1;">
                                <div class="form-group">
                                    <label for="experienceVimeoId">Vimeo Video ID</label>
                                    <input type="text" id="experienceVimeoId" placeholder="e.g., 1092055210" style="font-family: monospace;">
                                    <small style="color: #7f8c8d;">Enter only the numeric ID from the Vimeo URL</small>
                                </div>
                                <button class="btn btn-success" onclick="updateExperienceVideo()">Update Video</button>
                            </div>
                            <div style="flex: 1;">
                                <h4>Video Preview</h4>
                                <div id="experienceVideoPreview" style="aspect-ratio: 16/9; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #7f8c8d;">
                                    No video selected
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="venueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Venue</h3>
                <button class="close" onclick="closeVenueModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="venueForm">
                    <input type="hidden" id="venueId" name="venueId">
                    <div class="form-group">
                        <label for="venueName">Venue Name *</label>
                        <input type="text" id="venueName" name="venueName" required placeholder="e.g., TeamSport Victoria">
                    </div>
                    <div class="form-group">
                        <label for="venueAddress">Address *</label>
                        <textarea id="venueAddress" name="venueAddress" required placeholder="Full venue address including postcode"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="venuePhone">Phone Number</label>
                        <input type="tel" id="venuePhone" name="venuePhone" placeholder="Venue contact number">
                    </div>
                    <div class="form-group">
                        <label for="venueWebsite">Website</label>
                        <input type="url" id="venueWebsite" name="venueWebsite" placeholder="https://venue-website.com">
                    </div>
                    <div class="form-group">
                        <label for="venueNotes">Notes</label>
                        <textarea id="venueNotes" name="venueNotes" placeholder="Additional information about the venue..."></textarea>
                    </div>
                    
                    <!-- New Track Information Fields -->
                    <div class="form-group">
                        <label for="venueTrackMap">Track Map</label>
                        <input type="file" id="venueTrackMap" name="venueTrackMap" accept="image/*" class="file-input">
                        <label for="venueTrackMap" class="file-label">Choose Track Map Image</label>
                        <div id="trackMapPreview" style="display: none; margin-top: 10px;">
                            <img id="trackMapImage" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 2px solid #ecf0f1;">
                        </div>
                        <small style="color: #7f8c8d;">Upload a track layout image (PNG, JPG, GIF)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="venueDrivingTips">Driving Tips</label>
                        <textarea id="venueDrivingTips" name="venueDrivingTips" placeholder="Share driving tips for this track: turn techniques, overtaking spots, racing lines, etc." rows="4"></textarea>
                        <small style="color: #7f8c8d;">Tips to help members improve their lap times at this venue</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="venueVimeoId">Vimeo Video ID</label>
                        <input type="text" id="venueVimeoId" name="venueVimeoId" placeholder="1092055210">
                        <small style="color: #7f8c8d;">Enter just the video ID from Vimeo URL (e.g., for vimeo.com/1092055210, enter: 1092055210)</small>
                        <div id="vimeoPreview" style="display: none; margin-top: 10px;">
                            <iframe width="300" height="169" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Save Venue</button>
                        <button type="button" class="btn btn-secondary" onclick="closeVenueModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="eventModalTitle">Edit Event</h3>
                <button class="close" onclick="closeEventModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="eventModalMessageContainer"></div>
                <form id="editEventForm">
                    <input type="hidden" id="editEventId" name="editEventId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEventName">Event Name *</label>
                            <input type="text" id="editEventName" name="editEventName" required placeholder="Monthly Karting Championship">
                        </div>
                        <div class="form-group">
                            <label for="editEventDate">Date *</label>
                            <input type="date" id="editEventDate" name="editEventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editEventTime">Time</label>
                            <input type="time" id="editEventTime" name="editEventTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEventVenue">Venue *</label>
                            <select id="editEventVenue" name="editEventVenue" required>
                                <option value="">Select a venue...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editEventMaxAttendees">Max Attendees</label>
                            <input type="number" id="editEventMaxAttendees" name="editEventMaxAttendees" placeholder="20" min="1">
                        </div>
                        <div class="form-group">
                            <label for="editEventStatus">Status</label>
                            <select id="editEventStatus" name="editEventStatus">
                                <option value="upcoming">Upcoming</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editEventDescription">Description</label>
                        <textarea id="editEventDescription" name="editEventDescription" rows="3" placeholder="Monthly championship round..."></textarea>
                    </div>
                    <div class="photo-upload-section">
                        <h4>üì∏ Event Photos</h4>
    
                        <!-- Existing Photos Display -->
                        <div id="existingPhotos">
                            <div class="photos-grid" id="eventPhotosGrid">
                            <!-- Photos will be populated here -->
                            </div>
                        </div>
    
                        <!-- Photo Upload Form -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                            <div class="form-group">
                                <label for="photoUpload">Add New Photo</label>
                                <input type="file" id="photoUpload" accept="image/*" style="margin-bottom: 10px;">
                            </div>
                            <div class="form-group">
                                <label for="photoCaption">Photo Caption</label>
                                <input type="text" id="photoCaption" placeholder="Describe this photo...">
                            </div>
                            <img id="photoPreview" class="photo-preview" style="display: none;">
                            <br>
                            <button type="button" id="uploadPhotoBtn" class="btn btn-secondary" style="margin-top: 10px;" disabled>
                                Upload Photo
                            </button>
                        </div>
                    </div>
                    <div class="video-upload-section" style="background: #f8f9fa; border-radius: 10px; padding: 25px; margin-top: 20px; border: 2px dashed #bdc3c7;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px; font-weight: 700;">üé• Event Videos</h4>
    
                        <!-- Existing Videos Display -->
                        <div id="existingVideos">
                            <div class="videos-grid" id="eventVideosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <!-- Videos will be populated here -->
                            </div>
                        </div>
    
                        <!-- Video Upload Form -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                            <div class="form-group">
                                <label for="videoUpload">Add New Video</label>
                                <input type="file" id="videoUpload" accept="video/*" style="margin-bottom: 10px;">
                                <small style="color: #7f8c8d; display: block;">Supported formats: MP4, MOV, AVI (max 500MB)</small>
                            </div>
                            <div class="form-group">
                                <label for="videoTitle">Video Title</label>
                                <input type="text" id="videoTitle" placeholder="Enter video title...">
                            </div>
                            <div class="form-group">
                                <label for="videoDescription">Video Description</label>
                                <textarea id="videoDescription" rows="3" placeholder="Describe this video..."></textarea>
                            </div>
                            <video id="videoPreview" style="display: none; max-width: 300px; max-height: 200px; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);" controls></video>
                            <br>
                            <button type="button" id="uploadVideoBtn" class="btn btn-secondary" style="margin-top: 10px;" disabled>
                                Upload to Vimeo
                            </button>
                            <div id="uploadProgress" style="display: none; margin-top: 10px;">
                                <div style="background: #f8f9fa; border-radius: 4px; padding: 8px;">
                                    <div style="color: #2c3e50; font-size: 0.9rem; margin-bottom: 5px;">Uploading...</div>
                                    <div style="background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden;">
                                        <div id="progressBar" style="background: #3498db; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="email-section" style="display: none;">
                        <h4>üìß Email Communications</h4>
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 15px 0;">
                            <p style="color: #7f8c8d; margin-bottom: 15px;">Send emails to all approved members about this event. Use "Announcement" for new events, "Reminder" for follow-up notifications.</p>
                            
                            <div class="member-count-info" style="background: white; border-radius: 6px; padding: 15px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Email Recipients:</div>
                                <div style="color: #7f8c8d; font-size: 1.1rem;">
                                    <span id="modalApprovedMemberCount">Loading...</span> approved members
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                                <button type="button" id="sendAnnouncementEmailBtn" class="btn btn-primary">
                                    üìß Send Announcement Email
                                </button>
                                <button type="button" id="sendReminderEmailBtn" class="btn btn-warning">
                                    üîî Send Reminder Email
                                </button>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <select id="testEmailType" style="padding: 5px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="announcement">Test Announcement</option>
                                        <option value="reminder">Test Reminder</option>
                                    </select>
                                    <button type="button" id="modalSendTestEmailBtn" class="btn btn-secondary">
                                        üß™ Send Test Email
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <small style="color: #7f8c8d;">
                                    Test email will be sent to your admin email address for preview.
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="attendee-management-section">
                        <h4>üë• Event Attendees</h4>
                        
                        <!-- Attendee Stats -->
                        <div class="attendee-stats">
                            <div class="stat-item">
                                <div class="stat-number" id="registeredCount">0</div>
                                <div class="stat-label">Registered</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="attendedCount">0</div>
                                <div class="stat-label">Attended</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="noShowCount">0</div>
                                <div class="stat-label">No Show</div>
                            </div>
                        </div>
                        
                        <!-- Add Attendee -->
                        <div class="attendee-selector">
                            <select id="memberSelect">
                                <option value="">Select an approved member...</option>
                            </select>
                            <button type="button" id="addAttendeeBtn" class="btn btn-success" disabled>
                                Add Attendee
                            </button>
                        </div>
                        
                        <!-- Attendees List -->
                        <div class="attendees-list" id="attendeesList">
                            <!-- Attendees will be populated here -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Update Event</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEventModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Applicant Details Modal -->
    <div id="applicantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Applicant Details</h3>
                <button class="close" onclick="closeApplicantModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="applicantForm">
                    <input type="hidden" id="applicantId" name="applicantId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="applicantFirstName">First Name *</label>
                            <input type="text" id="applicantFirstName" name="applicantFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="applicantLastName">Last Name *</label>
                            <input type="text" id="applicantLastName" name="applicantLastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="applicantEmail">Email Address *</label>
                        <input type="email" id="applicantEmail" name="applicantEmail" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="applicantCompany">Company</label>
                            <input type="text" id="applicantCompany" name="applicantCompany">
                        </div>
                        <div class="form-group">
                            <label for="applicantPosition">Position</label>
                            <input type="text" id="applicantPosition" name="applicantPosition">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="applicantPhone">Mobile Number</label>
                        <input type="tel" id="applicantPhone" name="applicantPhone">
                    </div>
                    <div class="form-group">
                        <label for="applicantLinkedin">LinkedIn Profile</label>
                        <input type="text" id="applicantLinkedin" name="applicantLinkedin" placeholder="LinkedIn username">
                        <small style="color: #7f8c8d;">Just the username - linkedin.com/in/ will be added automatically</small>
                    </div>
                    <div class="form-group">
                        <label for="applicantOriginalMessage">Original Message</label>
                        <textarea id="applicantOriginalMessage" name="applicantOriginalMessage" rows="3" readonly style="background: #f8f9fa; cursor: not-allowed;"></textarea>
                        <small style="color: #7f8c8d;">Original application message (read-only)</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="applicantStatus">Status</label>
                            <select id="applicantStatus" name="applicantStatus">
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="applicantSubmitted">Submitted</label>
                            <input type="text" id="applicantSubmitted" readonly style="background: #f8f9fa; cursor: not-allowed;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="applicantIsAdmin" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="applicantIsAdmin" name="applicantIsAdmin" style="margin: 0;">
                                <span>Administrator Access</span>
                            </label>
                            <small style="color: #7f8c8d;">Grant admin privileges to this user</small>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeApplicantModal()">Cancel</button>
                    </div>
                </form>
                <div id="applicantMessage" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- FAQ Modal -->
    <div id="faqModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="faqModalTitle">Add FAQ</h3>
                <button class="close" onclick="closeFaqModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="faqForm">
                    <input type="hidden" id="faqId" name="faqId">
                    <div class="form-group">
                        <label for="faqQuestion">Question *</label>
                        <input type="text" id="faqQuestion" name="faqQuestion" required placeholder="Enter the FAQ question...">
                    </div>
                    <div class="form-group">
                        <label for="faqAnswer">Answer *</label>
                        <textarea id="faqAnswer" name="faqAnswer" rows="4" required placeholder="Enter the FAQ answer..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="faqOrder">Display Order</label>
                        <input type="number" id="faqOrder" name="faqOrder" min="1" placeholder="Order (1 = first)">
                        <small style="color: #7f8c8d;">Leave blank to add at the end</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Save FAQ</button>
                        <button type="button" class="btn btn-secondary" onclick="closeFaqModal()">Cancel</button>
                    </div>
                </form>
                <div id="faqMessage" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Event Creation Confirmation Modal -->
    <div id="eventConfirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Event Creation</h3>
                <button class="close" onclick="closeEventConfirmationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-content">
                    <p style="color: #7f8c8d; margin-bottom: 25px;">Please review the event details before creating:</p>
                    
                    <div class="event-details-preview">
                        <div class="detail-row">
                            <span class="detail-label">Event Name:</span>
                            <span class="detail-value" id="confirmEventName"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Date:</span>
                            <span class="detail-value" id="confirmEventDate"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Time:</span>
                            <span class="detail-value" id="confirmEventTime"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Venue:</span>
                            <span class="detail-value" id="confirmEventVenue"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Max Attendees:</span>
                            <span class="detail-value" id="confirmEventMaxAttendees"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Description:</span>
                            <span class="detail-value" id="confirmEventDescription"></span>
                        </div>
                    </div>

                    <div id="announcementInfo" class="announcement-info" style="display: none;">
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0;">
                            <h4 style="color: #856404; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                üìß Email Announcement
                            </h4>
                            <p style="color: #856404; margin-bottom: 15px;">
                                An announcement email will be sent to all approved members.
                            </p>
                            <div style="background: white; border-radius: 6px; padding: 15px; border: 1px solid #f1c40f;">
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Recipients:</div>
                                <div style="color: #7f8c8d; font-size: 1.1rem;">
                                    <span id="approvedMemberCount">Loading...</span> approved members
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1c40f;">
                                <button type="button" id="sendTestEmailBtn" class="btn btn-secondary" style="font-size: 0.9rem; padding: 8px 16px;">
                                    üß™ Send Test Email
                                </button>
                                <small style="color: #856404; display: block; margin-top: 5px;">
                                    Send a test email to yourself to preview the announcement
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-success" id="confirmCreateEventBtn">
                        <span id="confirmButtonText">Confirm & Create Event</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEventConfirmationModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- admin.js is now bundled in the admin-bundle above -->
    
    <script>
        // Unified Authentication Integration for Admin
        window.onAuthSuccess = function(user, isAdmin) {
            console.log('üéâ Admin auth success:', user, isAdmin);
            
            // Verify admin access
            if (!isAdmin) {
                console.warn('‚ö†Ô∏è Non-admin user attempted to access admin dashboard');
                kartelAuth.logout();
                kartelAuth.showMessage('Admin access required', 'error');
                return;
            }
            
            // Set global variables for existing admin code
            authToken = kartelAuth.getToken();
            
            // Store admin user data for legacy functions (like test emails)
            localStorage.setItem('kartel_admin_user', JSON.stringify(user));
            console.log('‚úÖ Admin user data stored for legacy functions:', user);
            
            // Ensure top bar is rendered properly for admin
            console.log('üîß Setting up admin top bar...');
            if (window.kartelTopBar) {
                setTimeout(() => {
                    console.log('üéØ Rendering admin top bar');
                    
                    // Check multiple sources for super admin status
                    const authSuperAdmin = kartelAuth.isUserSuperAdmin();
                    const userSuperAdmin = user.isSuperAdmin;
                    const storedSuperAdmin = localStorage.getItem('kartel_is_super_admin') === 'true';
                    
                    console.log('üîç Super admin status check from admin:', {
                        authSuperAdmin,
                        userSuperAdmin, 
                        storedSuperAdmin,
                        userEmail: user.email,
                        authObject: kartelAuth
                    });
                    
                    // Set super admin if any source indicates it
                    if (authSuperAdmin || userSuperAdmin || storedSuperAdmin) {
                        user.isSuperAdmin = true;
                    }
                    
                    console.log('üîÑ Updating topbar from admin - final isSuperAdmin:', user.isSuperAdmin);
                    
                    window.kartelTopBar.render();
                    window.kartelTopBar.updateUser(user, isAdmin);
                    console.log('‚úÖ Admin top bar setup complete');
                }, 100);
            } else {
                console.error('‚ùå kartelTopBar not available');
            }
            
            // Initialize admin dashboard
            showDashboard();
            loadApplications();
            loadVenuesForDropdown(); // Load venues for event creation dropdown
        };

        // Override the admin login check to require admin access
        const originalRequireAuth = kartelAuth.requireAuth;
        kartelAuth.requireAuth = function(redirectTo = '/members.html') {
            if (!kartelAuth.isUserLoggedIn()) {
                window.location.href = redirectTo;
                return false;
            }
            // Additional check for admin access on admin pages
            if (window.location.pathname.includes('admin') && !kartelAuth.isUserAdmin()) {
                console.warn('‚ö†Ô∏è Non-admin user redirected from admin page');
                window.location.href = '/members.html';
                return false;
            }
            return true;
        };
        
        // Override existing functions to work with unified auth
        window.logout = function() {
            kartelAuth.logout();
        };
        
        window.switchToMemberView = function() {
            if (kartelAuth.isUserAdmin()) {
                window.location.href = '/members.html';
            }
        };
    </script>
    
    <script>
        // PWA Service Worker Registration for Admin
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Admin Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available, prompt user to refresh
                                    if (confirm('New admin version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Admin Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt for Admin
        let adminDeferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('Admin beforeinstallprompt event fired');
            e.preventDefault();
            adminDeferredPrompt = e;
            
            // Show install prompt after admin has been on the site for a few seconds
            setTimeout(() => {
                if (adminDeferredPrompt && !localStorage.getItem('kartel_admin_install_dismissed')) {
                    console.log('Showing admin install prompt');
                    showAdminInstallPrompt();
                }
            }, 8000); // Longer delay for admin to avoid interrupting work
        });

        function showAdminInstallPrompt() {
            const installPrompt = document.createElement('div');
            installPrompt.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #e74c3c; color: white;
                padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000; max-width: 320px; font-family: 'League Spartan', sans-serif;
            `;
            installPrompt.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: 600;">Install Admin Dashboard</div>
                <div style="margin-bottom: 15px; font-size: 0.9rem; opacity: 0.9;">
                    Get quick admin access with offline functionality and push notifications
                </div>
                <div>
                    <button onclick="installAdminApp()" style="background: #c0392b; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px; cursor: pointer; font-family: inherit;">Install</button>
                    <button onclick="dismissAdminInstall()" style="background: transparent; color: #ecf0f1; border: 1px solid #bdc3c7; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-family: inherit;">Later</button>
                </div>
            `;
            installPrompt.id = 'adminInstallPrompt';
            document.body.appendChild(installPrompt);
        }

        window.installAdminApp = function() {
            console.log('Admin install app clicked, deferredPrompt:', !!adminDeferredPrompt);
            if (adminDeferredPrompt) {
                adminDeferredPrompt.prompt();
                adminDeferredPrompt.userChoice.then((choiceResult) => {
                    console.log('Admin install prompt result:', choiceResult.outcome);
                    adminDeferredPrompt = null;
                });
            } else {
                console.warn('No admin deferred prompt available');
            }
            const prompt = document.getElementById('adminInstallPrompt');
            if (prompt) prompt.remove();
        };

        window.dismissAdminInstall = function() {
            localStorage.setItem('kartel_admin_install_dismissed', 'true');
            const prompt = document.getElementById('adminInstallPrompt');
            if (prompt) prompt.remove();
        };

        // Initialize notification manager for admin
        let adminNotificationManager;
        window.addEventListener('load', () => {
            adminNotificationManager = new NotificationManager('admin');
            window.notificationManager = adminNotificationManager; // Make available globally
        });
    </script>
</body>
</html>